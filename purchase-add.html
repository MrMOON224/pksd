<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Purchase Voucher - Compact Pro</title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Shared Styles -->
    <link rel="stylesheet" href="css/styles.css">

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Inherits from css/styles.css */
        :root {
            --bg-top: var(--bg-primary, #0f172a);
            --accent-indigo: var(--primary, #6366f1);
            --glass-panel: var(--bg-glass, rgba(255, 255, 255, 0.05));
            --text-primary: #f8fafc;
            /* Keep slightly brighter text for forms if desired, otherwise var(--text-primary) */
            --text-muted: var(--text-muted, #94a3b8);
            --success-green: var(--success, #10b981);
            --warning-alert: var(--error, #ef4444);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            overflow: hidden;
            padding: var(--space-md);
        }

        .glass-card {
            background: var(--bg-secondary);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: var(--shadow-lg);
        }

        .glass-input {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            font-size: 0.75rem;
            padding: 0.35rem 0.5rem;
            border-radius: var(--radius-sm);
            width: 100%;
            outline: none;
            transition: all 0.2s;
        }

        .glass-input:focus {
            border-color: var(--primary);
            background: rgba(0, 0, 0, 0.3);
        }

        .table-container {
            flex-grow: 1;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.05);
            background: rgba(0, 0, 0, 0.2);
            border-radius: var(--radius-md);
        }

        .table-header th {
            position: sticky;
            top: 0;
            background: var(--bg-secondary);
            z-index: 10;
            font-size: 0.65rem;
            padding: 0.5rem;
            color: var(--text-muted);
            text-transform: uppercase;
            border-bottom: 2px solid rgba(255, 255, 255, 0.05);
            text-align: left;
        }

        .no-spinner::-webkit-inner-spin-button,
        .no-spinner::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        ::-webkit-scrollbar {
            width: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
    </style>
</head>

<body class="text-[11px] h-screen flex flex-col">

    <div class="max-w-[1600px] mx-auto w-full flex flex-col h-full space-y-3">

        <!-- Top Toolbar -->
        <div class="flex justify-between items-center px-1">
            <div class="flex items-center gap-6">
                <div class="flex items-center gap-3">
                    <h1
                        class="text-lg font-bold bg-gradient-to-r from-white to-slate-400 bg-clip-text text-transparent">
                        Purchase Voucher</h1>
                    <span class="sync-badge" id="syncStatus"
                        style="font-size: 9px; padding: 2px 8px; border-radius: 12px; background: rgba(16, 185, 129, 0.1); color: #10b981; border: 1px solid rgba(16, 185, 129, 0.2);">
                        <i class="fas fa-circle text-[6px]"></i> Ready
                    </span>
                </div>
                <div class="flex items-center gap-3">
                    <div class="flex items-center gap-2">
                        <label class="font-bold text-[var(--text-muted)] uppercase text-[9px]">Load Voucher:</label>
                        <input type="text" id="voucherCodeInput" class="glass-input !w-40"
                            placeholder="PO-20260217-0001">
                        <button onclick="loadOrderByCode()"
                            class="bg-[var(--primary)] hover:opacity-90 px-4 py-1 rounded font-bold text-[9px] text-white">LOAD</button>
                    </div>
                    <button onclick="viewPendingOrders()"
                        class="bg-white/10 hover:bg-white/20 px-4 py-1 rounded font-bold text-[9px]">PENDING
                        ORDERS</button>
                    <a href="purchaseorder.html"
                        class="bg-white/5 hover:bg-white/10 px-4 py-1 rounded font-bold text-[9px] text-[var(--accent-indigo)] border border-[var(--accent-indigo)]/30 ml-2 no-underline flex items-center h-[26px]">
                        + CREATE ORDER
                    </a>
                </div>
                <div class="flex items-center gap-2">
                    <label class="font-bold text-[var(--text-muted)] uppercase text-[9px]">Date</label>
                    <input type="date" id="voucherDate" class="glass-input !w-32">
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="saveVoucher()" id="btnSave" class="btn btn-primary btn-sm px-6">
                    <i class="fas fa-save mr-2"></i>SAVE
                </button>
                <button onclick="window.location.reload()" class="btn btn-secondary btn-sm">
                    <i class="fas fa-sync-alt mr-2"></i>RESET
                </button>
            </div>
        </div>

        <!-- Header Metadata Block -->
        <div class="glass-card rounded-lg p-3 grid grid-cols-4 gap-4">
            <div class="space-y-1">
                <label class="text-[9px] font-bold uppercase text-[var(--text-muted)]">Voucher Code</label>
                <input type="text" id="referenceNo" class="glass-input" placeholder="PO-000001">
            </div>
            <div class="space-y-1 relative">
                <label class="text-[9px] font-bold uppercase text-[var(--text-muted)]">Supplier</label>
                <select id="supplierId" class="glass-input" onchange="focusFirstRow()">
                    <option value="">Select Supplier</option>
                </select>
            </div>
            <div class="space-y-1">
                <label class="text-[9px] font-bold uppercase text-[var(--text-muted)]">Store / Warehouse</label>
                <select id="warehouseId" class="glass-input">
                    <option value="">Select Store</option>
                </select>
            </div>
            <div class="space-y-1">
                <label class="text-[9px] font-bold uppercase text-[var(--text-muted)]">Payment Type</label>
                <select id="paymentType" class="glass-input">
                    <option value="Cash">Cash</option>
                    <option value="Credit">Credit</option>
                    <option value="Consignment">Consignment</option>
                </select>
            </div>
        </div>

        <!-- Additional Metadata (Collapsible or Grid) -->
        <div class="glass-card rounded-lg p-3 grid grid-cols-5 gap-3">
            <div class="space-y-1">
                <label class="text-[9px] font-bold uppercase text-[var(--text-muted)]">Shipping Method</label>
                <select id="shippingMethod" class="glass-input">
                    <option value="Standard">Standard</option>
                    <option value="Express">Express</option>
                    <option value="Air Freight">Air Freight</option>
                    <option value="Sea Freight">Sea Freight</option>
                </select>
            </div>
            <div class="space-y-1">
                <label class="text-[9px] font-bold uppercase text-[var(--text-muted)]">Priority</label>
                <select id="priority" class="glass-input">
                    <option value="Normal">Normal</option>
                    <option value="Urgent">Urgent</option>
                    <option value="Low">Low</option>
                </select>
            </div>
            <div class="space-y-1">
                <label class="text-[9px] font-bold uppercase text-[var(--text-muted)]">Agent Name</label>
                <input type="text" id="agentName" class="glass-input" placeholder="Purchasing Agent">
            </div>
            <div class="space-y-1">
                <label class="text-[9px] font-bold uppercase text-[var(--text-muted)]">Expected Delivery</label>
                <input type="date" id="expectedDelivery" class="glass-input">
            </div>
            <div class="space-y-1">
                <label class="text-[9px] font-bold uppercase text-[var(--text-muted)]">Instructions</label>
                <input type="text" id="orderInstructions" class="glass-input" placeholder="Delivery/Handling...">
            </div>
        </div>

        <!-- Main Table Area -->
        <div class="table-container">
            <table class="w-full border-collapse" id="itemsTable">
                <thead class="table-header">
                    <tr class="text-left">
                        <th class="w-8 text-center">No</th>
                        <th class="w-32">Item Code</th>
                        <th class="w-40">Barcode/Scanner</th>
                        <th>Description</th>
                        <th class="w-16 text-center">QTY</th>
                        <th class="w-20 text-center">Pcs/Box</th>
                        <th class="w-16 text-center">Unit</th>
                        <th class="w-24 text-right">Unit Cost</th>
                        <th class="w-16 text-right">Disc%</th>
                        <th class="w-24 text-right">Amount</th>
                        <th class="w-32">Remark</th>
                        <th class="w-24 text-center">Status</th>
                        <th class="w-8"></th>
                    </tr>
                </thead>
                <tbody id="tableBody" class="divide-y divide-white/5">
                    <!-- Rows injected here -->
                </tbody>
            </table>
        </div>

        <!-- Quick Add Row -->
        <div class="px-1 flex justify-between items-center">
            <button onclick="addRow(true)" class="btn btn-secondary btn-sm" style="font-size: 9px;">
                <i class="fas fa-plus mr-2"></i>ADD NEW ITEM
            </button>
            <div class="text-[var(--text-muted)] text-[9px] italic">
                <i class="fas fa-info-circle mr-1"></i> Tip: Use barcode scanner to quickly add items.
            </div>
        </div>

        <!-- Footer / Totals Section -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
            <!-- Footer Inputs -->
            <div class="glass-card rounded-lg p-3 grid grid-cols-2 gap-3 col-span-3">
                <div class="space-y-1">
                    <label class="text-[9px] font-bold uppercase text-[var(--text-muted)]">Order Tax (%)</label>
                    <input type="number" id="taxPercent" oninput="calculateTotals()" value="0"
                        class="glass-input no-spinner" placeholder="0">
                </div>
                <div class="space-y-1">
                    <label class="text-[9px] font-bold uppercase text-[var(--text-muted)]">Order Discount</label>
                    <input type="number" id="overallDiscount" oninput="calculateTotals()" value="0"
                        class="glass-input no-spinner" placeholder="0">
                </div>
                <div class="space-y-1">
                    <label class="text-[9px] font-bold uppercase text-[var(--text-muted)]">Shipping Cost</label>
                    <input type="number" id="shipping" oninput="calculateTotals()" value="0"
                        class="glass-input no-spinner" placeholder="0">
                </div>
                <div class="space-y-1 relative">
                    <label class="text-[9px] font-bold uppercase text-[var(--text-muted)] flex justify-between">
                        Paid Amount
                        <span id="remainBadge" class="text-[var(--warning-alert)] text-[9px] font-bold hidden">Rem:
                            0</span>
                    </label>
                    <input type="number" id="paidAmount" oninput="calculateTotals()" value="0"
                        class="glass-input text-[var(--success-green)] font-bold no-spinner" placeholder="0">
                </div>
                <!-- Long Remark Bar -->
                <div class="col-span-2 flex items-center gap-3">
                    <label class="text-[9px] font-bold uppercase text-[var(--text-muted)] whitespace-nowrap">Notes /
                        Remarks</label>
                    <input type="text" id="voucherNote"
                        class="glass-input !rounded-none border-x-0 border-t-0 border-b border-white/20 bg-transparent focus:bg-white/5"
                        placeholder="Enter general notes for this purchase order...">
                </div>
            </div>

            <!-- Summary Table -->
            <div class="glass-card rounded-lg p-3 space-y-2 overflow-hidden flex flex-col justify-center">
                <div class="flex justify-between items-center border-b border-white/5 pb-1">
                    <span class="text-[var(--text-muted)] uppercase font-bold text-[8px]">Items Subtotal</span>
                    <span id="displaySubTotal" class="font-bold">0</span>
                </div>
                <div class="flex justify-between items-center border-b border-white/5 pb-1">
                    <span class="text-[var(--text-muted)] uppercase font-bold text-[8px]">Order Tax</span>
                    <span id="displayTax" class="text-right">0</span>
                </div>
                <div class="flex justify-between items-center border-b border-white/5 pb-1">
                    <span class="text-[var(--warning-alert)] uppercase font-bold text-[8px]">Discount</span>
                    <span id="displayDiscount" class="text-right">-0</span>
                </div>
                <div class="flex justify-between items-center border-b border-white/5 pb-1">
                    <span class="text-[var(--text-muted)] uppercase font-bold text-[8px]">Shipping</span>
                    <span id="displayShipping" class="text-right">0</span>
                </div>
                <div class="mt-2 text-[var(--primary)] flex flex-col items-end">
                    <span class="uppercase font-black text-[9px] mb-1">Total Payable</span>
                    <div id="displayNet" class="text-2xl font-black leading-none">0</div>
                </div>
                <div class="pt-2 border-t border-white/10 flex justify-between items-center">
                    <span class="text-[var(--warning-alert)] uppercase font-bold text-[8px]">Due Balance</span>
                    <span id="remainAmount" class="font-bold text-[var(--warning-alert)]">0</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-client.js"></script>

    <script>
        let items = [];
        let suppliers = [];
        let warehouses = [];
        let productsMap = new Map(); // For quick lookup

        window.onload = () => {
            setTimeout(async () => {
                document.getElementById('voucherDate').valueAsDate = new Date();
                await initData();

                // NEW: Handle URL ID for editing
                const urlParams = new URLSearchParams(window.location.search);
                const editId = urlParams.get('id');
                if (editId) {
                    await loadPurchaseById(editId);
                } else {
                    addRow(false); // Start with one empty row
                    renderTable();
                    setTimeout(() => document.getElementById('supplierId').focus(), 100);
                }
            }, 150);
        };

        async function loadPurchaseById(id) {
            try {
                updateSyncStatus('Loading order...', 'warning');
                const { data: order, error } = await supabase
                    .from('purchases')
                    .select('*, purchase_items(*)')
                    .eq('id', id)
                    .single();

                if (error || !order) throw error || new Error('Order not found');

                // Populate form
                loadedOrderId = order.id;
                document.getElementById('voucherDate').value = order.date;
                document.getElementById('referenceNo').value = order.reference_no || '';
                document.getElementById('supplierId').value = order.supplier_id;
                document.getElementById('warehouseId').value = order.warehouse_id;
                document.getElementById('paymentType').value = order.payment_type || 'Cash';
                document.getElementById('taxPercent').value = order.order_tax_percentage || 0;
                document.getElementById('overallDiscount').value = order.discount_amount || 0;
                document.getElementById('shipping').value = order.shipping_amount || 0;
                document.getElementById('paidAmount').value = order.paid_amount || 0;
                document.getElementById('voucherNote').value = order.note || '';

                // Extra fields
                if (document.getElementById('shippingMethod')) document.getElementById('shippingMethod').value = order.shipping_method || 'Standard';
                if (document.getElementById('priority')) document.getElementById('priority').value = order.priority || 'Normal';
                if (document.getElementById('agentName')) document.getElementById('agentName').value = order.agent_name || '';
                if (document.getElementById('expectedDelivery')) document.getElementById('expectedDelivery').value = order.expected_delivery || '';
                if (document.getElementById('orderInstructions')) document.getElementById('orderInstructions').value = order.instructions || '';

                // Load items
                items = order.purchase_items.map(item => ({
                    product_id: item.product_id,
                    barcode: '', // Will be filled below
                    itemCode: '', // Will be filled below
                    description: '', // Will be filled below
                    qty: item.quantity,
                    pcsBox: item.pcs_box || '',
                    unit: item.unit || '',
                    cost: item.unit_cost,
                    discountPercentage: 0,
                    discountAmount: item.discount_amount || 0,
                    amount: item.subtotal,
                    remark: item.remark || '',
                    isPreview: false
                }));

                // Fetch product details for names/codes
                const prodIds = items.map(i => i.product_id);
                const { data: prods } = await supabase.from('products').select('id, name, item_code, barcodes').in('id', prodIds);

                const pMap = new Map(prods?.map(p => [p.id, p]));
                items.forEach(item => {
                    const p = pMap.get(item.product_id);
                    if (p) {
                        item.description = p.name;
                        item.itemCode = p.item_code;
                        item.barcode = p.barcodes?.[0] || '';
                    }
                });

                renderTable();
                calculateTotals();
                updateSyncStatus('Order Loaded', 'success');
            } catch (err) {
                console.error('Load error:', err);
                alert('Failed to load order for editing.');
                updateSyncStatus('Load Failed', 'error');
            }
        }

        async function initData() {
            try {
                updateSyncStatus('Syncing...', 'warning');

                // Fetch Suppliers
                const { data: supData } = await supabase.from('suppliers').select('id, name');
                suppliers = supData || [];
                const supSelect = document.getElementById('supplierId');
                suppliers.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s.id;
                    opt.textContent = s.name;
                    supSelect.appendChild(opt);
                });

                // Fetch Warehouses
                const { data: whData } = await supabase.from('warehouses').select('id, name');
                warehouses = whData || [];
                const whSelect = document.getElementById('warehouseId');
                warehouses.forEach(w => {
                    const opt = document.createElement('option');
                    opt.value = w.id;
                    opt.textContent = w.name;
                    whSelect.appendChild(opt);
                });

                // Fetch basic product info for lookup
                const { data: prodData } = await supabase.from('products').select('id, item_code, barcodes, name, cost, unit, pcs_per_box');
                prodData?.forEach(p => {
                    if (p.item_code) productsMap.set(p.item_code.toLowerCase(), p);
                    p.barcodes?.forEach(b => productsMap.set(b.toLowerCase(), p));
                });

                // Style for preview text
                const style = document.createElement('style');
                style.innerHTML = `
                    .preview-text {
                        color: rgba(255, 255, 255, 0.4) !important;
                        font-style: italic;
                    }
                `;
                document.head.appendChild(style);

                updateSyncStatus('Synced', 'success');
            } catch (err) {
                console.error("Init failed:", err);
                updateSyncStatus('Offline', 'error');
            }
        }

        function updateSyncStatus(text, type) {
            const el = document.getElementById('syncStatus');
            el.innerHTML = `<i class="fas fa-circle text-[6px]"></i> ${text}`;
            if (type === 'success') { el.style.color = '#10b981'; el.style.background = 'rgba(16, 185, 129, 0.1)'; }
            else if (type === 'warning') { el.style.color = '#f59e0b'; el.style.background = 'rgba(245, 158, 11, 0.1)'; }
            else { el.style.color = '#ef4444'; el.style.background = 'rgba(239, 68, 68, 0.1)'; }
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            items.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-white/[0.04] transition-colors relative";

                const isP = item.isPreview;
                const mutedClass = isP ? 'preview-text' : '';

                tr.innerHTML = `
                    <td class="p-2 text-center text-white/20 font-medium">${index + 1}</td>
                    <td class="p-1">
                        <input type="text" value="${item.itemCode || ''}" id="itemCode-${index}"
                            oninput="lookupProduct(${index}, 'itemCode', this.value)"
                            onkeydown="handleGridKey(${index}, event)"
                            class="glass-input !bg-transparent border-none text-center ${mutedClass}" placeholder="...">
                    </td>
                    <td class="p-1">
                        <input type="text" value="${item.barcode || ''}" id="barcode-${index}"
                            oninput="lookupProduct(${index}, 'barcode', this.value)"
                            onkeydown="handleGridKey(${index}, event)"
                            class="glass-input !bg-transparent border-none ${mutedClass}" placeholder="Scan...">
                    </td>
                    <td class="p-1">
                        <input type="text" value="${item.description || ''}" readonly
                            class="glass-input !bg-transparent border-none !text-muted text-left ${mutedClass}" placeholder="Product name...">
                    </td>
                    <td class="p-1">
                        <input type="number" value="${item.qty || 0}" id="qty-${index}"
                            oninput="updateItem(${index}, 'qty', this.value)"
                            onkeydown="handleQtyKey(${index}, event)"
                            class="glass-input !bg-transparent border-none text-center no-spinner font-bold ${isP ? 'opacity-50' : ''}"
                            ${isP ? 'readonly' : ''}>
                    </td>
                    <td class="p-1">
                        <input type="number" value="${item.pcsBox || 0}" id="pcsBox-${index}"
                            oninput="updateItem(${index}, 'pcsBox', this.value)"
                            class="glass-input !bg-transparent border-none text-center no-spinner ${mutedClass}">
                    </td>
                    <td class="p-1">
                        <input type="text" value="${item.unit || ''}" readonly
                            class="glass-input !bg-transparent border-none text-center !text-muted ${mutedClass}">
                    </td>
                    <td class="p-1">
                        <input type="number" value="${item.cost || 0}" id="cost-${index}"
                            oninput="updateItem(${index}, 'cost', this.value)"
                            class="glass-input !bg-transparent border-none text-right no-spinner ${mutedClass}">
                    </td>
                    <td class="p-1">
                        <input type="text" value="${item.discount || 0}"
                            oninput="updateItem(${index}, 'discount', this.value)"
                            class="glass-input !bg-transparent border-none text-right ${mutedClass}">
                    </td>
                    <td class="p-1 text-right font-bold pr-3 ${mutedClass}">${(item.amount || 0).toLocaleString()}</td>
                    <td class="p-1">
                        <input type="text" value="${item.remark || ''}"
                            oninput="updateItem(${index}, 'remark', this.value)"
                            class="glass-input !bg-transparent border-none ${mutedClass}" placeholder="...">
                    </td>
                    <td class="p-1 text-center">
                        <span class="status-pill ${item.product_id ? 'status-active' : (isP ? 'bg-blue-500/20 text-blue-400' : 'status-failed')}" style="font-size: 8px; padding: 1px 6px;">
                            ${item.product_id ? 'Resolved' : (isP ? 'Preview' : 'Empty')}
                        </span>
                    </td>
                    <td class="p-1 text-center">
                        <button onclick="removeRow(${index})" class="text-white/10 hover:text-red-500 transition">
                            <i class="fas fa-times"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            calculateTotals();
        }

        function focusFirstRow() {
            setTimeout(() => document.getElementById('barcode-0')?.focus(), 50);
        }

        function handleGridKey(index, e) {
            // Navigation
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                // Move focus to next row if exists
                if (index < items.length - 1) {
                    const nextInput = document.getElementById(`itemCode-${index + 1}`) || document.getElementById(`barcode-${index + 1}`);
                    if (nextInput) {
                        nextInput.focus();
                        if (nextInput.value) nextInput.select();
                    }
                } else if (!items[index].isPreview) {
                    // Only add row if current is NOT a preview
                    addRow(true);
                }
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                if (index > 0) {
                    const prevInput = document.getElementById(`itemCode-${index - 1}`) || document.getElementById(`barcode-${index - 1}`);
                    if (prevInput) {
                        prevInput.focus();
                        if (prevInput.value) prevInput.select();
                    }
                }
            } else if (e.key === 'Enter') {
                e.preventDefault();
                // Confirm preview if active
                if (items[index].isPreview) {
                    confirmPreview(index);
                } else {
                    // Move to QTY
                    document.getElementById(`qty-${index}`)?.focus();
                    document.getElementById(`qty-${index}`)?.select();
                }
            } else if (e.key === 'Escape') {
                // Clear preview
                if (items[index].isPreview) {
                    clearPreview(index);
                }
            }
        }

        function handleQtyKey(index, e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                // If it's the last row and resolved, focus next barcode or add row
                if (index === items.length - 1 && items[index].product_id) {
                    addRow(true);
                } else if (index < items.length - 1) {
                    const nextInput = document.getElementById(`barcode-${index + 1}`) || document.getElementById(`itemCode-${index + 1}`);
                    nextInput?.focus();
                }
            }
        }

        function lookupProduct(index, type, value) {
            // Start by updating the current field value in state
            items[index][type] = value;

            if (!value) {
                if (items[index].isPreview) clearPreview(index);
                return;
            }

            const p = productsMap.get(value.toLowerCase());

            if (p) {
                // FOUND: Show PREVIEW
                items[index].isPreview = true;
                items[index].tempProductId = p.id;

                // Populate other fields as preview (except the one being typed)
                if (type !== 'itemCode') items[index].itemCode = p.item_code;
                if (type !== 'barcode') items[index].barcode = p.barcodes?.[0] || value; // Prefer first barcode or keep entered

                items[index].description = p.name + " (Press Enter)";
                items[index].unit = p.unit;
                items[index].cost = p.cost;
                items[index].pcsBox = p.pcs_per_box;
                // Don't set QTY yet

                renderTable();

                // Restore focus to the input being typed
                setTimeout(() => {
                    const input = document.getElementById(`${type}-${index}`);
                    if (input) {
                        input.focus();
                        // input.selectionStart = input.selectionEnd = input.value.length; // Cursor at end
                    }
                }, 0);

            } else {
                // Not found - clear preview data but keep typed value
                if (items[index].isPreview) {
                    items[index].product_id = null;
                    items[index].description = '';
                    items[index].unit = '';
                    items[index].cost = 0;
                    items[index].pcsBox = '';
                    items[index].isPreview = false;
                    renderTable();
                    setTimeout(() => document.getElementById(`${type}-${index}`)?.focus(), 0);
                }
                items[index].product_id = null;
            }
        }

        function confirmPreview(index) {
            if (!items[index].isPreview) return;

            items[index].product_id = items[index].tempProductId;
            items[index].isPreview = false;
            items[index].tempProductId = null;
            items[index].qty = items[index].qty || 1; // Default to 1 on confirm

            // Clean up description (remove "Press Enter")
            const p = productsMap.get(items[index].itemCode.toLowerCase()) || productsMap.get(items[index].barcode.toLowerCase());
            if (p) items[index].description = p.name;

            renderTable();

            setTimeout(() => {
                const qtyInput = document.getElementById(`qty-${index}`);
                qtyInput?.focus();
                qtyInput?.select();
            }, 50);
        }

        function clearPreview(index) {
            items[index].isPreview = false;
            items[index].product_id = null;
            items[index].tempProductId = null;
            items[index].itemCode = '';
            items[index].barcode = '';
            items[index].description = '';
            items[index].unit = '';
            items[index].cost = 0;
            items[index].pcsBox = '';
            renderTable();
        }

        function updateItem(index, field, value) {
            if (field === 'qty') items[index].qty = Math.max(0, parseFloat(value) || 0);
            else if (field === 'cost') items[index].cost = Math.max(0, parseFloat(value) || 0);
            else if (field === 'discount') items[index].discount = value;
            else items[index][field] = value;

            const qty = items[index].qty || 0;
            const cost = items[index].cost || 0;
            const dStr = (items[index].discount || '0').toString();
            let discountAmount = 0;

            if (dStr.includes('%')) {
                discountAmount = (parseFloat(dStr) / 100) * (qty * cost);
            } else {
                discountAmount = parseFloat(dStr) || 0;
            }

            items[index].discountAmount = discountAmount;
            items[index].amount = Math.max(0, (qty * cost) - discountAmount);

            renderTable();
        }

        function addRow(shouldFocus = false) {
            const index = items.length;
            items.push({
                product_id: null,
                itemCode: '',
                barcode: '',
                description: '',
                qty: 0,
                unit: '',
                cost: 0,
                discount: '0',
                discountAmount: 0,
                amount: 0,
                pcsBox: '',
                remark: '',
                isPreview: false,
                tempProductId: null
            });
            renderTable();
            if (shouldFocus) {
                setTimeout(() => {
                    document.getElementById(`barcode-${index}`)?.focus();
                }, 50);
            }
        }

        function removeRow(index) {
            items.splice(index, 1);
            if (items.length === 0) addRow();
            renderTable();
        }

        function calculateTotals() {
            const sub = items.reduce((acc, i) => acc + (parseFloat(i.amount) || 0), 0);
            const taxP = parseFloat(document.getElementById('taxPercent').value) || 0;
            const disc = parseFloat(document.getElementById('overallDiscount').value) || 0;
            const ship = parseFloat(document.getElementById('shipping').value) || 0;
            const paid = parseFloat(document.getElementById('paidAmount').value) || 0;

            const taxA = (sub * taxP) / 100;
            const net = sub + taxA + ship - disc;

            document.getElementById('displaySubTotal').innerText = sub.toLocaleString();
            document.getElementById('displayTax').innerText = taxA.toLocaleString();
            document.getElementById('displayDiscount').innerText = '-' + disc.toLocaleString();
            document.getElementById('displayShipping').innerText = ship.toLocaleString();
            document.getElementById('displayNet').innerText = net.toLocaleString();

            const rem = net - paid;
            document.getElementById('remainAmount').innerText = rem.toLocaleString();

            const badge = document.getElementById('remainBadge');
            if (badge) {
                badge.innerText = `Rem: ${rem.toLocaleString()}`;
                if (paid > 0 || rem !== net) badge.classList.remove('hidden');
                else badge.classList.add('hidden');
            }
        }

        async function saveVoucher() {
            const btn = document.getElementById('btnSave');
            try {
                const supplier_id = document.getElementById('supplierId').value;
                const warehouse_id = document.getElementById('warehouseId').value;

                if (!supplier_id || !warehouse_id) {
                    alert("⚠️ Please select Supplier and Warehouse before saving.");
                    return;
                }

                const validItems = items.filter(i => i.product_id && i.qty > 0);
                if (validItems.length === 0) {
                    alert("⚠️ No valid items to save. Please add at least one item with quantity.");
                    return;
                }

                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>SYNCING...';
                updateSyncStatus('Processing...', 'warning');

                const sub = validItems.reduce((acc, i) => acc + i.amount, 0);
                const taxP = parseFloat(document.getElementById('taxPercent').value) || 0;
                const disc = parseFloat(document.getElementById('overallDiscount').value) || 0;
                const ship = parseFloat(document.getElementById('shipping').value) || 0;
                const paid = parseFloat(document.getElementById('paidAmount').value) || 0;
                const taxA = (sub * taxP) / 100;
                const net = sub + taxA + ship - disc;

                let purchaseId;
                let isUpdating = !!loadedOrderId;

                if (isUpdating) {
                    // UPDATE existing order (change from 'Ordered' to 'Received')
                    const { data: pData, error: pErr } = await supabase.from('purchases').update({
                        date: document.getElementById('voucherDate').value,
                        reference_no: document.getElementById('referenceNo').value || null,
                        supplier_id,
                        warehouse_id,
                        status: 'Received', // Change status from 'Ordered' to 'Received'
                        payment_status: paid >= net ? 'Paid' : (paid > 0 ? 'Partial' : 'Unpaid'),
                        payment_type: document.getElementById('paymentType').value,
                        total_qty: validItems.reduce((acc, i) => acc + i.qty, 0),
                        order_tax_percentage: taxP,
                        order_tax_amount: taxA,
                        discount_amount: disc,
                        shipping_amount: ship,
                        grand_total: net,
                        paid_amount: paid,
                        note: document.getElementById('voucherNote').value || null,
                        // Additional Metadata
                        shipping_method: document.getElementById('shippingMethod')?.value || 'Standard',
                        priority: document.getElementById('priority')?.value || 'Normal',
                        agent_name: document.getElementById('agentName')?.value || null,
                        expected_delivery: document.getElementById('expectedDelivery')?.value || null,
                        instructions: document.getElementById('orderInstructions')?.value || null
                    }).eq('id', loadedOrderId).select().single();

                    if (pErr) throw pErr;
                    purchaseId = pData.id;

                    // Delete old items
                    await supabase.from('purchase_items').delete().eq('purchase_id', purchaseId);

                } else {
                    // INSERT new purchase
                    const { data: pData, error: pErr } = await supabase.from('purchases').insert({
                        date: document.getElementById('voucherDate').value,
                        reference_no: document.getElementById('referenceNo').value || null,
                        supplier_id,
                        warehouse_id,
                        status: 'Received',
                        payment_status: paid >= net ? 'Paid' : (paid > 0 ? 'Partial' : 'Unpaid'),
                        payment_type: document.getElementById('paymentType').value,
                        total_qty: validItems.reduce((acc, i) => acc + i.qty, 0),
                        order_tax_percentage: taxP,
                        order_tax_amount: taxA,
                        discount_amount: disc,
                        shipping_amount: ship,
                        grand_total: net,
                        paid_amount: paid,
                        note: document.getElementById('voucherNote').value || null,
                        // Additional Metadata
                        shipping_method: document.getElementById('shippingMethod')?.value || 'Standard',
                        priority: document.getElementById('priority')?.value || 'Normal',
                        agent_name: document.getElementById('agentName')?.value || null,
                        expected_delivery: document.getElementById('expectedDelivery')?.value || null,
                        instructions: document.getElementById('orderInstructions')?.value || null
                    }).select().single();

                    if (pErr) throw pErr;
                    purchaseId = pData.id;
                }

                // 2. Insert Purchase Items & Update Stock
                for (const item of validItems) {
                    const { error: itemErr } = await supabase.from('purchase_items').insert({
                        purchase_id: purchaseId,
                        product_id: item.product_id,
                        quantity: item.qty,
                        unit_cost: item.cost,
                        discount_amount: item.discountAmount || 0,
                        subtotal: item.amount,
                        pcs_box: item.pcsBox,
                        remark: item.remark
                    });

                    if (itemErr) console.error("Item sync error:", itemErr);

                    // Update Stock
                    const { data: prod } = await supabase.from('products').select('stock').eq('id', item.product_id).single();
                    await supabase.from('products').update({ stock: (prod?.stock || 0) + item.qty }).eq('id', item.product_id);
                }

                updateSyncStatus('Sync Success', 'success');
                alert("✅ Purchase Voucher successfully synced to database!");
                window.location.reload();

            } catch (err) {
                console.error("Database Sync Failed:", err);
                alert("❌ Sync Error: " + (err.message || "Unknown error occurred. Check console."));
                updateSyncStatus('Sync Failed', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-save mr-2"></i>SAVE';
            }
        }

        // NEW: Load Order by Voucher Code
        let loadedOrderId = null; // Track if we're updating an existing order

        async function loadOrderByCode() {
            try {
                const voucherCode = document.getElementById('voucherCodeInput').value.trim();
                if (!voucherCode) {
                    alert('⚠️ Please enter a voucher code.');
                    return;
                }

                updateSyncStatus('Loading order...', 'warning');

                // Fetch order
                const { data: order, error } = await supabase
                    .from('purchases')
                    .select('*, purchase_items(*)')
                    .eq('voucher_code', voucherCode)
                    .single();

                if (error || !order) {
                    alert('❌ Order not found. Please check the voucher code.');
                    updateSyncStatus('Ready', 'success');
                    return;
                }

                if (order.status === 'Received') {
                    alert('⚠️ This order has already been received. Cannot load.');
                    updateSyncStatus('Ready', 'success');
                    return;
                }

                // Populate form fields
                document.getElementById('voucherDate').value = order.date;
                document.getElementById('referenceNo').value = order.reference_no || '';
                document.getElementById('supplierId').value = order.supplier_id;
                document.getElementById('warehouseId').value = order.warehouse_id;
                document.getElementById('taxPercent').value = order.order_tax_percentage || 0;
                document.getElementById('overallDiscount').value = order.discount_amount || 0;
                document.getElementById('shipping').value = order.shipping_amount || 0;
                document.getElementById('paidAmount').value = order.paid_amount || 0;
                document.getElementById('voucherNote').value = order.note || '';

                // Load metadata
                if (document.getElementById('shippingMethod')) document.getElementById('shippingMethod').value = order.shipping_method || 'Standard';
                if (document.getElementById('priority')) document.getElementById('priority').value = order.priority || 'Normal';
                if (document.getElementById('agentName')) document.getElementById('agentName').value = order.agent_name || '';
                if (document.getElementById('orderInstructions')) document.getElementById('orderInstructions').value = order.instructions || '';
                if (document.getElementById('expectedDelivery')) document.getElementById('expectedDelivery').value = order.expected_delivery || '';

                // Load items
                items = order.purchase_items.map(item => ({
                    product_id: item.product_id,
                    barcode: item.barcode,
                    itemCode: item.item_code || '', // Make sure to load item code if available
                    description: item.description,
                    qty: item.quantity, // Note: quantity in DB, qty in UI
                    unit: item.unit || '',
                    cost: item.unit_cost,
                    discountPercentage: item.discount_percentage || 0,
                    discount: item.discount_amount || 0, // Simplified for now
                    discountAmount: item.discount_amount || 0,
                    amount: item.subtotal,
                    pcsBox: item.pcs_box || '',
                    remark: item.remark || '',
                    isPreview: false
                }));

                renderTable();
                calculateTotals(); // Ensure footer and badge update
                loadedOrderId = order.id;

                // Show success banner
                document.body.insertAdjacentHTML('afterbegin', `
                    <div style="position:fixed;top:10px;left:50%;transform:translateX(-50%);background:#10b981;color:white;padding:12px 24px;border-radius:8px;z-index:10000;font-weight:700;box-shadow:0 4px 12px rgba(0,0,0,0.3);">
                        ✅ Order ${voucherCode} Loaded - Ready to Receive
                    </div>
                `);
                setTimeout(() => document.querySelector('[style*="position:fixed"]')?.remove(), 3000);

                updateSyncStatus('Order Loaded', 'success');

            } catch (err) {
                console.error('Load error:', err);
                alert('Failed to load order: ' + err.message);
                updateSyncStatus('Ready', 'success');
            }
        }

        async function viewPendingOrders() {
            try {
                const { data, error } = await supabase
                    .from('purchases')
                    .select('*, supplier:suppliers(name)')
                    .eq('status', 'Ordered')
                    .order('date', { ascending: false })
                    .limit(20);

                if (error) throw error;

                if (!data || data.length === 0) {
                    alert('No pending orders found.');
                    return;
                }

                // Create modal
                let html = '<div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:9999;display:flex;align-items:center;justify-content:center;" onclick="this.remove()">';
                html += '<div style="background:#1e293b;border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:20px;max-width:800px;width:90%;max-height:80vh;overflow-y:auto;" onclick="event.stopPropagation()">';
                html += '<h2 style="color:#6366f1;margin-bottom:15px;font-size:18px;font-weight:700;">📋 Pending Purchase Orders</h2>';
                html += '<table style="width:100%;border-collapse:collapse;">';
                html += '<thead><tr style="border-bottom:2px solid rgba(255,255,255,0.1);"><th style="text-align:left;padding:8px;color:#94a3b8;font-size:11px;">REF NO</th><th style="text-align:left;padding:8px;color:#94a3b8;font-size:11px;">DATE</th><th style="text-align:left;padding:8px;color:#94a3b8;font-size:11px;">SUPPLIER</th><th style="text-align:right;padding:8px;color:#94a3b8;font-size:11px;">TOTAL</th><th style="text-align:right;padding:8px;color:#f59e0b;font-size:11px;">REMAIN</th><th style="text-align:center;padding:8px;color:#94a3b8;font-size:11px;">ACTION</th></tr></thead>';
                html += '<tbody>';

                data.forEach(order => {
                    const remain = order.grand_total - (order.paid_amount || 0);
                    html += `<tr style="border-bottom:1px solid rgba(255,255,255,0.05);">`;
                    html += `<td style="padding:8px;color:#6366f1;font-weight:600;font-size:12px;">${order.reference_no}</td>`;
                    html += `<td style="padding:8px;color:#f1f5f9;font-size:12px;">${order.date}</td>`;
                    html += `<td style="padding:8px;color:#f1f5f9;font-size:12px;">${order.supplier?.name || 'N/A'}</td>`;
                    html += `<td style="padding:8px;color:#10b981;font-weight:600;text-align:right;font-size:12px;">${order.grand_total.toLocaleString()}</td>`;
                    html += `<td style="padding:8px;color:#f59e0b;font-weight:600;text-align:right;font-size:12px;">${remain.toLocaleString()}</td>`;
                    html += `<td style="padding:8px;text-align:center;"><button onclick="document.getElementById('voucherCodeInput').value='${order.reference_no}';loadOrderByCode();this.closest('[style*=fixed]').remove();" style="background:#6366f1;color:white;padding:4px 12px;border-radius:4px;font-size:10px;border:none;cursor:pointer;font-weight:700;">LOAD</button></td>`;
                    html += '</tr>';
                });

                html += '</tbody></table>';
                html += '<div style="margin-top:15px;text-align:right;"><button style="background:#6366f1;color:white;padding:8px 16px;border-radius:4px;font-weight:700;font-size:11px;border:none;cursor:pointer;" onclick="this.closest(\'div[style*=fixed]\').remove()">CLOSE</button></div>';
                html += '</div></div>';

                document.body.insertAdjacentHTML('beforeend', html);

            } catch (err) {
                console.error('Load orders error:', err);
                alert('Failed to load pending orders: ' + err.message);
            }
        }

    </script>
</body>

</html>