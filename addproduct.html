<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Product Manager - POS System</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Shared Styles (Assumed external, keeping variables) -->
    <link rel="stylesheet" href="css/styles.css">

    <style>
        /* Inherits from css/styles.css */

        /* ── Page Layout ── */
        body {
            background: var(--bg-primary);
            height: 100vh;
            padding: 12px;
            margin: 0;
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
        }

        .page-container {
            max-width: 1440px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
            height: 100%;
        }

        /* ── Toolbar ── */
        .toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--bg-secondary);
            padding: 12px 20px;
            border-radius: var(--radius-lg);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: var(--shadow-lg);
            flex-shrink: 0;
        }

        .toolbar-left h1 {
            font-size: 1.25rem;
            margin: 0;
            font-weight: 800;
            letter-spacing: -0.025em;
            background: linear-gradient(135deg, #fff 0%, #cbd5e1 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .sync-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
            font-size: 0.7rem;
            font-weight: 700;
            padding: 4px 10px;
            border-radius: 6px;
            text-transform: uppercase;
            border: 1px solid rgba(16, 185, 129, 0.2);
            margin-left: 12px;
        }

        .sync-badge i {
            font-size: 0.5rem;
        }

        .toolbar-actions {
            display: flex;
            gap: 8px;
        }

        /* ── Buttons Refinement ── */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.75rem;
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: white;
            border-color: rgba(255, 255, 255, 0.05);
        }

        .btn-secondary:hover {
            background: #475569;
        }

        .btn-success {
            background: var(--primary);
            color: white;
        }

        .btn-success:hover {
            background: #4f46e5;
            transform: translateY(-1px);
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        /* ── Editor Section ── */
        .editor-section {
            background: var(--bg-secondary);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: var(--radius-lg);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            flex-shrink: 0;
            zoom: 1.05;
            /* Zoom in slightly per user request */
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            background: rgba(15, 23, 42, 0.2);
        }

        .field-cell {
            padding: 8px 14px;
            display: flex;
            flex-direction: column;
            border-right: 1px solid rgba(255, 255, 255, 0.05);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            transition: background 0.2s;
        }

        .field-cell:hover {
            background: rgba(255, 255, 255, 0.01);
        }

        .field-cell.col-span-2 {
            grid-column: span 2;
        }

        .field-cell.no-bg {
            background: none;
            border-bottom: none;
        }

        .field-label {
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.075em;
            color: var(--text-muted);
            margin-bottom: 5px;
        }

        .field-input {
            width: 100%;
            background: rgba(15, 23, 42, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            color: var(--text-primary);
            font-size: 0.85rem;
            padding: 0 10px;
            outline: none;
            transition: all 0.2s;
            height: 30px;
            box-sizing: border-box;
        }

        .field-input:focus {
            background: rgba(15, 23, 42, 0.8);
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        .field-input[readonly] {
            opacity: 0.6;
            background: transparent;
            border: 1px dashed rgba(255, 255, 255, 0.1);
            cursor: default;
        }

        /* ── Barcode Tags Refinement ── */
        .barcode-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 5px;
        }

        .barcode-tag {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: rgba(99, 102, 241, 0.15);
            border: 1px solid rgba(99, 102, 241, 0.2);
            color: #c7d2fe;
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 500;
        }

        .barcode-tag .remove-tag {
            cursor: pointer;
            font-size: 0.8rem;
            color: rgba(199, 210, 254, 0.6);
        }

        .barcode-tag .remove-tag:hover {
            color: #f87171;
        }

        /* ── Data Grid ── */
        .grid-section {
            background: var(--bg-secondary);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: var(--radius-lg);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 0;
            box-shadow: var(--shadow-lg);
        }

        .table-container {
            overflow: auto;
            flex: 1;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        thead {
            position: sticky;
            top: 0;
            z-index: 10;
            background: #1e293b;
            /* Fallback */
            backdrop-filter: blur(10px);
        }

        th {
            text-align: left;
            padding: 14px 16px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            border-bottom: 2px solid rgba(255, 255, 255, 0.05);
            background: rgba(30, 41, 59, 0.8);
        }

        td {
            padding: 10px 16px;
            font-size: 0.85rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
            color: var(--text-secondary);
            transition: color 0.2s;
        }

        tbody tr {
            cursor: pointer;
        }

        tbody tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        tbody tr:hover td {
            color: white;
        }

        tbody tr.selected {
            background: rgba(99, 102, 241, 0.1);
        }

        tbody tr.selected td {
            color: #a5b4fc;
            font-weight: 500;
        }

        /* ── Loading/Toast ── */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .hidden {
            display: none !important;
        }

        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid rgba(99, 102, 241, 0.2);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s cubic-bezier(0.4, 0, 0.2, 1) infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .toast-container {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            padding: 12px 18px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            font-size: 0.85rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast-success {
            background: #059669;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .toast-error {
            background: #dc2626;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay hidden" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <div class="page-container">

        <!-- Toolbar -->
        <div class="toolbar">
            <div class="toolbar-left" style="display:flex; align-items:center;">
                <h1>Product Manager</h1>
                <span class="sync-badge" id="syncBadge"><i class="fas fa-circle"></i> Synced to Supabase</span>
            </div>
            <div class="toolbar-actions">
                <button class="btn btn-secondary" onclick="clearEditor()">
                    <i class="fas fa-eraser"></i> Clear
                </button>
                <button class="btn btn-danger hidden" id="btn-delete" onclick="deleteCurrentProduct()">
                    <i class="fas fa-trash"></i> Delete
                </button>
                <button class="btn btn-success" onclick="saveProduct()">
                    <i class="fas fa-save"></i> Save Product
                </button>
                <button class="btn btn-secondary" onclick="refreshProducts()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
        </div>

        <!-- Editor Section -->
        <div class="editor-section">
            <div class="form-grid">
                <!-- Line 1: Identity -->
                <div class="field-cell">
                    <label class="field-label">Item Code ++</label>
                    <div class="barcode-input-container">
                        <input type="text" id="edit-code-input" class="field-input" placeholder="Enter code...">
                        <div id="edit-code-tags" class="barcode-tags"></div>
                    </div>
                    <input type="hidden" id="edit-code">
                </div>
                <div class="field-cell">
                    <label class="field-label">Barcode ++</label>
                    <div class="barcode-input-container">
                        <input type="text" id="edit-barcode-input" class="field-input" placeholder="Scan barcode...">
                        <div id="edit-barcode-tags" class="barcode-tags"></div>
                    </div>
                </div>
                <div class="field-cell col-span-2">
                    <label class="field-label">Description</label>
                    <input type="text" id="edit-name" class="field-input" placeholder="Product Name">
                </div>

                <!-- Line 2: Classification + Stock -->
                <div class="field-cell">
                    <label class="field-label">Category</label>
                    <select id="edit-category" class="field-input"></select>
                </div>
                <div class="field-cell">
                    <label class="field-label">Sub-Category</label>
                    <select id="edit-subcategory" class="field-input"></select>
                </div>
                <div class="field-cell">
                    <label class="field-label">Brand</label>
                    <select id="edit-brand" class="field-input"></select>
                </div>
                <div class="field-cell">
                    <label class="field-label">Stock</label>
                    <input type="number" id="edit-stock" class="field-input" value="0">
                </div>

                <!-- Line 3: Pricing & Math -->
                <div class="field-cell">
                    <label class="field-label">Cost</label>
                    <input type="number" id="edit-cost" class="field-input" step="0.01" value="0">
                </div>
                <div class="field-cell">
                    <label class="field-label">Unit Price</label>
                    <input type="number" id="edit-price" class="field-input" step="0.01" value="0">
                </div>
                <div class="field-cell">
                    <label class="field-label">Box Price (Calc)</label>
                    <input type="number" id="edit-box-price" class="field-input" step="0.01" value="0">
                </div>
                <div class="field-cell">
                    <label class="field-label">Margin %</label>
                    <input type="text" id="edit-margin" class="field-input" readonly value="0.00%">
                </div>

                <!-- Line 4: Units & Conversion -->
                <div class="field-cell">
                    <label class="field-label">Sale Unit</label>
                    <select id="edit-unit" class="field-input"></select>
                </div>
                <div class="field-cell">
                    <label class="field-label">Purchase Unit</label>
                    <select id="edit-purchase-unit" class="field-input"></select>
                </div>
                <div class="field-cell">
                    <label class="field-label">Conversion (Pcs/Unit)</label>
                    <input type="number" id="edit-conversion" class="field-input" value="1">
                </div>
                <div class="field-cell no-bg"></div>

                <!-- Line 5: Logistics -->
                <div class="field-cell col-span-2">
                    <label class="field-label">Supplier</label>
                    <input type="text" id="edit-supplier" class="field-input" placeholder="Select Supplier">
                </div>
                <div class="field-cell col-span-2" style="border-right:none">
                    <label class="field-label">Shop</label>
                    <input type="text" id="edit-shop" class="field-input" placeholder="Select Shop">
                </div>
            </div>
        </div>

        <!-- Grid Section (Table) -->
        <div class="grid-section">
            <div class="table-container">
                <table id="productsTable">
                    <thead>
                        <tr>
                            <th style="width: 50px;">#</th>
                            <th>Item Code</th>
                            <th>Barcode</th>
                            <th>Description</th>
                            <th>Category</th>
                            <th>Brand</th>
                            <th>Cost</th>
                            <th>Price</th>
                            <th>Stock</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- Rows rendered here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Init Scripts (Backend Logic Kept Intact) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        if (!window.supabase) document.write('<script src="https://unpkg.com/@supabase/supabase-js@2"><\/script>');
        if (new URLSearchParams(window.location.search).get('mode') === 'embedded') {
            document.body.classList.add('embedded');
        }
    </script>
    <script src="config.js"></script>
    <script src="js/supabase-client.js"></script>

    <script>
        // ── State ──
        let productsData = [];
        let currentProductId = null;
        let currentBarcodes = [];
        let currentCodes = [];
        let refCategories = [], refSubcategories = [], refBrands = [], refUnits = [];

        // ── UI Helpers ──
        const EL = (id) => document.getElementById(id);
        const showLoading = () => EL('loadingOverlay').classList.remove('hidden');
        const hideLoading = () => EL('loadingOverlay').classList.add('hidden');
        const escapeHtml = (str) => {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }
        const showToast = (msg, type = 'success') => {
            const container = EL('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i> ${msg}`;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(20px)';
                setTimeout(() => toast.remove(), 300);
            }, 3500);
        }

        // ── Data Loading Logic ──
        async function init() {
            showLoading();
            try {
                await loadReferences();
                await loadProducts();
                renderDropdowns();
                clearEditor();
            } catch (e) {
                console.error(e);
                showToast(e.message, 'error');
            } finally {
                hideLoading();
            }
        }

        async function loadReferences() {
            const [c, s, b, u] = await Promise.all([
                supabase.from('categories').select('*').order('name'),
                supabase.from('subcategories').select('*').order('name'),
                supabase.from('brands').select('*').order('name'),
                supabase.from('units').select('*').order('name')
            ]);
            refCategories = c.data || [];
            refSubcategories = s.data || [];
            refBrands = b.data || [];
            refUnits = u.data || [];
        }

        async function loadProducts() {
            const { data, error } = await supabase.from('products').select('*').order('created_at', { ascending: false });
            if (error) throw error;
            productsData = data || [];
            renderGrid();
        }

        async function refreshProducts() {
            showLoading();
            await loadProducts();
            hideLoading();
            showToast('Refreshed');
        }

        // ── Rendering Logic ──
        function renderDropdowns() {
            const populate = (id, data, placeholder) => {
                const el = EL(id);
                el.innerHTML = `<option value="">${placeholder}</option>` +
                    data.map(i => `<option value="${i.id}">${escapeHtml(i.name)}</option>`).join('');
            };
            const populateUnits = (id, data, placeholder, useShortName = false) => {
                const el = EL(id);
                el.innerHTML = `<option value="">${placeholder}</option>` +
                    data.map(u => `<option value="${useShortName ? escapeHtml(u.short_name) : u.id}">${escapeHtml(u.short_name)}</option>`).join('');
            };
            populate('edit-category', refCategories, 'Select Category');
            populate('edit-subcategory', refSubcategories, 'Select Sub-Category');
            populate('edit-brand', refBrands, 'Select Brand');
            populateUnits('edit-unit', refUnits, 'Select Unit', false);
            populateUnits('edit-purchase-unit', refUnits, 'Select Purchase Unit', true);
        }

        function renderGrid() {
            const tbody = EL('tableBody');
            tbody.innerHTML = '';
            productsData.forEach((p, idx) => {
                const tr = document.createElement('tr');
                tr.dataset.id = p.id;
                if (currentProductId === p.id) tr.classList.add('selected');
                tr.onclick = () => selectProduct(p.id);

                const catName = refCategories.find(c => c.id === p.category_id)?.name || '';
                const brandName = refBrands.find(b => b.id === p.brand_id)?.name || '';
                const formatNum = (n) => n ? parseFloat(n).toFixed(2) : '0.00';

                tr.innerHTML = `
                    <td>${idx + 1}</td>
                    <td><code style="color:var(--primary)">${escapeHtml(p.code)}</code></td>
                    <td><small>${(p.barcodes || []).join(', ')}</small></td>
                    <td><b style="color:var(--text-primary)">${escapeHtml(p.name)}</b></td>
                    <td>${escapeHtml(catName)}</td>
                    <td>${escapeHtml(brandName)}</td>
                    <td style="font-family:monospace">${formatNum(p.cost)}</td>
                    <td style="font-family:monospace; color:var(--primary)">${formatNum(p.price)}</td>
                    <td><span style="font-weight:600">${p.stock}</span></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderBarcodeTags() {
            const container = EL('edit-barcode-tags');
            container.innerHTML = currentBarcodes.map(b =>
                `<span class="barcode-tag">${escapeHtml(b)} <i class="fas fa-times remove-tag" onclick="removeBarcode('${escapeHtml(b)}')"></i></span>`
            ).join('');
        }

        function renderCodeTags() {
            const container = EL('edit-code-tags');
            container.innerHTML = currentCodes.map(c =>
                `<span class="barcode-tag" style="background:rgba(16,185,129,0.15); border-color:rgba(16,185,129,0.2); color:#6ee7b7">${escapeHtml(c)} <i class="fas fa-times remove-tag" onclick="removeCode('${escapeHtml(c)}')"></i></span>`
            ).join('');
            EL('edit-code').value = currentCodes[0] || '';
        }

        // ── Logic ──
        function selectProduct(id) {
            currentProductId = id;
            const p = productsData.find(x => x.id === id);
            if (!p) return;

            currentCodes = p.code ? [p.code] : [];
            currentBarcodes = [...(p.barcodes || [])];

            EL('edit-code').value = p.code || '';
            EL('edit-name').value = p.name || '';
            EL('edit-category').value = p.category_id || '';
            updateSubcategories(p.category_id);
            EL('edit-subcategory').value = p.subcategory_id || '';
            EL('edit-brand').value = p.brand_id || '';
            EL('edit-cost').value = p.cost || 0;
            EL('edit-unit').value = p.unit_id || '';
            EL('edit-purchase-unit').value = p.purchase_unit || 'Box';
            EL('edit-conversion').value = p.pcs_per_box || 1;
            EL('edit-price').value = p.price || 0;

            const conv = parseFloat(p.pcs_per_box) || 1;
            EL('edit-box-price').value = (p.price * conv).toFixed(2);
            EL('edit-stock').value = p.stock || 0;
            EL('edit-supplier').value = p.supplier || '';
            EL('edit-shop').value = p.shop || '';

            renderBarcodeTags();
            renderCodeTags();
            calcMargin();

            EL('btn-delete').classList.remove('hidden');
            renderGrid();
        }

        function clearEditor() {
            currentProductId = null;
            currentBarcodes = [];
            currentCodes = [];
            const inputs = document.querySelectorAll('.editor-section input, .editor-section select');
            inputs.forEach(i => {
                if (i.type === 'number') i.value = 0;
                else i.value = '';
            });
            EL('edit-purchase-unit').value = 'Box';
            EL('edit-conversion').value = 1;
            EL('edit-margin').value = '0.00%';
            renderBarcodeTags();
            renderCodeTags();
            EL('btn-delete').classList.add('hidden');
            renderGrid();
        }

        function updateSubcategories(catId) {
            const subSelect = EL('edit-subcategory');
            const subs = catId ? refSubcategories.filter(s => s.category_id == catId) : refSubcategories;
            subSelect.innerHTML = `<option value="">Select Sub-Category</option>` +
                subs.map(s => `<option value="${s.id}">${escapeHtml(s.name)}</option>`).join('');
        }

        function calcMargin() {
            const cost = parseFloat(EL('edit-cost').value) || 0;
            const price = parseFloat(EL('edit-price').value) || 0;
            EL('edit-margin').value = (cost > 0 && price > 0) ? (((price - cost) / cost) * 100).toFixed(2) + '%' : '0.00%';
        }

        function updateFromUnit() {
            const unitPrice = parseFloat(EL('edit-price').value) || 0;
            const conv = parseFloat(EL('edit-conversion').value) || 1;
            EL('edit-box-price').value = (unitPrice * conv).toFixed(2);
            calcMargin();
        }

        function updateFromBox() {
            const boxPrice = parseFloat(EL('edit-box-price').value) || 0;
            const conv = parseFloat(EL('edit-conversion').value) || 1;
            if (conv > 0) {
                EL('edit-price').value = (boxPrice / conv).toFixed(2);
                calcMargin();
            }
        }

        function addBarcode(val) {
            if (val && !currentBarcodes.includes(val)) {
                currentBarcodes.push(val);
                renderBarcodeTags();
            }
            EL('edit-barcode-input').value = '';
        }

        window.removeBarcode = function (val) {
            currentBarcodes = currentBarcodes.filter(b => b !== val);
            renderBarcodeTags();
        }

        window.removeCode = function (val) {
            currentCodes = currentCodes.filter(c => c !== val);
            renderCodeTags();
        }

        function addCode(val) {
            if (val && !currentCodes.includes(val)) {
                currentCodes.push(val);
                renderCodeTags();
            }
            EL('edit-code-input').value = '';
        }

        async function saveProduct() {
            const name = EL('edit-name').value.trim();
            if (!name) return showToast('Product name is required', 'error');

            const payload = {
                code: EL('edit-code').value.trim(),
                name: name,
                barcodes: currentBarcodes,
                category_id: EL('edit-category').value || null,
                subcategory_id: EL('edit-subcategory').value || null,
                brand_id: EL('edit-brand').value || null,
                cost: parseFloat(EL('edit-cost').value) || 0,
                price: parseFloat(EL('edit-price').value) || 0,
                unit_id: EL('edit-unit').value || null,
                purchase_unit: EL('edit-purchase-unit').value,
                pcs_per_box: parseInt(EL('edit-conversion').value) || 1,
                supplier: EL('edit-supplier').value,
                shop: EL('edit-shop').value,
                stock: parseInt(EL('edit-stock').value) || 0,
            };

            showLoading();
            try {
                if (currentProductId) {
                    const { error } = await supabase.from('products').update(payload).eq('id', currentProductId);
                    if (error) throw error;
                    showToast('Product updated');
                } else {
                    const { error } = await supabase.from('products').insert([payload]);
                    if (error) throw error;
                    showToast('Product created');
                    clearEditor();
                }
                await loadProducts();
            } catch (e) {
                showToast(e.message, 'error');
            } finally {
                hideLoading();
            }
        }

        async function deleteCurrentProduct() {
            if (!currentProductId || !confirm('Delete this product permanently?')) return;
            showLoading();
            try {
                const { error } = await supabase.from('products').delete().eq('id', currentProductId);
                if (error) throw error;
                showToast('Product deleted');
                clearEditor();
                await loadProducts();
            } catch (e) {
                showToast(e.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // Listeners
        EL('edit-cost').addEventListener('input', calcMargin);
        EL('edit-price').addEventListener('input', updateFromUnit);
        EL('edit-conversion').addEventListener('input', updateFromUnit);
        EL('edit-box-price').addEventListener('input', updateFromBox);
        EL('edit-category').addEventListener('change', (e) => updateSubcategories(e.target.value));

        const handleTagInput = (e, callback) => {
            if (e.key === 'Enter' || e.key === 'Tab') {
                const val = e.target.value.trim();
                if (val) {
                    e.preventDefault();
                    callback(val);
                }
            }
        };

        EL('edit-barcode-input').addEventListener('keydown', (e) => handleTagInput(e, addBarcode));
        EL('edit-code-input').addEventListener('keydown', (e) => handleTagInput(e, addCode));

        // Wait for Supabase client to fully initialize before loading data
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(init, 150);
        });
    </script>
</body>

</html>