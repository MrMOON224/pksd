<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Purchase Return - Glass Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

        :root {
            --bg-top: var(--bg-primary);
            --accent-indigo: var(--primary);
            --glass-panel: var(--bg-glass);
            --text-primary: #f8fafc;
            --text-muted: var(--text-muted);
            --success-green: var(--success);
            --warning-alert: var(--error);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-top);
            color: var(--text-primary);
            overflow: hidden;
        }

        .glass-card {
            background: var(--glass-panel);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .glass-input {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            font-size: 0.75rem;
            padding: 0.35rem 0.5rem;
            border-radius: 0.35rem;
            width: 100%;
            transition: all 0.3s ease;
        }

        .glass-input:focus {
            outline: none;
            border-color: var(--accent-indigo);
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
            background: rgba(255, 255, 255, 0.08);
        }

        .table-container {
            flex-grow: 1;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.05);
            background: rgba(0, 0, 0, 0.2);
            border-radius: 0.75rem;
        }

        .table-header th {
            position: sticky;
            top: 0;
            background: var(--bg-secondary);
            z-index: 10;
            font-size: 0.65rem;
            padding: 0.6rem;
            color: var(--text-muted);
            text-transform: uppercase;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            border-right: 1px solid rgba(255, 255, 255, 0.05);
        }

        .no-spinner::-webkit-inner-spin-button,
        .no-spinner::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        ::-webkit-scrollbar {
            width: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        #itemsTable tbody td {
            border-right: 1px solid rgba(255, 255, 255, 0.05);
            padding: 0;
        }

        .remark-header {
            background: var(--error) !important;
            color: white !important;
        }

        .btn-submit {
            background: var(--gradient-primary);
            transition: all 0.3s ease;
        }

        .btn-submit:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-glow);
        }

        select.glass-input option {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .preview-text {
            color: rgba(255, 255, 255, 0.4) !important;
            font-style: italic;
        }
    </style>

    <!-- Supabase Integration -->
    <script src="config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-client.js"></script>
</head>

<body class="p-2 md:p-3 text-[11px] h-screen flex flex-col">

    <div class="max-w-[1600px] mx-auto w-full flex flex-col h-full space-y-2">

        <!-- Top Toolbar -->
        <div class="flex justify-between items-center px-1">
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-2">
                    <label class="font-bold text-[var(--text-muted)] uppercase text-[9px]">Return Date</label>
                    <input type="date" id="returnDate" class="glass-input !w-32">
                </div>
                <div class="flex items-center gap-2">
                    <label class="font-bold text-[var(--text-muted)] uppercase text-[9px]">From Shop</label>
                    <select id="warehouseId" class="glass-input !w-48">
                        <option value="">Select Warehouse...</option>
                    </select>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="viewPurchaseOrders()"
                    class="bg-indigo-500/10 hover:bg-indigo-500/20 text-indigo-400 border border-indigo-500/30 px-4 py-1.5 rounded font-bold text-[10px] transition-all">LOAD
                    FROM PURCHASE</button>
                <button onclick="viewRecentReturns()"
                    class="bg-white/10 hover:bg-white/20 px-4 py-1.5 rounded font-bold text-[10px] transition-all">RECENT
                    RETURNS</button>
                <button onclick="submitReturn()"
                    class="btn-submit px-5 py-1.5 rounded font-bold text-[10px] text-white">SAVE RETURN</button>
            </div>
        </div>

        <!-- Return Header Metadata Block -->
        <div class="glass-card rounded-lg p-3 grid grid-cols-4 gap-4">
            <div class="space-y-1">
                <label class="text-[9px] font-bold uppercase text-[var(--text-muted)]">Voucher Code</label>
                <div class="flex gap-1">
                    <input type="text" id="voucherCode" class="glass-input" placeholder="Will be generated" readonly>
                    <button id="copyBtn" onclick="copyToClipboard(document.getElementById('voucherCode').value)"
                        class="hidden bg-white/10 hover:bg-white/20 px-2 rounded transition-all">
                        <i class="fas fa-copy text-[10px]"></i>
                    </button>
                </div>
            </div>
            <div class="space-y-1">
                <label class="text-[9px] font-bold uppercase text-[var(--text-muted)]">To Supplier</label>
                <select id="supplierId" class="glass-input">
                    <option value="">Select Supplier...</option>
                </select>
            </div>
            <div class="space-y-1">
                <label class="text-[9px] font-bold uppercase text-[var(--text-muted)]">Reference No.</label>
                <input type="text" id="purchaseRef" class="glass-input" placeholder="Optional reference to original PO">
            </div>
            <div class="space-y-1">
                <label class="text-[9px] font-bold uppercase text-[var(--text-muted)]">Status</label>
                <select id="returnStatus" class="glass-input">
                    <option value="Completed">Completed</option>
                    <option value="Pending">Pending</option>
                </select>
            </div>
        </div>

        <!-- Main Items Table Area -->
        <div class="table-container">
            <table class="w-full border-collapse" id="itemsTable">
                <thead class="table-header">
                    <tr class="text-left">
                        <th class="w-8 text-center">No</th>
                        <th class="w-24">Item Code</th>
                        <th class="w-40">Barcode</th>
                        <th>Description</th>
                        <th class="w-16 text-center">QTY</th>
                        <th class="w-20 text-center">Unit</th>
                        <th class="w-24 text-right">Cost</th>
                        <th class="w-16 text-right">Disco</th>
                        <th class="w-24 text-right">Amount</th>
                        <th class="w-48 remark-header">remark</th>
                        <th class="w-6 border-none"></th>
                    </tr>
                </thead>
                <tbody id="tableBody" class="divide-y divide-white/5">
                    <!-- Items will be rendered here -->
                </tbody>
            </table>
        </div>

        <!-- Quick Add Row -->
        <div class="px-1 flex justify-between items-center">
            <button onclick="addRow()"
                class="text-[var(--accent-indigo)] hover:text-white font-bold text-[9px] uppercase flex items-center gap-1 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                Add New Item to Return
            </button>
            <div id="loadedIndicator"
                class="hidden text-amber-500 font-bold text-[9px] uppercase flex items-center gap-2">
                <i class="fas fa-edit"></i> Editing Saved Return
                <button onclick="window.location.reload()" class="text-white/20 hover:text-white">Clear</button>
            </div>
        </div>

        <!-- Order Footer Summary -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
            <div class="glass-card rounded-lg p-3 grid grid-cols-2 gap-3 col-span-3">
                <div class="space-y-1">
                    <label class="text-[9px] font-bold uppercase text-[var(--text-muted)]">Return Tax (%)</label>
                    <input type="number" id="taxPercent" oninput="calculateTotals()" value="0"
                        class="glass-input no-spinner" placeholder="0">
                </div>
                <div class="space-y-1">
                    <label class="text-[9px] font-bold uppercase text-[var(--text-muted)]">Total Discount</label>
                    <input type="number" id="overallDiscount" oninput="calculateTotals()" value="0"
                        class="glass-input no-spinner" placeholder="0">
                </div>
                <div class="space-y-1">
                    <label class="text-[9px] font-bold uppercase text-[var(--text-muted)]">Shipping / Other Cost</label>
                    <input type="number" id="shipping" oninput="calculateTotals()" value="0"
                        class="glass-input no-spinner" placeholder="0">
                </div>
                <div class="space-y-1 relative">
                    <label class="text-[9px] font-bold uppercase text-[var(--text-muted)] flex justify-between">
                        Refund Amount (Paid)
                        <span id="remainBadge" class="text-[var(--warning-alert)] text-[9px] font-bold hidden">Rem:
                            0</span>
                    </label>
                    <input type="number" id="paidAmount" oninput="calculateTotals()" value="0"
                        class="glass-input text-[var(--success-green)] font-bold no-spinner" placeholder="0">
                </div>

                <div class="space-y-1">
                    <label class="text-[9px] font-bold uppercase text-[var(--text-muted)]">Refund Method</label>
                    <select id="paymentType" class="glass-input">
                        <option value="Cash">Cash</option>
                        <option value="Credit Note">Credit Note</option>
                        <option value="Bank Transfer">Bank Transfer</option>
                    </select>
                </div>
                <div class="space-y-1">
                    <label class="text-[9px] font-bold uppercase text-[var(--text-muted)]">Payment Status</label>
                    <select id="paymentStatus" class="glass-input">
                        <option value="Paid">Received</option>
                        <option value="Unpaid">Pending</option>
                    </select>
                </div>

                <div class="col-span-2 flex items-center gap-3">
                    <label class="text-[9px] font-bold uppercase text-[var(--text-muted)] whitespace-nowrap">Return
                        Notes</label>
                    <input type="text" id="orderNote"
                        class="glass-input !rounded-none border-x-0 border-t-0 border-b border-white/20 bg-transparent focus:bg-white/5"
                        placeholder="Enter general notes for this return...">
                </div>
            </div>

            <!-- Summary Table -->
            <div class="glass-card rounded-lg p-3 space-y-2 overflow-hidden flex flex-col justify-center">
                <div class="flex justify-between items-center border-b border-white/5 pb-1">
                    <span class="text-[var(--text-muted)] uppercase font-bold text-[8px]">Items Subtotal</span>
                    <span id="displaySubTotal" class="font-bold">0</span>
                </div>
                <div class="flex justify-between items-center border-b border-white/5 pb-1">
                    <span class="text-[var(--text-muted)] uppercase font-bold text-[8px]">Return Tax</span>
                    <span id="displayTax" class="text-right">0</span>
                </div>
                <div class="flex justify-between items-center border-b border-white/5 pb-1">
                    <span class="text-[var(--warning-alert)] uppercase font-bold text-[8px]">Discount</span>
                    <span id="displayDiscount" class="text-right">-0</span>
                </div>
                <div class="flex justify-between items-center border-b border-white/5 pb-1">
                    <span class="text-[var(--text-muted)] uppercase font-bold text-[8px]">Shipping</span>
                    <span id="displayShipping" class="text-right">0</span>
                </div>
                <div class="mt-2 text-[var(--primary)] flex flex-col items-end">
                    <span class="uppercase font-black text-[9px] mb-1">Total Refundable</span>
                    <div id="displayNet" class="text-2xl font-black leading-none">0</div>
                </div>
                <div class="pt-2 border-t border-white/10 flex justify-between items-center">
                    <span class="text-[var(--warning-alert)] uppercase font-bold text-[8px]">Remain Balance</span>
                    <span id="remainAmount" class="font-bold text-[var(--warning-alert)]">0</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Script stays here for now, as requested to be same design -->
    <script>
        let items = [];
        let suppliers = [];
        let warehouses = [];        let units = [];
        let unitsMap = new Map();        let productsMap = new Map();
        let loadedReturnId = null;

        window.onload = () => {
            document.getElementById('returnDate').valueAsDate = new Date();
            setTimeout(initData, 150);
        };

        async function initData() {
            try {
                // Load Suppliers
                const { data: supData } = await supabase.from('suppliers').select('id, name');
                suppliers = supData || [];
                const supSelect = document.getElementById('supplierId');
                suppliers.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s.id;
                    opt.textContent = s.name;
                    supSelect.appendChild(opt);
                });

                // Load Warehouses
                const { data: whData } = await supabase.from('warehouses').select('id, name');
                warehouses = whData || [];
                const whSelect = document.getElementById('warehouseId');
                warehouses.forEach(w => {
                    const opt = document.createElement('option');
                    opt.value = w.id;
                    opt.textContent = w.name;
                    whSelect.appendChild(opt);
                });

                // Load Units
                const { data: unitData } = await supabase.from('units').select('id, name');
                units = unitData || [];
                units.forEach(u => unitsMap.set(u.id, u.name));

                // Load Products
                const { data: prodData } = await supabase.from('products').select('id, code, name, barcodes, cost, price, pcs_per_box, unit_id');
                (prodData || []).forEach(p => {
                    productsMap.set(p.id, p);
                    if (p.code) productsMap.set(p.code, p);
                    if (p.barcodes && Array.isArray(p.barcodes)) {
                        p.barcodes.forEach(bc => productsMap.set(bc, p));
                    }
                });

                addRow();
            } catch (err) {
                console.error('Init error:', err);
                alert('Failed to load data: ' + err.message);
            }
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            items.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-white/[0.04] transition-colors relative";
                const isP = item.isPreview;
                tr.innerHTML = `
                    <td class="text-center font-bold text-white/20">${index + 1}</td>
                    <td>
                        <input type="text" value="${item.itemCode || ''}" 
                               oninput="handleSearch(${index}, 'itemCode', this.value)" 
                               onkeydown="handleGridKey(${index}, event)"
                               class="bg-transparent w-full outline-none p-2 ${isP && item.lastTyped !== 'itemCode' ? 'preview-text' : ''}" placeholder="Code...">
                    </td>
                    <td><input type="text" value="${item.barcode || ''}" 
                               oninput="handleSearch(${index}, 'barcode', this.value)" 
                               onkeydown="handleGridKey(${index}, event)"
                               class="bg-transparent w-full outline-none p-2 ${isP && item.lastTyped !== 'barcode' ? 'preview-text' : ''}" placeholder="Barcode..."></td>
                    <td><input type="text" value="${item.description || ''}" 
                               oninput="handleSearch(${index}, 'description', this.value)" 
                               onkeydown="handleGridKey(${index}, event)"
                               class="bg-transparent w-full outline-none p-2 ${isP && item.lastTyped !== 'description' ? 'preview-text' : ''}" placeholder="Description..."></td>
                    <td><input type="number" value="${item.qty || 0}" oninput="updateItem(${index}, 'qty', this.value)" class="bg-transparent w-full text-center outline-none no-spinner font-bold p-2"></td>
                    <td>
                        <select onchange="updateItem(${index}, 'unitId', this.value)" class="glass-input appearance-none bg-transparent w-full outline-none p-2 text-center text-white/50">
                            <option value="">Select unit</option>
                            ${units.map(u => `<option value="${u.id}" ${item.unitId===u.id? 'selected' : ''}>${u.name}</option>`).join('')}
                        </select>
                    </td>
                    <td><input type="number" value="${item.cost || 0}" oninput="updateItem(${index}, 'cost', this.value)" class="bg-transparent w-full outline-none text-right p-2 no-spinner ${isP ? 'preview-text' : ''}"></td>
                    <td><input type="text" value="${item.discount || '0'}" oninput="updateItem(${index}, 'discount', this.value)" class="bg-transparent w-full outline-none text-right p-2"></td>
                    <td class="text-right font-bold pr-3">${(item.amount || 0).toLocaleString()}</td>
                    <td><input type="text" value="${item.remark || ''}" onchange="updateItem(${index}, 'remark', this.value)" class="bg-transparent w-full outline-none italic text-[var(--warning-alert)] px-2" placeholder="Damage?"></td>
                    <td class="text-center border-none"><button onclick="removeRow(${index})" class="text-white/20 hover:text-red-500 font-bold transition-all px-2 text-lg">√ó</button></td>
                `;
                tbody.appendChild(tr);
            });
            calculateTotals();
        }

        function handleSearch(idx, field, query) {
            updateItem(idx, field, query);
            items[idx].lastTyped = field;

            if (!query || query.length < 1) {
                items[idx].isPreview = false;
                items[idx].tempProductId = null;
                return;
            }

            const product = Array.from(productsMap.values()).find(p => {
                if (!p) return false;
                const q = query.toLowerCase();
                return (p.name && p.name.toLowerCase().includes(q)) ||
                    (p.code && (p.code.toLowerCase() === q || p.code.toLowerCase().startsWith(q))) ||
                    (p.barcodes && p.barcodes.some(b => b.toLowerCase() === q || b.toLowerCase().startsWith(q)));
            });

            if (product) {
                items[idx].isPreview = true;
                items[idx].tempProductId = product.id;
                items[idx].itemCode = product.code || items[idx].itemCode;
                items[idx].barcode = product.barcodes?.[0] || items[idx].barcode;
                items[idx].description = product.name || items[idx].description;
                items[idx].cost = product.cost || product.price || 0;

                const row = document.getElementById('tableBody').children[idx];
                if (row) {
                    const inputs = row.querySelectorAll('input');
                    if (field !== 'itemCode') inputs[0].value = product.code || '';
                    if (field !== 'barcode') inputs[1].value = product.barcodes?.[0] || '';
                    if (field !== 'description') inputs[2].value = product.name || '';
                    inputs[5].value = product.cost || product.price || 0;

                    inputs.forEach((inp, i) => {
                        if ([0, 1, 2, 5].includes(i)) {
                            const fNames = ['itemCode', 'barcode', 'description', 'cost'];
                            if (fNames[i === 5 ? 3 : i] !== field) {
                                inp.classList.add('preview-text');
                            }
                        }
                    });
                }
            } else {
                items[idx].isPreview = false;
                items[idx].tempProductId = null;
                const row = document.getElementById('tableBody').children[idx];
                if (row) {
                    row.querySelectorAll('input').forEach(inp => inp.classList.remove('preview-text'));
                }
            }
        }

        function handleGridKey(idx, e) {
            if (e.key === 'Enter') {
                if (items[idx].isPreview && items[idx].tempProductId) {
                    e.preventDefault();
                    confirmSelection(idx);
                }
            } else if (e.key === 'Escape') {
                if (items[idx].isPreview) {
                    items[idx].isPreview = false;
                    renderTable();
                }
            }
        }

        function confirmSelection(idx) {
            const productId = items[idx].tempProductId;
            const product = productsMap.get(productId);
            if (!product) return;

            items[idx] = {
                product_id: product.id,
                itemCode: product.code || '',
                barcode: product.barcodes?.[0] || '',
                description: product.name || '',
                qty: 1,
                pcsBox: product.pcs_per_box || 1,
                    unitId: product.unit_id || '',

            renderTable();

            setTimeout(() => {
                const row = document.getElementById('tableBody').children[idx];
                if (row) {
                    const qtyInput = row.querySelectorAll('input')[3];
                    if (qtyInput) {
                        qtyInput.focus();
                        qtyInput.select();
                    }
                }
            }, 50);
        }

        function updateItem(index, field, value) {
            items[index][field] = value;
            if (field === 'unitId') {
                items[index].unitName = unitsMap.get(value) || '';
            }
            if (['qty', 'cost', 'discount', 'pcsBox'].includes(field)) {
                const qty = parseFloat(items[index].qty) || 0;
                const cost = parseFloat(items[index].cost) || 0;
                const dStr = items[index].discount?.toString() || '0';
                let d = dStr.includes('%') ? (parseFloat(dStr) / 100) * (qty * cost) : parseFloat(dStr) || 0;
                items[index].amount = (qty * cost) - d;

                const row = document.getElementById('tableBody').children[index];
                if (row) {
                    const amountCell = row.children[8];
                    if (amountCell) amountCell.textContent = items[index].amount.toLocaleString();
                }
                calculateTotals();
            }
        }

        function addRow() {
            items.push({
                product_id: null,
                itemCode: '',
                barcode: '',
                description: '',
                qty: 0,
                pcsBox: '',
                unitId: '',
                cost: 0,
                discount: '0',
                amount: 0,
                remark: '',
                isPreview: false,
                tempProductId: null
            });
            renderTable();
        }

        function removeRow(index) {
            items.splice(index, 1);
            if (items.length === 0) addRow();
            renderTable();
        }

        function calculateTotals() {
            const sub = items.reduce((acc, i) => acc + (parseFloat(i.amount) || 0), 0);
            const taxP = parseFloat(document.getElementById('taxPercent').value) || 0;
            const disc = parseFloat(document.getElementById('overallDiscount').value) || 0;
            const ship = parseFloat(document.getElementById('shipping').value) || 0;
            const paid = parseFloat(document.getElementById('paidAmount').value) || 0;

            const taxA = (sub * taxP) / 100;
            const net = sub + taxA + ship - disc;

            document.getElementById('displaySubTotal').innerText = sub.toLocaleString();
            document.getElementById('displayTax').innerText = taxA.toLocaleString();
            document.getElementById('displayDiscount').innerText = '-' + disc.toLocaleString();
            document.getElementById('displayShipping').innerText = ship.toLocaleString();
            document.getElementById('displayNet').innerText = net.toLocaleString();

            const rem = net - paid;
            document.getElementById('remainAmount').innerText = rem.toLocaleString();

            const badge = document.getElementById('remainBadge');
            if (badge) {
                badge.innerText = `Rem: ${rem.toLocaleString()}`;
                if (paid > 0 || rem !== net) badge.classList.remove('hidden');
                else badge.classList.add('hidden');
            }
        }

        function generateVoucherCode() {
            const now = new Date();
            const date = now.toISOString().slice(0, 10).replace(/-/g, '');
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return `PR-${date}-${random}`;
        }

        async function submitReturn() {
            try {
                const supplier_id = document.getElementById('supplierId').value;
                const warehouse_id = document.getElementById('warehouseId').value;

                if (!supplier_id || !warehouse_id) {
                    alert('‚ö†Ô∏è Please select Supplier and Warehouse.');
                    return;
                }

                const validItems = items.filter(i => i.product_id && i.qty > 0);
                if (validItems.length === 0) {
                    alert('‚ö†Ô∏è Please add at least one valid item to return.');
                    return;
                }

                let ref_code = document.getElementById('voucherCode').value || generateVoucherCode();

                const sub = validItems.reduce((acc, i) => acc + i.amount, 0);
                const taxP = parseFloat(document.getElementById('taxPercent').value) || 0;
                const disc = parseFloat(document.getElementById('overallDiscount').value) || 0;
                const ship = parseFloat(document.getElementById('shipping').value) || 0;
                const paid = parseFloat(document.getElementById('paidAmount').value) || 0;

                const taxA = (sub * taxP) / 100;
                const net = sub + taxA + ship - disc;

                const returnData = {
                    reference_no: ref_code,
                    date: document.getElementById('returnDate').value || new Date().toISOString().split('T')[0],
                    supplier_id,
                    warehouse_id,
                    status: document.getElementById('returnStatus').value,
                    payment_status: paid >= net ? 'Paid' : (paid > 0 ? 'Partial' : 'Unpaid'),
                    payment_type: document.getElementById('paymentType').value,
                    grand_total: net,
                    order_tax_percentage: taxP,
                    order_tax_amount: taxA,
                    discount_amount: disc,
                    shipping_amount: ship,
                    paid_amount: paid,
                    note: document.getElementById('orderNote').value || null,
                    // original_purcase_ref linked optionally
                    note: (document.getElementById('purchaseRef').value ? `[PO REF: ${document.getElementById('purchaseRef').value}] ` : '') + (document.getElementById('orderNote').value || '')
                };

                const { data: retData, error: retErr } = await supabase.from('purchase_returns').insert(returnData).select().single();
                if (retErr) throw retErr;
                const returnId = retData.id;

                // Insert items
                const itemsToInsert = validItems.map(item => ({
                    return_id: returnId,
                    product_id: item.product_id,
                    quantity: parseFloat(item.qty) || 0,
                    unit_cost: parseFloat(item.cost) || 0,
                    discount_amount: parseFloat(item.discount) || 0,
                    subtotal: item.amount,
                    unit_id: item.unitId || null,
                    remark: item.remark
                }));

                const { error: itemErr } = await supabase.from('purchase_return_items').insert(itemsToInsert);
                if (itemErr) throw itemErr;

                // UPDATE STOCK (DECREMENT)
                if (returnData.status === 'Completed') {
                    for (const item of validItems) {
                        const amount = -(parseFloat(item.qty) * (parseFloat(item.pcsBox) || 1));
                        const { error: stockErr } = await supabase.rpc('increment_stock', {
                            row_id: item.product_id,
                            amount: amount
                        });
                        if (stockErr) console.error('Stock Update Error:', stockErr);
                    }
                }

                document.getElementById('voucherCode').value = ref_code;
                document.getElementById('copyBtn').classList.remove('hidden');
                showSuccessModal(ref_code);

            } catch (err) {
                console.error('Save error:', err);
                alert('‚ùå Failed to save return: ' + err.message);
            }
        }

        function showSuccessModal(code) {
            let modalHtml = `
                <div id="successModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(15, 23, 42, 0.85);z-index:9999;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(12px);">
                    <div class="glass-card" style="padding:40px;max-width:420px;width:95%;text-align:center;border-radius:24px;box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);">
                        <div style="font-size:50px;margin-bottom:20px;">üîÑ</div>
                        <h2 style="color:#fff;margin-bottom:10px;font-size:24px;font-weight:800;letter-spacing:-0.5px;">Return Saved!</h2>
                        <p style="color:var(--text-muted);font-size:14px;margin-bottom:24px;">The purchase return and stock adjustments have been processed.</p>
                        
                        <div style="background:rgba(255,255,255,0.05);padding:15px;border-radius:12px;margin-bottom:24px;border:1px dashed var(--primary); display:flex; align-items:center; justify-content:center; gap:10px;">
                            <span style="color:var(--primary);font-family:monospace;font-size:20px;font-weight:800;letter-spacing:1px;">${code}</span>
                        </div>

                        <div style="display:flex;gap:12px;justify-content:center;">
                            <button onclick="window.location.reload()" style="flex:1;background:rgba(255,255,255,0.1);color:white;padding:12px;border-radius:12px;font-weight:700;font-size:12px;border:none;">NEW RETURN</button>
                            <button onclick="document.getElementById('successModal').remove()" style="flex:1;background:var(--primary);color:white;padding:12px;border-radius:12px;font-weight:700;font-size:12px;">CLOSE</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        async function viewPurchaseOrders() {
            try {
                const { data, error } = await supabase
                    .from('purchases')
                    .select('*, supplier:suppliers(name)')
                    .eq('status', 'Received')
                    .order('date', { ascending: false })
                    .limit(20);

                if (error) throw error;
                if (!data || data.length === 0) { alert('No received purchase orders found.'); return; }

                let html = `<div id="listModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(15, 23, 42, 0.9);z-index:9999;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(15px);" onclick="this.remove()">`;
                html += `<div class="glass-card" style="padding:30px;max-width:900px;width:95%;max-height:85vh;overflow-y:auto;border-radius:24px;" onclick="event.stopPropagation()">`;
                html += `<h2 style="color:var(--primary);font-size:20px;font-weight:800;margin-bottom:20px;">üì¶ SELECT PURCHASE TO RETURN</h2>`;
                html += `<table style="width:100%; border-collapse:collapse;">`;
                html += `<thead><tr style="border-bottom:2px solid rgba(255,255,255,0.1);"><th style="text-align:left;padding:10px;font-size:10px;color:var(--text-muted);">REF</th><th style="padding:10px;font-size:10px;color:var(--text-muted);">SUPPLIER</th><th style="text-align:right;padding:10px;font-size:10px;color:var(--text-muted);">TOTAL</th><th style="text-align:center;padding:10px;font-size:10px;color:var(--text-muted);">ACTION</th></tr></thead><tbody>`;

                data.forEach(p => {
                    html += `<tr class="border-b border-white/5 hover:bg-white/5">
                        <td class="p-3 text-[var(--primary)] font-bold">${p.reference_no}</td>
                        <td class="p-3">${p.supplier?.name}</td>
                        <td class="p-3 text-right">${p.grand_total.toLocaleString()} Ks</td>
                        <td class="p-3 text-center"><button onclick="loadFromPurchase('${p.id}'); this.closest('#listModal').remove();" class="bg-indigo-500/20 text-indigo-400 px-4 py-1.5 rounded font-bold">LOAD</button></td>
                    </tr>`;
                });
                html += `</tbody></table></div></div>`;
                document.body.insertAdjacentHTML('beforeend', html);
            } catch (err) { alert(err.message); }
        }

        async function loadFromPurchase(id) {
            try {
                const { data: purchase, error } = await supabase.from('purchases').select('*, purchase_items(*)').eq('id', id).single();
                if (error) throw error;

                document.getElementById('supplierId').value = purchase.supplier_id;
                document.getElementById('warehouseId').value = purchase.warehouse_id;
                document.getElementById('purchaseRef').value = purchase.reference_no;

                items = purchase.purchase_items.map(pi => {
                    const prod = productsMap.get(pi.product_id);
                    return {
                        product_id: pi.product_id,
                        itemCode: prod?.code || '',
                        barcode: prod?.barcodes?.[0] || '',
                        description: prod?.name || '',
                        qty: pi.quantity,
                        pcsBox: pi.pcs_box || prod?.pcs_per_box || 1,
                        unitId: pi.unit_id || prod?.unit_id || '',
                        cost: pi.unit_cost,
                        discount: pi.discount_amount || 0,
                        amount: pi.subtotal,
                        remark: '',
                        isPreview: false
                    };
                });

                renderTable();
            } catch (err) { alert(err.message); }
        }

        async function viewRecentReturns() {
            try {
                const { data, error } = await supabase
                    .from('purchase_returns')
                    .select('*, supplier:suppliers(name)')
                    .order('date', { ascending: false })
                    .limit(20);

                if (error) throw error;
                if (!data || data.length === 0) { alert('No returns found.'); return; }

                let html = `<div id="listModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(15, 23, 42, 0.9);z-index:9999;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(15px);" onclick="this.remove()">`;
                html += `<div class="glass-card" style="padding:30px;max-width:900px;width:95%;max-height:85vh;overflow-y:auto;border-radius:24px;" onclick="event.stopPropagation()">`;
                html += `<div class="flex justify-between items-center mb-6">`;
                html += `<h2 style="color:var(--primary);font-size:20px;font-weight:800;">üîÑ RECENT PURCHASE RETURNS</h2>`;
                html += `<button onclick="this.closest('#listModal').remove()" style="color:var(--text-muted);font-size:28px;line-height:1;">√ó</button>`;
                html += `</div>`;
                html += `<table style="width:100%; border-collapse:collapse;">`;
                html += `<thead><tr style="border-bottom:2px solid rgba(255,255,255,0.1);"><th style="text-align:left;padding:10px;font-size:10px;color:var(--text-muted);">REF</th><th style="padding:10px;font-size:10px;color:var(--text-muted);">DATE</th><th style="padding:10px;font-size:10px;color:var(--text-muted);">SUPPLIER</th><th style="text-align:right;padding:10px;font-size:10px;color:var(--text-muted);">TOTAL</th><th style="text-align:center;padding:10px;font-size:10px;color:var(--text-muted);">ACTION</th></tr></thead><tbody>`;

                data.forEach(r => {
                    html += `<tr class="border-b border-white/5 hover:bg-white/5">
                        <td class="p-3 text-[var(--primary)] font-bold">${r.reference_no}</td>
                        <td class="p-3">${new Date(r.date).toLocaleDateString()}</td>
                        <td class="p-3">${r.supplier?.name || 'N/A'}</td>
                        <td class="p-3 text-right font-bold text-white">${(r.grand_total || 0).toLocaleString()} Ks</td>
                        <td class="p-3 text-center">
                            <div class="flex gap-2 justify-center">
                                <button onclick="loadReturn('${r.id}'); this.closest('#listModal').remove();" class="bg-indigo-500/20 text-indigo-400 px-3 py-1 rounded font-bold text-[10px]">LOAD</button>
                                <button onclick="deleteReturn('${r.id}')" class="bg-red-500/10 text-red-400 px-3 py-1 rounded font-bold text-[10px]"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        </td>
                    </tr>`;
                });
                html += `</tbody></table></div></div>`;
                document.body.insertAdjacentHTML('beforeend', html);
            } catch (err) { alert(err.message); }
        }

        async function loadReturn(id) {
            try {
                const { data: ret, error } = await supabase.from('purchase_returns').select('*, purchase_return_items(*)').eq('id', id).single();
                if (error) throw error;

                loadedReturnId = ret.id;
                document.getElementById('returnDate').value = ret.date;
                document.getElementById('warehouseId').value = ret.warehouse_id;
                document.getElementById('supplierId').value = ret.supplier_id;
                document.getElementById('voucherCode').value = ret.reference_no;
                document.getElementById('taxPercent').value = ret.order_tax_percentage || 0;
                document.getElementById('overallDiscount').value = ret.discount_amount || 0;
                document.getElementById('shipping').value = ret.shipping_amount || 0;
                document.getElementById('paidAmount').value = ret.paid_amount || 0;
                document.getElementById('paymentType').value = ret.payment_type || 'Cash';
                document.getElementById('paymentStatus').value = ret.payment_status || 'Paid';

                // Note handling
                let cleanedNote = ret.note || '';
                const poMatch = cleanedNote.match(/\[PO REF: (.*?)\]/);
                if (poMatch) {
                    document.getElementById('purchaseRef').value = poMatch[1];
                    cleanedNote = cleanedNote.replace(/\[PO REF: (.*?)\]\s*/, '');
                }
                document.getElementById('orderNote').value = cleanedNote;

                items = ret.purchase_return_items.map(ri => {
                    const prod = productsMap.get(ri.product_id);
                    return {
                        product_id: ri.product_id,
                        itemCode: prod?.code || '',
                        barcode: prod?.barcodes?.[0] || '',
                        description: prod?.name || '',
                        qty: ri.quantity,
                        pcsBox: ri.pcs_box || prod?.pcs_per_box || 1,
                        cost: ri.unit_cost,
                        discount: ri.discount_amount || 0,
                        amount: ri.subtotal,
                        remark: ri.remark || '',
                        isPreview: false
                    };
                });

                if (items.length === 0) addRow();
                renderTable();

                document.getElementById('loadedIndicator').classList.remove('hidden');
                document.getElementById('copyBtn').classList.remove('hidden');

            } catch (err) { alert(err.message); }
        }

        async function deleteReturn(id) {
            if (!confirm('Are you sure you want to delete this return? Stock will NOT be automatically reverted.')) return;
            try {
                await supabase.from('purchase_return_items').delete().eq('return_id', id);
                const { error } = await supabase.from('purchase_returns').delete().eq('id', id);
                if (error) throw error;
                alert('Deleted successfully.');
                if (typeof viewRecentReturns === 'function') viewRecentReturns(); // Refresh list
            } catch (err) { alert(err.message); }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('Copied: ' + text);
            });
        }
    </script>
</body>

</html>