<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Admin Dashboard - POS System</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Barcode Library -->
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

    <!-- TomSelect Library (Searchable Dropdowns) -->
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>

    <!-- Styles -->
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/sidebar.css">
    <link rel="stylesheet" href="css/dashboard.css">
    <style>
        /* Excel-like Grid Styles */
        .excel-grid-container {
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow-y: auto;
            max-height: 70vh;
        }

        /* Custom Scrollbar for Touch */
        .excel-grid-container::-webkit-scrollbar {
            width: 24px;
            height: 24px;
        }

        .excel-grid-container::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            margin: 8px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .excel-grid-container::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            border-radius: 12px;
            border: 3px solid rgba(255, 255, 255, 0.2);
            min-height: 60px;
            box-shadow:
                0 4px 8px rgba(0, 0, 0, 0.3),
                0 2px 4px rgba(99, 102, 241, 0.4),
                inset 0 1px 1px rgba(255, 255, 255, 0.3);
            cursor: pointer;
        }

        .excel-grid-container::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, var(--primary-light), var(--primary));
            border-color: rgba(255, 255, 255, 0.3);
            box-shadow:
                0 6px 12px rgba(0, 0, 0, 0.4),
                0 3px 6px rgba(99, 102, 241, 0.6),
                inset 0 1px 2px rgba(255, 255, 255, 0.4);
        }

        .excel-grid-container::-webkit-scrollbar-thumb:active {
            background: var(--primary-dark);
            box-shadow:
                inset 0 4px 8px rgba(0, 0, 0, 0.4),
                0 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* For Firefox */
        .excel-grid-container {
            scrollbar-width: auto;
            scrollbar-color: var(--primary) rgba(0, 0, 0, 0.3);
        }

        .excel-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: auto;
        }

        .excel-table th,
        .excel-table td {
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 0;
            position: relative;
        }

        .excel-table th {
            background: rgba(255, 255, 255, 0.05);
            padding: var(--space-sm) var(--space-md);
            text-align: left;
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--text-muted);
            white-space: nowrap;
        }

        /* TomSelect Custom Theme */
        .ts-wrapper.excel-input {
            padding: 0 !important;
            border: none !important;
            background: transparent !important;
        }

        .ts-control {
            background: rgba(255, 255, 255, 0.03) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            color: var(--text-primary) !important;
            border-radius: 4px !important;
            min-height: 44px !important;
            display: flex !important;
            align-items: center !important;
            padding: 0 10px !important;
            font-family: 'Inter', sans-serif !important;
            font-size: 0.9375rem !important;
        }

        .ts-wrapper.focus .ts-control {
            border-color: var(--primary) !important;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2) !important;
            outline: none !important;
        }

        .ts-dropdown {
            background: #2a2a2a !important;
            color: #fff !important;
            border: 1px solid var(--primary) !important;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5) !important;
        }

        .ts-dropdown .option {
            padding: 10px 15px !important;
        }

        .ts-dropdown .active {
            background-color: var(--primary) !important;
            color: #fff !important;
        }

        .ts-control input {
            color: #fff !important;
        }

        .ts-wrapper.single .ts-control .item {
            color: #fff !important;
        }

        /* Search Dropdown Styles */
        .search-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-md);
            z-index: 1000;
            max-height: 250px;
            overflow-y: auto;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .search-result-item {
            padding: var(--space-sm) var(--space-md);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: background 0.2s;
        }

        .search-result-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .search-result-name {
            font-weight: 500;
            color: var(--text-primary);
        }

        .search-result-code {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Badge Styles */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.625rem;
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: 9999px;
            text-transform: capitalize;
        }

        .badge-received,
        .badge-paid {
            background-color: rgba(16, 185, 129, 0.15);
            color: #10b981;
        }

        .badge-pending,
        .badge-partial {
            background-color: rgba(245, 158, 11, 0.15);
            color: #f59e0b;
        }

        .badge-ordered,
        .badge-unpaid {
            background-color: rgba(239, 68, 68, 0.15);
            color: #ef4444;
        }

        .excel-input-inline {
            width: 100%;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            padding: 8px;
            font-size: 0.875rem;
            outline: none;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .excel-input-inline:focus {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--primary);
        }

        .text-right {
            text-align: right;
        }

        .text-center {
            text-align: center;
        }

        .mb-md {
            margin-bottom: var(--space-md);
        }

        .mb-lg {
            margin-bottom: var(--space-lg);
        }

        .mt-md {
            margin-top: var(--space-md);
        }

        .excel-table th {
            color: var(--text-secondary);
            white-space: nowrap;
            position: sticky;
            top: 0;
            z-index: 10;
            backdrop-filter: blur(10px);
        }

        .excel-input {
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            padding: var(--space-sm) var(--space-md);
            font-family: 'Inter', sans-serif;
            font-size: 0.9375rem;
            min-height: 44px;
            border-radius: 4px;
            transition: all 0.2s ease;
            /* Touch friendly */
        }

        select.excel-input {
            appearance: none;
            -webkit-appearance: none;
            cursor: pointer;
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23FFFFFF%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat;
            background-position: right .7em top 50%;
            background-size: .65em auto;
            border-radius: 4px;
            /* Optional rounded */
        }

        select.excel-input option {
            background-color: #2a2a2a;
            /* Dark background for options */
            color: #fff;
        }

        .excel-input:focus {
            outline: 2px solid var(--primary);
            background: rgba(255, 255, 255, 0.05);
            z-index: 10;
            position: relative;
        }

        /* Stacked Row Styles */
        .stacked-row {
            display: flex;
            flex-direction: column;
            border-bottom: 8px solid rgba(255, 255, 255, 0.05);
            background: var(--bg-secondary);
            margin-bottom: var(--space-md);
            border-radius: var(--radius-md);
            overflow: hidden;
        }

        .stacked-line {
            display: flex;
            flex-wrap: wrap;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .stacked-line:last-child {
            border-bottom: none;
        }

        .grid-field {
            flex: 1;
            min-width: 150px;
            display: flex;
            flex-direction: column;
            border-right: 1px solid rgba(255, 255, 255, 0.05);
        }

        .grid-field:last-child {
            border-right: none;
        }

        .stacked-row.active {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.08);
            /* var(--primary) with opacity */
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
            transition: all 0.2s ease;
        }

        .grid-field.active {
            background: rgba(99, 102, 241, 0.05);
            border: 1px solid var(--primary);
        }

        .field-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            color: var(--text-muted);
            padding: 4px 12px 0;
            font-weight: 700;
        }

        /* Barcode Tags */
        .barcode-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            padding: 4px 12px;
            min-height: 44px;
            align-items: center;
        }

        .barcode-tag {
            background: var(--primary);
            color: white;
            padding: 2px 8px;
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .barcode-tag i {
            cursor: pointer;
            font-size: 0.7rem;
        }

        /* Bottom Sticky Toolbar */
        .bottom-toolbar {
            position: fixed;
            bottom: 0;
            left: 260px;
            /* Sidebar width */
            right: 0;
            background: var(--bg-secondary);
            padding: var(--space-md) var(--space-xl);
            display: flex;
            justify-content: flex-end;
            gap: var(--space-md);
            box-shadow: 0 -10px 20px rgba(0, 0, 0, 0.3);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        /* Adjust content for toolbar */
        #view-products,
        #view-purchase-manager,
        #view-purchase-add {
            padding-bottom: 150px;
        }

        /* Touch Optimization Highlighting */
        .excel-input.touch-locked {
            /* Visual cue implies read-only state */
            cursor: pointer;
        }

        @media (max-width: 1200px) {
            .bottom-toolbar {
                left: 0;
            }
        }

        .btn-large {
            height: 54px;
            padding: 0 30px;
            font-size: 1rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Read-only margin */
        .margin-input {
            font-weight: 700 !important;
            color: #10b981 !important;
            /* success green */
        }

        .excel-tr:hover td {
            background: rgba(255, 255, 255, 0.02);
        }

        .excel-tr.new-row td {
            background: rgba(99, 102, 241, 0.05);
        }

        .excel-tr.modified td::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 0 6px 6px 0;
            border-color: transparent var(--warning) transparent transparent;
        }

        .action-cell {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            padding: 0 5px;
        }

        .btn-icon {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 5px;
            font-size: 1rem;
            transition: color 0.2s;
        }

        .btn-icon:hover {
            color: var(--error);
        }

        /* Toolbar */
        .grid-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-md);
            flex-wrap: wrap;
            gap: var(--space-md);
        }

        .hidden {
            display: none !important;
        }

        /* Touch Optimization Highlighting */
        @media (pointer: coarse) {
            .excel-input {
                min-height: 50px;
                /* Even larger for touch */
                font-size: 1rem;
            }
        }

        /* Sync Status Styles */
        .sync-status {
            font-size: 0.75rem;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .status-success {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
        }

        .status-warning {
            background: rgba(245, 158, 11, 0.1);
            color: #f59e0b;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }

            100% {
                opacity: 1;
            }
        }
    </style>
</head>

<body>
    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Dashboard Layout -->
    <div class="dashboard-layout">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <!-- Sidebar Header -->
            <div class="sidebar-header">
                <a href="admin-dashboard.html" class="sidebar-logo">
                    <i class="fas fa-cash-register"></i>
                    <span>POS System</span>
                </a>
            </div>

            <!-- Sidebar Navigation -->
            <nav class="sidebar-nav">
                <!-- Main Section -->
                <div class="nav-section">
                    <div class="nav-section-title">Main</div>
                    <ul class="nav-menu">
                        <li class="nav-item">
                            <a href="#" class="nav-link active" onclick="switchView(''); return false;">
                                <i class="fas fa-th-large"></i>
                                <span>Dashboard</span>
                            </a>
                        </li>
                    </ul>
                </div>

                <!-- Inventory Section -->
                <div class="nav-section">
                    <div class="nav-section-title">Inventory</div>
                    <ul class="nav-menu">
                        <li class="nav-item has-submenu">
                            <a href="#" class="nav-link dropdown-toggle">
                                <div style="display:flex; align-items:center; gap:var(--space-md); flex:1;">
                                    <i class="fas fa-boxes"></i>
                                    <span>Products</span>
                                </div>
                                <i class="fas fa-chevron-right nav-arrow"></i>
                            </a>
                            <ul class="submenu">
                                <li class="nav-item">
                                    <a href="#" class="nav-link" onclick="switchView('products'); return false;">Product
                                        Manager</a>
                                </li>
                                <li class="nav-item">
                                    <a href="#" class="nav-link"
                                        onclick="switchView('products', 'add'); return false;">Add Product</a>
                                </li>
                                <li class="nav-item">
                                    <a href="#" class="nav-link"
                                        onclick="switchView('categories'); return false;">Product Categories</a>
                                </li>
                                <li class="nav-item">
                                    <a href="#" class="nav-link"
                                        onclick="switchView('variations'); return false;">Variations</a>
                                </li>
                                <li class="nav-item">
                                    <a href="#" class="nav-link"
                                        onclick="switchView('brands'); return false;">Brands</a>
                                </li>
                                <li class="nav-item">
                                    <a href="#" class="nav-link" onclick="switchView('units'); return false;">Units</a>
                                </li>
                                <li class="nav-item">
                                    <a href="#" class="nav-link" onclick="switchView('barcodes'); return false;">Print
                                        Barcode</a>
                                </li>
                            </ul>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link" onclick="switchView('adjustments'); return false;">
                                <i class="fas fa-sliders-h"></i>
                                <span>Adjustments</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link" onclick="switchView('warehouses'); return false;">
                                <i class="fas fa-warehouse"></i>
                                <span>Warehouse</span>
                            </a>
                        </li>
                    </ul>
                </div>

                <!-- Sales & Purchases Section -->
                <div class="nav-section">
                    <div class="nav-section-title">Transactions</div>
                    <ul class="nav-menu">
                        <li class="nav-item">
                            <a href="#" class="nav-link">
                                <i class="fas fa-file-invoice"></i>
                                <span>Quotations</span>
                            </a>
                        </li>
                        <li class="nav-item has-submenu">
                            <a href="#" class="nav-link dropdown-toggle">
                                <div style="display:flex; align-items:center; gap:var(--space-md); flex:1;">
                                    <i class="fas fa-shopping-cart"></i>
                                    <span>Purchases</span>
                                </div>
                                <i class="fas fa-chevron-right nav-arrow"></i>
                            </a>
                            <ul class="submenu">
                                <li class="nav-item">
                                    <a href="#" class="nav-link"
                                        onclick="switchView('purchase-manager'); return false;">Purchase List</a>
                                </li>
                                <li class="nav-item">
                                    <a href="#" class="nav-link" onclick="switchView('purchase-add'); return false;">Add
                                        Purchase</a>
                                </li>
                                <li class="nav-item">
                                    <a href="#" class="nav-link"
                                        onclick="switchView('purchase-return'); return false;">Purchase Return</a>
                                </li>
                            </ul>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link">
                                <i class="fas fa-cash-register"></i>
                                <span>Sales</span>
                                <span class="nav-badge">NEW</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link">
                                <i class="fas fa-exchange-alt"></i>
                                <span>Transfers</span>
                            </a>
                        </li>
                    </ul>
                </div>

                <!-- Finance Section -->
                <div class="nav-section">
                    <div class="nav-section-title">Finance</div>
                    <ul class="nav-menu">
                        <li class="nav-item">
                            <a href="#" class="nav-link">
                                <i class="fas fa-receipt"></i>
                                <span>Expenses</span>
                            </a>
                        </li>
                    </ul>
                </div>

                <!-- People Section -->
                <div class="nav-section">
                    <div class="nav-section-title">People</div>
                    <ul class="nav-menu">
                        <li class="nav-item">
                            <a href="#" class="nav-link">
                                <i class="fas fa-users"></i>
                                <span>Peoples</span>
                            </a>
                        </li>
                        <li class="nav-item" data-permissions="admin">
                            <a href="#" class="nav-link" onclick="switchView('users')">
                                <i class="fas fa-users-cog"></i>
                                <span>User Management</span>
                            </a>
                        </li>
                    </ul>
                </div>

                <!-- Reports Section -->
                <div class="nav-section" data-permissions="admin,manager">
                    <div class="nav-section-title">Analytics</div>
                    <ul class="nav-menu">
                        <li class="nav-item">
                            <a href="#" class="nav-link">
                                <i class="fas fa-chart-bar"></i>
                                <span>Reports</span>
                            </a>
                        </li>
                    </ul>
                </div>

                <!-- Settings Section -->
                <div class="nav-section" data-permissions="admin">
                    <div class="nav-section-title">Settings</div>
                    <ul class="nav-menu">
                        <li class="nav-item">
                            <a href="#" class="nav-link">
                                <i class="fas fa-dollar-sign"></i>
                                <span>Currencies</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link">
                                <i class="fas fa-language"></i>
                                <span>Languages</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link">
                                <i class="fas fa-file-alt"></i>
                                <span>Templates</span>
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>
        </aside>

        <!-- Main Content Wrapper -->
        <div class="main-wrapper">
            <!-- Top Navbar -->
            <nav class="top-navbar">
                <div class="navbar-left">
                    <button class="menu-toggle" id="menuToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 class="page-title-nav">Dashboard</h1>
                </div>

                <div class="navbar-right">
                    <!-- Search Bar -->
                    <div class="navbar-search">
                        <i class="fas fa-search"></i>
                        <input type="text" id="globalSearchInput" placeholder="Search (Ctrl + /)...">
                    </div>

                    <!-- Navbar Icons -->
                    <div class="navbar-icons">
                        <button class="navbar-icon">
                            <i class="fas fa-bell"></i>
                            <span class="badge">3</span>
                        </button>
                        <button class="navbar-icon">
                            <i class="fas fa-envelope"></i>
                            <span class="badge">5</span>
                        </button>
                        <button class="navbar-icon" onclick="toggleFullscreen()" title="Fullscreen Mode">
                            <i class="fas fa-expand"></i>
                        </button>
                    </div>

                    <!-- User Menu -->
                    <div class="user-menu">
                        <div class="user-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="user-details">
                            <div class="user-name-nav" id="userName">Admin</div>
                            <div class="user-role-nav" id="userRole">Administrator</div>
                        </div>
                        <button class="btn btn-secondary btn-sm" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </div>
            </nav>

            <!-- Dashboard Content -->
            <main class="dashboard-content">
                <!-- Dashboard View -->
                <div id="view-dashboard">
                    <!-- Page Header -->
                    <div class="page-header">
                        <h1 class="page-title">Admin Dashboard</h1>
                        <p class="page-subtitle">Welcome back! Here's what's happening today.</p>
                    </div>

                    <!-- Stats Grid -->
                    <div class="stats-grid">
                        <div class="stat-card fade-in" data-permissions="admin,manager">
                            <div class="stat-header">
                                <div>
                                    <div class="stat-label">Total Sales Today</div>
                                    <div class="stat-value" id="todaySales">$0.00</div>
                                    <div class="stat-change positive">
                                        <i class="fas fa-arrow-up"></i> 12.5% from yesterday
                                    </div>
                                </div>
                                <div class="stat-icon">
                                    <i class="fas fa-dollar-sign"></i>
                                </div>
                            </div>
                        </div>

                        <div class="stat-card fade-in" style="animation-delay: 0.1s" data-permissions="admin,manager">
                            <div class="stat-header">
                                <div>
                                    <div class="stat-label">Transactions</div>
                                    <div class="stat-value" id="transactionCount">0</div>
                                    <div class="stat-change positive">
                                        <i class="fas fa-arrow-up"></i> 8 new today
                                    </div>
                                </div>
                                <div class="stat-icon">
                                    <i class="fas fa-receipt"></i>
                                </div>
                            </div>
                        </div>

                        <div class="stat-card fade-in" style="animation-delay: 0.2s">
                            <div class="stat-header">
                                <div>
                                    <div class="stat-label">Products</div>
                                    <div class="stat-value" id="productCount">0</div>
                                    <div class="stat-change">
                                        <i class="fas fa-box"></i> In stock
                                    </div>
                                </div>
                                <div class="stat-icon">
                                    <i class="fas fa-boxes"></i>
                                </div>
                            </div>
                        </div>

                        <div class="stat-card fade-in" style="animation-delay: 0.3s" data-permissions="admin">
                            <div class="stat-header">
                                <div>
                                    <div class="stat-label">Active Users</div>
                                    <div class="stat-value" id="userCount">0</div>
                                    <div class="stat-change">
                                        <i class="fas fa-users"></i> Total users
                                    </div>
                                </div>
                                <div class="stat-icon">
                                    <i class="fas fa-user-friends"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Content Grid -->
                    <div class="content-grid">
                        <!-- Recent Transactions -->
                        <div class="table-container fade-in" style="animation-delay: 0.4s">
                            <div class="table-header">
                                <h3 class="table-title">Recent Transactions</h3>
                                <button class="btn btn-primary btn-sm">
                                    <i class="fas fa-eye"></i> View All
                                </button>
                            </div>

                            <table id="transactionsTable">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Date</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="transactionsBody">
                                    <tr>
                                        <td colspan="4" class="text-center text-muted">
                                            <i class="fas fa-inbox"></i> No transactions yet
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Quick Actions -->
                        <div class="quick-actions fade-in" style="animation-delay: 0.5s">
                            <h3 class="table-title mb-lg">Quick Actions</h3>

                            <button class="btn btn-primary action-btn" onclick="switchView('products', 'add')">
                                <i class="fas fa-plus-circle"></i>
                                Add New Product
                            </button>

                            <button class="btn btn-primary action-btn" onclick="switchView('products')">
                                <i class="fas fa-boxes"></i>
                                Manage Products
                            </button>

                            <button class="btn btn-primary action-btn" onclick="viewTransactions()">
                                <i class="fas fa-file-invoice"></i>
                                View All Transactions
                            </button>

                            <button class="btn btn-primary action-btn" onclick="manageUsers()">
                                <i class="fas fa-users-cog"></i>
                                Manage Users
                            </button>

                            <button class="btn btn-success action-btn" onclick="openPOS()">
                                <i class="fas fa-cash-register"></i>
                                Open POS
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Product Manager View -->
                <div id="view-products" class="hidden">
                    <!-- Toolbar -->
                    <div class="grid-toolbar">
                        <div style="display: flex; align-items: center; gap: var(--space-md);">
                            <h1 class="page-title" style="margin:0;">Product Manager</h1>
                            <span id="syncStatus" class="sync-status">Synced to Supabase</span>
                        </div>

                        <div style="display: flex; gap: var(--space-sm);">
                            <button class="btn btn-secondary" onclick="loadProducts(true)">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                            <button class="btn btn-primary" onclick="addNewRow()">
                                <i class="fas fa-plus"></i> Add Row
                            </button>
                            <button class="btn btn-success" onclick="saveAllChanges()" id="saveBtn">
                                <i class="fas fa-save"></i> Save Changes
                            </button>
                        </div>
                    </div>

                    <!-- Grid Headers (Hidden on Mobile/Tablet but useful for desktop) -->
                    <div id="grid-header-labels" class="hidden">
                        <!-- We might not need these in stacked mode -->
                    </div>

                    <!-- Stacked Grid Container -->
                    <div class="excel-grid-container fade-in" id="stacked-grid-container"
                        style="border:none; background:transparent; max-height: calc(100vh - 250px);">
                        <div id="productsBody">
                            <!-- Stacked Rows will be populated here -->
                        </div>
                    </div>

                    <!-- Bottom Anchored Toolbar -->
                    <div class="bottom-toolbar">
                        <button class="btn btn-secondary btn-large" onclick="openExcelImport()">
                            <i class="fas fa-file-import"></i> Import Excel
                        </button>
                        <button class="btn btn-secondary btn-large" onclick="exportToExcel()">
                            <i class="fas fa-file-export"></i> Export Excel
                        </button>
                        <button class="btn btn-danger btn-large" onclick="deleteSelectedProducts()">
                            <i class="fas fa-trash-alt"></i> Delete
                        </button>
                        <button class="btn btn-success btn-large" onclick="saveAllChanges()" id="saveBtnBottom">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                    </div>
                </div>

                <!-- Categories Manager View -->
                <div id="view-categories" class="hidden">
                    <!-- Toolbar -->
                    <div class="grid-toolbar">
                        <div style="display: flex; align-items: center; gap: var(--space-md);">
                            <h1 class="page-title" style="margin:0;">Category Manager</h1>
                            <span id="syncStatusCategories" class="sync-status">Synced to Supabase</span>
                        </div>

                        <div style="display: flex; gap: var(--space-sm);">
                            <button class="btn btn-secondary" onclick="loadCategories()">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                            <button class="btn btn-success" onclick="saveCategoryChanges()" id="saveCategoriesBtn">
                                <i class="fas fa-save"></i> Save Changes
                            </button>
                        </div>
                    </div>

                    <!-- Tab Navigation -->
                    <div
                        style="display: flex; gap: var(--space-sm); margin-bottom: var(--space-lg); border-bottom: 2px solid rgba(255,255,255,0.1);">
                        <button class="btn btn-secondary" id="mainCategoriesTab" onclick="switchCategoryTab('main')"
                            style="border-radius: var(--radius-md) var(--radius-md) 0 0; border-bottom: 3px solid var(--primary);">
                            <i class="fas fa-layer-group"></i> Main Categories
                        </button>
                        <button class="btn btn-secondary" id="subcategoriesTab" onclick="switchCategoryTab('sub')"
                            style="border-radius: var(--radius-md) var(--radius-md) 0 0;">
                            <i class="fas fa-sitemap"></i> Subcategories
                        </button>
                    </div>

                    <!-- Main Categories Table -->
                    <div id="mainCategoriesView">
                        <div class="excel-grid-container fade-in">
                            <table class="excel-table" id="categoriesGrid">
                                <thead>
                                    <tr>
                                        <th style="width: 40px;"></th>
                                        <th>Name *</th>
                                        <th>Description</th>
                                        <th style="width: 50px;"></th>
                                    </tr>
                                </thead>
                                <tbody id="categoriesBody">
                                    <!-- Rows populated by JS -->
                                </tbody>
                            </table>
                        </div>
                        <button class="btn btn-primary" onclick="addNewCategory()" style="margin-top: var(--space-md);">
                            <i class="fas fa-plus"></i> Add Category
                        </button>
                    </div>

                    <!-- Subcategories Table -->
                    <div id="subcategoriesView" class="hidden">
                        <div class="excel-grid-container fade-in">
                            <table class="excel-table" id="subcategoriesGrid">
                                <thead>
                                    <tr>
                                        <th style="width: 40px;"></th>
                                        <th>Main Category *</th>
                                        <th>Subcategory Name *</th>
                                        <th>Description</th>
                                        <th style="width: 50px;"></th>
                                    </tr>
                                </thead>
                                <tbody id="subcategoriesBody">
                                    <!-- Rows populated by JS -->
                                </tbody>
                            </table>
                        </div>
                        <button class="btn btn-primary" onclick="addNewSubcategory()"
                            style="margin-top: var(--space-md);">
                            <i class="fas fa-plus"></i> Add Subcategory
                        </button>
                    </div>
                </div>

                <!-- Variations Manager View -->
                <div id="view-variations" class="hidden">
                    <!-- Toolbar -->
                    <div class="grid-toolbar">
                        <h1 class="page-title" style="margin:0;">Variation Manager</h1>

                        <div style="display: flex; gap: var(--space-sm);">
                            <button class="btn btn-secondary" onclick="loadVariations()">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                            <button class="btn btn-success" onclick="saveVariationChanges()" id="saveVariationsBtn">
                                <i class="fas fa-save"></i> Save Changes
                            </button>
                        </div>
                    </div>

                    <!-- Tab Navigation -->
                    <div
                        style="display: flex; gap: var(--space-sm); margin-bottom: var(--space-lg); border-bottom: 2px solid rgba(255,255,255,0.1);">
                        <button class="btn btn-secondary" id="variationTypesTab" onclick="switchVariationTab('types')"
                            style="border-radius: var(--radius-md) var(--radius-md) 0 0; border-bottom: 3px solid var(--primary);">
                            <i class="fas fa-tags"></i> Variation Types
                        </button>
                        <button class="btn btn-secondary" id="variationOptionsTab"
                            onclick="switchVariationTab('options')"
                            style="border-radius: var(--radius-md) var(--radius-md) 0 0;">
                            <i class="fas fa-list-ol"></i> Variation Options
                        </button>
                    </div>

                    <!-- Variation Types Table -->
                    <div id="variationTypesView">
                        <div class="excel-grid-container fade-in">
                            <table class="excel-table" id="variationTypesGrid">
                                <thead>
                                    <tr>
                                        <th style="width: 40px;"></th>
                                        <th>Type Name *</th>
                                        <th>Description</th>
                                        <th style="width: 50px;"></th>
                                    </tr>
                                </thead>
                                <tbody id="variationTypesBody">
                                    <!-- Rows populated by JS -->
                                </tbody>
                            </table>
                        </div>
                        <button class="btn btn-primary" onclick="addNewVariationType()"
                            style="margin-top: var(--space-md);">
                            <i class="fas fa-plus"></i> Add Type
                        </button>
                    </div>

                    <!-- Variation Options Table -->
                    <div id="variationOptionsView" class="hidden">
                        <div class="excel-grid-container fade-in">
                            <table class="excel-table" id="variationOptionsGrid">
                                <thead>
                                    <tr>
                                        <th style="width: 40px;"></th>
                                        <th>Variation Type *</th>
                                        <th>Option Value *</th>
                                        <th style="width: 50px;"></th>
                                    </tr>
                                </thead>
                                <tbody id="variationOptionsBody">
                                    <!-- Rows populated by JS -->
                                </tbody>
                            </table>
                        </div>
                        <button class="btn btn-primary" onclick="addNewVariationOption()"
                            style="margin-top: var(--space-md);">
                            <i class="fas fa-plus"></i> Add Option
                        </button>
                    </div>
                </div>

                <!-- Brands Manager View -->
                <div id="view-brands" class="hidden">
                    <div class="grid-toolbar">
                        <div style="display: flex; align-items: center; gap: var(--space-md);">
                            <h1 class="page-title" style="margin:0;">Brand Manager</h1>
                            <span id="syncStatusBrands" class="sync-status">Synced to Supabase</span>
                        </div>
                        <div style="display: flex; gap: var(--space-sm);">
                            <button class="btn btn-secondary" onclick="loadBrands()"><i class="fas fa-sync-alt"></i>
                                Refresh</button>
                            <button class="btn btn-success" onclick="saveBrandChanges()"><i class="fas fa-save"></i>
                                Save Changes</button>
                        </div>
                    </div>
                    <div class="excel-grid-container fade-in">
                        <table class="excel-table" id="brandsGrid">
                            <thead>
                                <tr>
                                    <th style="width: 40px;"></th>
                                    <th>Brand Name *</th>
                                    <th>Description</th>
                                    <th>Website</th>
                                    <th style="width: 50px;"></th>
                                </tr>
                            </thead>
                            <tbody id="brandsBody">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                    <button class="btn btn-primary" onclick="addNewBrand()" style="margin-top: var(--space-md);"><i
                            class="fas fa-plus"></i> Add Brand</button>
                </div>

                <!-- Units Manager View -->
                <div id="view-units" class="hidden">
                    <div class="grid-toolbar">
                        <div style="display: flex; align-items: center; gap: var(--space-md);">
                            <h1 class="page-title" style="margin:0;">Unit Manager</h1>
                            <span id="syncStatusUnits" class="sync-status">Synced to Supabase</span>
                        </div>
                        <div style="display: flex; gap: var(--space-sm);">
                            <button class="btn btn-secondary" onclick="loadUnits()"><i class="fas fa-sync-alt"></i>
                                Refresh</button>
                            <button class="btn btn-success" onclick="saveUnitChanges()"><i class="fas fa-save"></i> Save
                                Changes</button>
                        </div>
                    </div>
                    <div class="excel-grid-container fade-in">
                        <table class="excel-table" id="unitsGrid">
                            <thead>
                                <tr>
                                    <th style="width: 40px;"></th>
                                    <th>Unit Name * (e.g. Kilogram)</th>
                                    <th>Short Name * (e.g. kg)</th>
                                    <th style="width: 120px; text-align: center;">Allow Decimals</th>
                                    <th style="width: 50px;"></th>
                                </tr>
                            </thead>
                            <tbody id="unitsBody">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                    <button class="btn btn-primary" onclick="addNewUnit()" style="margin-top: var(--space-md);"><i
                            class="fas fa-plus"></i> Add Unit</button>
                </div>

                <!-- Purchase Manager View -->
                <div id="view-purchase-manager" class="hidden">
                    <div class="grid-toolbar">
                        <div style="display: flex; align-items: center; gap: var(--space-md);">
                            <h1 class="page-title" style="margin:0;">Purchase List</h1>
                            <span id="syncStatusPurchases" class="sync-status status-success">Synced to Supabase</span>
                        </div>
                        <div style="display: flex; gap: var(--space-sm);">
                            <button class="btn btn-secondary" onclick="loadPurchases()"><i class="fas fa-sync-alt"></i>
                                Refresh</button>
                            <button class="btn btn-primary" onclick="switchView('purchase-add')"><i
                                    class="fas fa-plus"></i> Add Purchase</button>
                        </div>
                    </div>

                    <div class="excel-grid-container fade-in" id="purchase-grid-container"
                        style="border:none; background:transparent; max-height: calc(100vh - 250px);">
                        <div id="purchaseBody">
                            <!-- Stacked Rows will be populated here -->
                        </div>
                    </div>

                    <!-- Bottom Toolbar -->
                    <div class="bottom-toolbar">
                        <button class="btn btn-secondary btn-large" onclick="loadPurchases()">
                            <i class="fas fa-sync-alt"></i> Refresh List
                        </button>
                        <button class="btn btn-primary btn-large" onclick="switchView('purchase-add')">
                            <i class="fas fa-plus"></i> New Purchase
                        </button>
                    </div>
                </div>

                <!-- Add Purchase View -->
                <div id="view-purchase-add" class="hidden">
                    <div class="grid-toolbar">
                        <h1 class="page-title" style="margin:0;">Add Purchase</h1>
                        <div style="display: flex; gap: var(--space-sm);">
                            <button class="btn btn-secondary" onclick="switchView('purchase-manager')"><i
                                    class="fas fa-arrow-left"></i> Back</button>
                            <button class="btn btn-success" onclick="savePurchase()"><i class="fas fa-save"></i> Save
                                Purchase</button>
                        </div>
                    </div>

                    <div class="form-grid fade-in"
                        style="display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--space-md); margin-bottom: var(--space-lg);">
                        <div class="form-group">
                            <label>Date:</label>
                            <input type="date" id="purchaseAddDate" class="excel-input" value="2026-02-10">
                        </div>
                        <div class="form-group">
                            <label>Warehouse:</label>
                            <select id="purchaseAddWarehouse" class="excel-input">
                                <option value="">Choose Warehouse</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Supplier:</label>
                            <select id="purchaseAddSupplier" class="excel-input">
                                <option value="">Choose Supplier</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group mb-lg">
                        <label>Product:</label>
                        <div style="position: relative;">
                            <input type="text" id="purchaseProductSearch" class="excel-input"
                                placeholder="Search Product by Code or Name" oninput="searchProductsForPurchase(this)">
                            <div id="purchaseSearchDropdown" class="search-dropdown hidden"></div>
                        </div>
                    </div>

                    <div class="excel-grid-container"
                        style="border:none; background:transparent; margin-bottom: var(--space-xl);">
                        <h3 class="table-title mb-md" style="padding-left: 10px;">Order Items:</h3>
                        <div id="purchaseAddItemsBody">
                            <!-- Styled like stacked-row -->
                            <div class="text-center text-muted"
                                style="padding: 40px; background: var(--bg-secondary); border-radius: var(--radius-md);">
                                <i class="fas fa-shopping-basket fa-3x mb-md" style="opacity: 0.2;"></i>
                                <p>No products added. Use the search bar above to add items.</p>
                            </div>
                        </div>

                        <!-- Totals Section Styled as a Card -->
                        <div class="stat-card" style="margin-top: var(--space-md);">
                            <div class="table-container" style="background: transparent; border: none; padding: 0;">
                                <table class="excel-table" style="border: none;">
                                    <tbody>
                                        <tr>
                                            <td class="text-right" style="border: none; padding: 8px;">Order Tax</td>
                                            <td style="border: none; padding: 8px; width: 200px;"><span
                                                    id="summaryOrderTax">0.00 Ks (0.00) %</span></td>
                                        </tr>
                                        <tr>
                                            <td class="text-right" style="border: none; padding: 8px;">Discount</td>
                                            <td style="border: none; padding: 8px;"><span id="summaryDiscount">0.00
                                                    Ks</span></td>
                                        </tr>
                                        <tr>
                                            <td class="text-right" style="border: none; padding: 8px;">Shipping</td>
                                            <td style="border: none; padding: 8px;"><span id="summaryShipping">0.00
                                                    Ks</span></td>
                                        </tr>
                                        <tr>
                                            <td class="text-right"
                                                style="border: none; padding: 8px; font-weight: 900; font-size: 1.2rem; color: var(--primary-light);">
                                                Grand Total</td>
                                            <td
                                                style="border: none; padding: 8px; font-weight: 900; font-size: 1.2rem; color: var(--primary-light);">
                                                <span id="summaryGrandTotal">0.00 Ks</span>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="text-right"
                                                style="border: none; padding: 8px; font-weight: 600; color: #10b981;">
                                                Paid Amount</td>
                                            <td style="border: none; padding: 8px; font-weight: 600; color: #10b981;">
                                                <span id="summaryPaid">0.00 Ks</span>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="text-right"
                                                style="border: none; padding: 8px; font-weight: 600; color: var(--error);">
                                                Balance</td>
                                            <td
                                                style="border: none; padding: 8px; font-weight: 600; color: var(--error);">
                                                <span id="summaryBalance">0.00 Ks</span>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="form-grid"
                        style="display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--space-md); margin-bottom: var(--space-lg);">
                        <div class="form-group">
                            <label>Order Tax (%):</label>
                            <input type="number" id="purchaseOrderTax" class="excel-input" value="0.00"
                                oninput="calculatePurchaseTotals()">
                        </div>
                        <div class="form-group">
                            <label>Discount (Ks):</label>
                            <input type="number" id="purchaseDiscount" class="excel-input" value="0.00"
                                oninput="calculatePurchaseTotals()">
                        </div>
                        <div class="form-group">
                            <label>Shipping (Ks):</label>
                            <input type="number" id="purchaseShipping" class="excel-input" value="0.00"
                                oninput="calculatePurchaseTotals()">
                        </div>
                        <div class="form-group">
                            <label>Status:</label>
                            <select id="purchaseStatus" class="excel-input">
                                <option value="Received">Received</option>
                                <option value="Pending">Pending</option>
                                <option value="Ordered">Ordered</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Payment Type:</label>
                            <select id="purchasePaymentType" class="excel-input">
                                <option value="Cash">Cash</option>
                                <option value="Bank Transfer">Bank Transfer</option>
                                <option value="Credit Card">Credit Card</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Payment Status:</label>
                            <select id="purchasePaymentStatus" class="excel-input" onchange="updatePaymentVisibility()">
                                <option value="Unpaid">Unpaid</option>
                                <option value="Paid">Paid</option>
                                <option value="Partial">Partial</option>
                            </select>
                        </div>
                        <div class="form-group hidden" id="purchasePaidAmountGroup">
                            <label style="color: #10b981; font-weight: 700;">Paid Amount (Ks):</label>
                            <input type="number" id="purchasePaidAmount" class="excel-input" value="0.00"
                                style="border-color: #10b981;" oninput="calculatePurchaseTotals()">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Note:</label>
                        <textarea id="purchaseNote" class="excel-input" style="height: 100px; resize: none;"></textarea>
                    </div>

                    <!-- Bottom Toolbar -->
                    <div class="bottom-toolbar">
                        <button class="btn btn-secondary btn-large" onclick="switchView('purchase-manager')">
                            <i class="fas fa-arrow-left"></i> Back to List
                        </button>
                        <button class="btn btn-success btn-large" onclick="savePurchase()">
                            <i class="fas fa-save"></i> Complete Purchase
                        </button>
                    </div>
                </div>

                <!-- Purchase Return View -->
                <div id="view-purchase-return" class="hidden">
                    <div class="grid-toolbar">
                        <div style="display: flex; align-items: center; gap: var(--space-md);">
                            <h1 class="page-title" style="margin:0;">Purchase Returns</h1>
                            <span class="sync-status status-success">Synced to Supabase</span>
                        </div>
                        <div style="display: flex; gap: var(--space-sm);">
                            <button class="btn btn-secondary" onclick="loadPurchaseReturns()"><i
                                    class="fas fa-sync-alt"></i> Refresh</button>
                            <button class="btn btn-primary" onclick="switchView('purchase-return-add')">
                                <i class="fas fa-plus"></i> Add Return
                            </button>
                        </div>
                    </div>

                    <div class="excel-grid-container fade-in" id="purchase-return-grid-container"
                        style="border:none; background:transparent; max-height: calc(100vh - 250px);">
                        <div id="purchaseReturnBody">
                            <!-- Populated by JS -->
                        </div>
                    </div>

                    <!-- Bottom Toolbar -->
                    <div class="bottom-toolbar">
                        <button class="btn btn-secondary btn-large" onclick="loadPurchaseReturns()">
                            <i class="fas fa-sync-alt"></i> Refresh returns
                        </button>
                    </div>
                </div>

                <!-- Add Purchase Return View -->
                <div id="view-purchase-return-add" class="hidden">
                    <div class="grid-toolbar">
                        <h1 class="page-title" style="margin:0;">Add Purchase Return</h1>
                        <div style="display: flex; gap: var(--space-sm);">
                            <button class="btn btn-secondary" onclick="switchView('purchase-return')"><i
                                    class="fas fa-arrow-left"></i> Back</button>
                            <button id="saveReturnBtn" class="btn btn-success" onclick="savePurchaseReturn()">
                                <i class="fas fa-save"></i> Save Return
                            </button>
                        </div>
                    </div>

                    <div class="form-grid fade-in"
                        style="display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--space-md); margin-bottom: var(--space-lg);">
                        <div class="form-group">
                            <label>Date:</label>
                            <input type="date" id="returnAddDate" class="excel-input">
                        </div>
                        <div class="form-group">
                            <label>Warehouse:</label>
                            <select id="returnAddWarehouse" class="excel-input">
                                <option value="">Choose Warehouse</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Supplier:</label>
                            <select id="returnAddSupplier" class="excel-input">
                                <option value="">Choose Supplier</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group mb-lg">
                        <label>Product:</label>
                        <div style="position: relative;">
                            <input type="text" id="returnProductSearch" class="excel-input"
                                placeholder="Search Product by Code or Name" oninput="searchProductsForReturn(this)">
                            <div id="returnSearchDropdown" class="search-dropdown hidden"></div>
                        </div>
                    </div>

                    <div class="excel-grid-container"
                        style="border:none; background:transparent; margin-bottom: var(--space-xl);">
                        <h3 class="table-title mb-md" style="padding-left: 10px;">Returned Items:</h3>
                        <div id="returnAddItemsBody">
                            <div class="text-center text-muted"
                                style="padding: 40px; background: var(--bg-secondary); border-radius: var(--radius-md);">
                                <i class="fas fa-undo fa-3x mb-md" style="opacity: 0.2;"></i>
                                <p>No products added. Use the search bar above to add items for return.</p>
                            </div>
                        </div>

                        <!-- Totals Section -->
                        <div class="stat-card" style="margin-top: var(--space-md);">
                            <div class="table-container" style="background: transparent; border: none; padding: 0;">
                                <table class="excel-table" style="border: none;">
                                    <tbody>
                                        <tr>
                                            <td class="text-right" style="border: none; padding: 8px;">Order Tax (%)
                                            </td>
                                            <td style="border: none; padding: 8px; width: 200px;">
                                                <input type="number" id="returnOrderTax" class="excel-input"
                                                    value="0.00" oninput="calculateReturnTotals()">
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="text-right" style="border: none; padding: 8px;">Discount</td>
                                            <td style="border: none; padding: 8px;">
                                                <input type="number" id="returnDiscount" class="excel-input"
                                                    value="0.00" oninput="calculateReturnTotals()">
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="text-right" style="border: none; padding: 8px;">Shipping</td>
                                            <td style="border: none; padding: 8px;">
                                                <input type="number" id="returnShipping" class="excel-input"
                                                    value="0.00" oninput="calculateReturnTotals()">
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="text-right"
                                                style="border: none; padding: 8px; font-weight: 700; font-size: 1.1rem; color: var(--primary-light);">
                                                Grand Total</td>
                                            <td id="returnSummaryGrandTotal"
                                                style="border: none; padding: 8px; font-weight: 800; font-size: 1.2rem; color: var(--primary-light);">
                                                0.00 Ks</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="form-group mb-xl">
                        <label>Return Note:</label>
                        <textarea id="returnNote" class="excel-input" style="height: 100px; resize: vertical;"
                            placeholder="Add any internal remarks here..."></textarea>
                    </div>
                </div>

                <!-- Stock Adjustment View -->
                <div id="view-adjustments" class="hidden">
                    <div class="grid-toolbar">
                        <div style="display: flex; align-items: center; gap: var(--space-md);">
                            <h1 class="page-title" style="margin:0;">Stock Adjustments</h1>
                            <span id="syncStatusAdjustments" class="sync-status status-success">Synced to
                                Supabase</span>
                        </div>
                        <div style="display: flex; gap: var(--space-sm);">
                            <button class="btn btn-secondary" onclick="loadAdjustments()"><i
                                    class="fas fa-sync-alt"></i> Refresh</button>
                            <button class="btn btn-primary" onclick="openAdjustmentModal()">
                                <i class="fas fa-plus"></i> New Adjustment
                            </button>
                        </div>
                    </div>

                    <div class="excel-grid-container fade-in" style="margin-top: var(--space-md);">
                        <table class="excel-table">
                            <thead>
                                <tr>
                                    <th style="width: 180px;">Date & Time</th>
                                    <th>Product</th>
                                    <th>Type</th>
                                    <th style="width: 100px; text-align: center;">Quantity</th>
                                    <th>Reason</th>
                                </tr>
                            </thead>
                            <tbody id="adjustmentsBody">
                                <!-- Populated by JS -->
                                <tr>
                                    <td colspan="5" class="text-center text-muted" style="padding: 40px;">
                                        <i class="fas fa-history fa-3x mb-md" style="opacity: 0.1;"></i>
                                        <p>No adjustments recorded yet.</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Stock Adjustment Modal -->
                <div id="adjustmentModal" class="modal-overlay hidden">
                    <div class="modal-content" style="max-width: 500px;">
                        <div class="modal-header">
                            <h3 class="modal-title">New Stock Adjustment</h3>
                            <button class="btn-icon" onclick="closeAdjustmentModal()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body" style="padding: var(--space-lg);">
                            <form id="adjustmentForm" onsubmit="handleSaveAdjustment(event)">
                                <div class="form-group">
                                    <label class="field-label">Select Product *</label>
                                    <select id="adjProduct" class="excel-input" required></select>
                                </div>
                                <div class="form-grid"
                                    style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-md); margin-top: var(--space-md);">
                                    <div class="form-group">
                                        <label class="field-label">Type *</label>
                                        <select id="adjType" class="excel-input" required>
                                            <option value="Damage">Damage (-)</option>
                                            <option value="Theft">Theft (-)</option>
                                            <option value="Return to Vendor">Return to Vendor (-)</option>
                                            <option value="Entry Error">Entry Error (Subtract)</option>
                                            <option value="Addition">Stock Addition (+)</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="field-label">Quantity *</label>
                                        <input type="number" id="adjQuantity" class="excel-input" required min="1"
                                            placeholder="e.g. 5">
                                        <small style="color: var(--text-muted); font-size: 0.7rem;">Enter a positive
                                            number</small>
                                    </div>
                                </div>
                                <div class="form-group" style="margin-top: var(--space-md);">
                                    <label class="field-label">Reason / Remark</label>
                                    <textarea id="adjReason" class="excel-input" style="height: 80px; resize: none;"
                                        placeholder="Provide details..."></textarea>
                                </div>
                                <div
                                    style="margin-top: var(--space-xl); display: flex; justify-content: flex-end; gap: var(--space-md);">
                                    <button type="button" class="btn btn-secondary"
                                        onclick="closeAdjustmentModal()">Cancel</button>
                                    <button type="submit" id="saveAdjBtn" class="btn btn-primary">Save
                                        Adjustment</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Barcode Printing View -->
                <div id="view-barcodes" class="hidden">
                    <div class="page-header">
                        <h1 class="page-title">Print Barcode Labels</h1>
                        <p class="page-subtitle">Search products and add to print queue</p>
                    </div>

                    <div class="grid-toolbar">
                        <div style="display: flex; gap: var(--space-md); flex: 1; flex-wrap: wrap;">
                            <div class="navbar-search"
                                style="flex: 2; min-width: 300px; margin: 0; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);">
                                <i class="fas fa-search"></i>
                                <input type="text" id="barcodeProductSearch" placeholder="Search product to add..."
                                    oninput="searchProductsForBarcode(this.value)">
                                <div id="barcodeSearchResults" class="search-results-dropdown hidden"></div>
                            </div>

                            <div
                                style="display: flex; gap: var(--space-sm); align-items: center; background: rgba(255,255,255,0.05); padding: 5px 15px; border-radius: var(--radius-sm); border: 1px solid rgba(255,255,255,0.1);">
                                <label
                                    style="font-size: 0.8rem; color: var(--text-muted); white-space: nowrap;">Columns:</label>
                                <input type="number" id="labelCols" value="4" min="1" max="10" class="excel-input"
                                    style="width: 50px; min-height: 30px; padding: 0 5px; text-align: center;">

                                <label style="font-size: 0.8rem; color: var(--text-muted); white-space: nowrap;">Width
                                    (mm):</label>
                                <input type="number" id="labelWidth" value="40" min="20" class="excel-input"
                                    style="width: 60px; min-height: 30px; padding: 0 5px; text-align: center;">

                                <label style="font-size: 0.8rem; color: var(--text-muted); white-space: nowrap;">Height
                                    (mm):</label>
                                <input type="number" id="labelHeight" value="30" min="15" class="excel-input"
                                    style="width: 60px; min-height: 30px; padding: 0 5px; text-align: center;">
                            </div>
                        </div>
                        <div style="display: flex; gap: var(--space-sm);">
                            <button class="btn btn-secondary" onclick="clearBarcodeQueue()">
                                <i class="fas fa-trash"></i> Clear
                            </button>
                            <button class="btn btn-primary" onclick="previewBarcodes()">
                                <i class="fas fa-eye"></i> Preview & Print
                            </button>
                        </div>
                    </div>

                    <div class="excel-grid-container" style="margin-top: var(--space-md);">
                        <table class="excel-table">
                            <thead>
                                <tr>
                                    <th style="width: 50px;">#</th>
                                    <th>Product Name</th>
                                    <th>Barcode</th>
                                    <th style="width: 150px;">Quantity to Print</th>
                                    <th style="width: 50px;"></th>
                                </tr>
                            </thead>
                            <tbody id="barcodeQueueBody">
                                <!-- Populated by JS -->
                                <tr>
                                    <td colspan="5" class="text-center text-muted" style="padding: 40px;">
                                        <i class="fas fa-barcode fa-3x mb-md" style="opacity: 0.2;"></i>
                                        <p>No products added to print queue yet.</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Warehouse Management View -->
                <div id="view-warehouses" class="hidden">
                    <div class="grid-toolbar">
                        <div style="display: flex; align-items: center; gap: var(--space-md);">
                            <h1 class="page-title" style="margin:0;">Warehouse Management</h1>
                            <span id="syncStatusWarehouses" class="sync-status status-success">Synced to Supabase</span>
                        </div>
                        <div style="display: flex; gap: var(--space-sm);">
                            <button class="btn btn-secondary" onclick="loadWarehousesList()"><i
                                    class="fas fa-sync-alt"></i> Refresh</button>
                            <button class="btn btn-primary" onclick="openWarehouseModal()">
                                <i class="fas fa-plus"></i> Add Warehouse
                            </button>
                        </div>
                    </div>

                    <div class="excel-grid-container fade-in" style="margin-top: var(--space-md);">
                        <table class="excel-table">
                            <thead>
                                <tr>
                                    <th style="width: 50px;">#</th>
                                    <th>Warehouse Name</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>Location (City, Country)</th>
                                    <th style="width: 100px; text-align: center;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="warehousesListBody">
                                <!-- Populated by JS -->
                                <tr>
                                    <td colspan="6" class="text-center" style="padding: 40px;">
                                        <div class="spinner"></div> Loading warehouses...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Warehouse Modal -->
                <div id="warehouseModal" class="modal-overlay hidden">
                    <div class="modal-content" style="max-width: 600px;">
                        <div class="modal-header">
                            <h3 class="modal-title">Warehouse Details</h3>
                            <button class="btn-icon" onclick="closeWarehouseModal()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body" style="padding: var(--space-lg);">
                            <form id="warehouseForm" onsubmit="handleSaveWarehouse(event)">
                                <input type="hidden" id="warehouseId">
                                <div class="form-group">
                                    <label class="field-label">Warehouse Name *</label>
                                    <input type="text" id="warehouseName" class="excel-input" required
                                        placeholder="Enter Name">
                                </div>
                                <div class="form-grid"
                                    style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-md); margin-top: var(--space-md);">
                                    <div class="form-group">
                                        <label class="field-label">Email</label>
                                        <input type="email" id="warehouseEmail" class="excel-input"
                                            placeholder="Enter Email">
                                    </div>
                                    <div class="form-group">
                                        <label class="field-label">Phone Number</label>
                                        <input type="text" id="warehousePhone" class="excel-input"
                                            placeholder="Enter Phone Number">
                                    </div>
                                </div>
                                <div class="form-grid"
                                    style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-md); margin-top: var(--space-md);">
                                    <div class="form-group">
                                        <label class="field-label">Country</label>
                                        <input type="text" id="warehouseCountry" class="excel-input"
                                            placeholder="Enter Country">
                                    </div>
                                    <div class="form-group">
                                        <label class="field-label">City</label>
                                        <input type="text" id="warehouseCity" class="excel-input"
                                            placeholder="Enter City">
                                    </div>
                                </div>
                                <div class="form-group" style="margin-top: var(--space-md);">
                                    <label class="field-label">Zip Code</label>
                                    <input type="text" id="warehouseZip" class="excel-input"
                                        placeholder="Enter Zip Code">
                                </div>
                                <div
                                    style="margin-top: var(--space-xl); display: flex; justify-content: flex-end; gap: var(--space-md);">
                                    <button type="button" class="btn btn-secondary"
                                        onclick="closeWarehouseModal()">Cancel</button>
                                    <button type="submit" id="saveWarehouseBtn" class="btn btn-primary">Save
                                        Warehouse</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- User Management View -->
                <div id="view-users" class="hidden">
                    <div class="page-header">
                        <h1 class="page-title">User Management</h1>
                        <p class="page-subtitle">Manage system users and their permissions</p>
                    </div>

                    <div class="grid-toolbar">
                        <div style="display: flex; gap: var(--space-md); flex: 1;">
                            <button class="btn btn-primary" onclick="showAddUserModal()">
                                <i class="fas fa-user-plus"></i> Add New User
                            </button>
                        </div>
                    </div>

                    <div class="excel-grid-container" style="margin-top: var(--space-md);">
                        <table class="excel-table">
                            <thead>
                                <tr>
                                    <th style="width: 50px;">#</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Full Name</th>
                                    <th>Last Login</th>
                                    <th style="width: 100px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersBody">
                                <!-- Populated by JS -->
                                <tr>
                                    <td colspan="6" class="text-center" style="padding: 40px;">
                                        <div class="spinner"></div> Loading users...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <style>
                    .search-results-dropdown {
                        position: absolute;
                        top: 100%;
                        left: 0;
                        right: 0;
                        background: #2a2a2a;
                        border: 1px solid rgba(255, 255, 255, 0.1);
                        border-radius: 0 0 var(--radius-sm) var(--radius-sm);
                        z-index: 1000;
                        max-height: 300px;
                        overflow-y: auto;
                        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
                    }

                    .search-result-item {
                        padding: var(--space-sm) var(--space-md);
                        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
                        cursor: pointer;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    }

                    .search-result-item:hover {
                        background: rgba(255, 255, 255, 0.05);
                    }

                    .search-result-name {
                        font-weight: 500;
                    }

                    .search-result-code {
                        font-size: 0.8rem;
                        color: var(--text-muted);
                    }

                    @media print {
                        body * {
                            visibility: hidden;
                        }

                        #print-label-container,
                        #print-label-container * {
                            visibility: visible;
                        }

                        #print-label-container {
                            position: absolute;
                            left: 0;
                            top: 0;
                            width: 100%;
                        }
                    }
                </style>

                <div id="print-label-container" class="hidden"></div>

                <!-- Print Preview Modal -->
                <div id="barcodePreviewModal" class="modal-overlay hidden">
                    <div class="modal-content" style="max-width: 90vw; max-height: 90vh;">
                        <div class="modal-header">
                            <h3 class="modal-title">Print Preview</h3>
                            <div style="display: flex; gap: var(--space-sm);">
                                <button class="btn btn-primary" onclick="window.print()">
                                    <i class="fas fa-print"></i> Confirm Print
                                </button>
                                <button class="btn btn-secondary" onclick="closeBarcodePreview()">
                                    <i class="fas fa-times"></i> Close
                                </button>
                            </div>
                        </div>
                        <div class="modal-body"
                            style="background: #f0f0f0; padding: 20px; overflow: auto; display: flex; justify-content: center;">
                            <div id="barcodePreviewDisplay" class="label-print-grid-preview"
                                style="background: white; box-shadow: 0 0 20px rgba(0,0,0,0.2);"></div>
                        </div>
                    </div>
                </div>

                <style>
                    /* Custom Print Styles for New Labels */
                    .label-print-grid-preview,
                    .label-print-grid {
                        display: grid;
                        gap: 0;
                        background: white;
                        color: black;
                        margin: 0 auto;
                        box-sizing: border-box;
                    }

                    .barcode-label {
                        border: 0.1mm solid #ddd;
                        padding: 1mm;
                        text-align: center;
                        font-family: 'Inter', Arial, sans-serif;
                        page-break-inside: avoid;
                        display: flex;
                        flex-direction: column;
                        justify-content: center;
                        align-items: center;
                        box-sizing: border-box;
                        overflow: hidden;
                    }

                    .label-brand {
                        font-size: 7px;
                        text-transform: uppercase;
                        color: #666;
                        font-weight: 700;
                        margin-bottom: 1px;
                    }

                    .label-name {
                        font-size: 9px;
                        font-weight: 800;
                        line-height: 1;
                        margin-bottom: 2px;
                    }

                    .label-barcode-svg {
                        width: 90%;
                        height: auto;
                        margin: 1mm 0;
                    }

                    .label-footer {
                        display: flex;
                        justify-content: space-between;
                        width: 100%;
                        margin-top: 2px;
                        border-top: 0.1mm solid #eee;
                        padding-top: 1px;
                    }

                    .label-code {
                        font-size: 8px;
                        font-family: monospace;
                    }

                    .label-price {
                        font-size: 10px;
                        font-weight: 900;
                    }

                    .modal-overlay {
                        position: fixed;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: rgba(0, 0, 0, 0.8);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 2000;
                        backdrop-filter: blur(5px);
                    }

                    .modal-overlay.hidden {
                        display: none;
                    }

                    .modal-content {
                        background: var(--bg-secondary);
                        border-radius: var(--radius-lg);
                        width: 100%;
                        display: flex;
                        flex-direction: column;
                    }

                    .modal-header {
                        padding: var(--space-md);
                        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    }

                    .modal-body {
                        flex: 1;
                        overflow-y: auto;
                    }

                    @media print {
                        body * {
                            visibility: hidden !important;
                        }

                        #print-label-container,
                        #print-label-container * {
                            visibility: visible !important;
                        }

                        #print-label-container {
                            position: absolute;
                            left: 0;
                            top: 0;
                            width: 100%;
                            display: grid !important;
                            visibility: visible !important;
                        }

                        .modal-overlay {
                            display: none !important;
                        }
                    }
                </style>


            </main>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="addUserModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title">Add New User</h3>
                <button class="btn-icon" onclick="closeAddUserModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" style="padding: var(--space-lg);">
                <form id="addUserForm" onsubmit="handleCreateUser(event)">
                    <div class="form-group">
                        <label class="field-label">Email Address *</label>
                        <input type="email" id="newUserEmail" class="excel-input" required
                            placeholder="user@example.com">
                    </div>
                    <div class="form-group" style="margin-top: var(--space-md);">
                        <label class="field-label">Password *</label>
                        <input type="password" id="newUserPassword" class="excel-input" required
                            placeholder="Minimum 6 characters">
                    </div>
                    <div class="form-group" style="margin-top: var(--space-md);">
                        <label class="field-label">Role *</label>
                        <select id="newUserRole" class="excel-input" required>
                            <option value="cashier">Cashier</option>
                            <option value="manager">Manager</option>
                            <option value="admin">Administrator</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-top: var(--space-md);">
                        <label class="field-label">Full Name</label>
                        <input type="text" id="newUserFullName" class="excel-input" placeholder="Optional">
                    </div>
                    <div
                        style="margin-top: var(--space-xl); display: flex; justify-content: flex-end; gap: var(--space-md);">
                        <button type="button" class="btn btn-secondary" onclick="closeAddUserModal()">Cancel</button>
                        <button type="submit" id="createUserBtn" class="btn btn-primary">Create User</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    </div>
    </div>

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Fallback CDN if primary fails
        if (!window.supabase) {
            document.write('<script src="https://unpkg.com/@supabase/supabase-js@2"><\/script>');
        }
    </script>

    <!-- Scripts -->
    <script src="config.js"></script>
    <script src="js/supabase-client.js"></script>
    <script src="js/auth.js"></script>

    <script>
        // Supabase client is already initialized globally in supabase-client.js

        // Sidebar Toggle for Mobile
        var menuToggle = document.getElementById('menuToggle');
        var sidebar = document.getElementById('sidebar');
        var sidebarOverlay = document.getElementById('sidebarOverlay');

        menuToggle.addEventListener('click', function () {
            sidebar.classList.toggle('active');
            sidebarOverlay.classList.toggle('active');
        });

        sidebarOverlay.addEventListener('click', function () {
            sidebar.classList.remove('active');
            sidebarOverlay.classList.remove('active');
        });

        // Sidebar Dropdown Toggle
        var dropdownToggles = document.querySelectorAll('.dropdown-toggle');
        dropdownToggles.forEach(function (toggle) {
            toggle.addEventListener('click', function (e) {
                e.preventDefault();
                var parent = toggle.parentElement;

                // Close other open dropdowns (accordion style - optional)
                // document.querySelectorAll('.nav-item.has-submenu.active').forEach(function(item) {
                //     if (item !== parent) item.classList.remove('active');
                // });

                parent.classList.toggle('active');
            });
        });

        // Initialize on page load
        // Require admin authentication
        var currentUser = null;

        // Product Management State
        var productsData = [];
        var modifiedProducts = new Set(); // Stores IDs
        var deletedProducts = new Set();  // Stores IDs

        // Purchase Management State
        var purchaseItems = []; // For "Add Purchase" form
        var suppliersData = [];
        var warehousesData = [];

        function init() {
            // Check if dependencies are loaded
            if (typeof supabase === 'undefined' || !supabase || !supabase.auth) {
                console.error('Supabase client is not initialized. Checking window.supabase...');
                if (window.supabase && window.supabase.auth) {
                    supabase = window.supabase;
                } else if (window.supabaseClient && window.supabaseClient.auth) {
                    supabase = window.supabaseClient;
                } else {
                    alert('Critical Error: Supabase client is not defined. This usually means the library failed to load from the CDN. Please check your internet connection or if "cdn.jsdelivr.net" is blocked.');
                    return;
                }
            }

            // Check authentication and role
            requireAuth(['admin', 'manager', 'cashier']).then(function (user) {
                currentUser = user;
                if (currentUser) {
                    // Apply role-based permissions to UI
                    applyRolePermissions(currentUser.role);

                    // Initialize Touch Optimization
                    if (typeof setupDoubleTouchEditing === 'function') setupDoubleTouchEditing();

                    // Update user info
                    if (document.getElementById('userName')) document.getElementById('userName').textContent = currentUser.email;
                    if (document.getElementById('userRole')) document.getElementById('userRole').textContent = currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1);

                    // Handle URL parameters for initial view
                    var urlParams = new URLSearchParams(window.location.search);
                    var view = urlParams.get('view');
                    var action = urlParams.get('action');

                    if (view && hasPermission(currentUser.role, view)) {
                        switchView(view, action);
                    } else {
                        // Default to dashboard
                        loadDashboardData();
                    }
                }
            });
        }

        function hasPermission(role, viewName) {
            const adminOnly = ['users', 'variations']; // Stricter views
            const managerOnly = ['products', 'categories', 'brands', 'units', 'barcodes', 'purchase-manager', 'purchase-add', 'purchase-return', 'warehouses'];

            if (role === 'admin') return true;
            if (role === 'manager') {
                return adminOnly.indexOf(viewName) === -1;
            }
            if (role === 'cashier') {
                return adminOnly.indexOf(viewName) === -1 && managerOnly.indexOf(viewName) === -1;
            }
            return false;
        }

        function applyRolePermissions(role) {
            // Find all elements with data-permissions
            var elements = document.querySelectorAll('[data-permissions]');
            elements.forEach(function (el) {
                var allowedRoles = el.getAttribute('data-permissions').split(',');
                if (allowedRoles.indexOf(role) === -1) {
                    el.style.display = 'none';
                    // If it's a nav-item, also hide its container if needed or the li
                    if (el.classList.contains('nav-section')) {
                        el.classList.add('hidden');
                    }
                } else {
                    el.style.display = '';
                    el.classList.remove('hidden');
                }
            });
        }

        function switchView(viewName, action = null) {
            // Reset keyboard navigation
            selectedItemIndex = -1;
            document.querySelectorAll('.stacked-row.active, .excel-tr.active').forEach(r => r.classList.remove('active'));

            // Normalize viewName
            if (!viewName) viewName = 'dashboard';

            // Permission Check
            if (currentUser && !hasPermission(currentUser.role, viewName)) {
                console.warn('Unauthorized view access attempt:', viewName);
                viewName = 'dashboard';
            }

            // Hide all views
            const views = ['dashboard', 'products', 'categories', 'variations', 'brands', 'units', 'barcodes', 'users', 'purchase-manager', 'purchase-add', 'purchase-return', 'purchase-return-add', 'adjustments', 'warehouses'];
            views.forEach(v => {
                const el = document.getElementById('view-' + v);
                if (el) el.classList.add('hidden');
            });

            // Show selected view
            const targetId = viewName === 'dashboard' ? 'view-dashboard' : 'view-' + viewName;
            const targetEl = document.getElementById(targetId);
            if (targetEl) {
                targetEl.classList.remove('hidden');
            }

            // Update sidebar active state
            document.querySelectorAll('.sidebar-nav .nav-link').forEach(link => {
                if (link.getAttribute('onclick') && link.getAttribute('onclick').indexOf("'" + viewName + "'") !== -1) {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });

            // Update URL
            const newUrl = new URL(window.location);
            if (viewName === 'dashboard') {
                newUrl.searchParams.delete('view');
                newUrl.searchParams.delete('action');
            } else {
                newUrl.searchParams.set('view', viewName);
                if (action) newUrl.searchParams.set('action', action);
                else newUrl.searchParams.delete('action');
            }
            window.history.pushState({}, '', newUrl);

            // Handle View-Specific Loading
            if (viewName === 'products') {
                loadReferenceData().then(() => {
                    if (productsData.length === 0) {
                        loadProducts().then(() => {
                            if (action === 'add') {
                                addNewRow();
                                const cleanUrl = new URL(window.location);
                                cleanUrl.searchParams.delete('action');
                                window.history.replaceState({}, '', cleanUrl);
                            }
                        });
                    } else {
                        renderGrid();
                        if (action === 'add') {
                            addNewRow();
                            const cleanUrl = new URL(window.location);
                            cleanUrl.searchParams.delete('action');
                            window.history.replaceState({}, '', cleanUrl);
                        }
                    }
                });
            }
            else if (viewName === 'categories') loadCategories();
            else if (viewName === 'variations') loadVariations();
            else if (viewName === 'brands') loadBrands();
            else if (viewName === 'units') loadUnits();
            else if (viewName === 'barcodes') {
                if (productsData.length === 0) loadProducts();
            }
            else if (viewName === 'users') loadUsersList();
            else if (viewName === 'purchase-manager') loadPurchases();
            else if (viewName === 'purchase-add') {
                resetPurchaseForm();
                loadSuppliers();
                loadWarehouses();
                if (productsData.length === 0) loadProducts();
                if (categoriesData.length === 0) loadCategories();
                if (brandsData.length === 0) loadBrands();
                if (unitsData.length === 0) loadUnits();
            }
            else if (viewName === 'purchase-return') loadPurchaseReturns();
            else if (viewName === 'purchase-return-add') initPurchaseReturnAdd();
            else if (viewName === 'adjustments') loadAdjustments();
            else if (viewName === 'warehouses') loadWarehousesList();
            else {
                loadDashboardData();
            }
        }


        // Load dashboard data
        async function loadDashboardData() {
            try {
                // Load products count
                const { data: products, error: productsError } = await supabase
                    .from('products')
                    .select('*', { count: 'exact', head: true });

                if (!productsError) {
                    document.getElementById('productCount').textContent = (products && products.length) || 0;
                }

                // Load transactions
                const { data: transactions, error: transactionsError } = await supabase
                    .from('transactions')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(5);

                if (!transactionsError && transactions) {
                    document.getElementById('transactionCount').textContent = transactions.length;
                    displayTransactions(transactions);

                    // Calculate today's sales (Local Time)
                    const today = new Date();
                    const year = today.getFullYear();
                    const month = String(today.getMonth() + 1).padStart(2, '0');
                    const day = String(today.getDate()).padStart(2, '0');
                    const localDateString = `${year}-${month}-${day}`;

                    const todayTransactions = transactions.filter(t => {
                        // Convert transaction time to local date string for comparison
                        const tDate = new Date(t.created_at);
                        const tYear = tDate.getFullYear();
                        const tMonth = String(tDate.getMonth() + 1).padStart(2, '0');
                        const tDay = String(tDate.getDate()).padStart(2, '0');
                        return `${tYear}-${tMonth}-${tDay}` === localDateString;
                    });
                    const todayTotal = todayTransactions.reduce((sum, t) => sum + parseFloat(t.total), 0);
                    document.getElementById('todaySales').textContent = `$${todayTotal.toFixed(2)}`;
                }

                // Load users count
                const { data: users, error: usersError } = await supabase
                    .from('user_roles')
                    .select('*', { count: 'exact', head: true });

                if (!usersError) {
                    document.getElementById('userCount').textContent = (users && users.length) || 0;
                }
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        // Display transactions in table
        function displayTransactions(transactions) {
            const tbody = document.getElementById('transactionsBody');

            if (transactions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center text-muted">
                            <i class="fas fa-inbox"></i> No transactions yet
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = transactions.map(t => `
                <tr>
                    <td>#${t.id.substring(0, 8)}</td>
                    <td>${new Date(t.created_at).toLocaleDateString()}</td>
                    <td>$${parseFloat(t.total).toFixed(2)}</td>
                    <td><span class="badge badge-success">${t.status}</span></td>
                </tr>
            `).join('');
        }

        // --- Product Management Logic ---

        // Reference Data Cache
        let refCategories = [];
        let refSubcategories = [];
        let refBrands = [];
        let refUnits = [];

        async function loadReferenceData() {
            try {
                const [cats, subs, brands, units, whs, sups] = await Promise.all([
                    supabase.from('categories').select('*').order('name'),
                    supabase.from('subcategories').select('*').order('name'),
                    supabase.from('brands').select('*').order('name'),
                    supabase.from('units').select('*').order('name'),
                    supabase.from('warehouses').select('*').order('name'),
                    supabase.from('suppliers').select('*').order('name')
                ]);

                refCategories = cats.data || [];
                refSubcategories = subs.data || [];
                refBrands = brands.data || [];
                refUnits = units.data || [];
                warehousesData = whs.data || [];
                suppliersData = sups.data || [];
            } catch (error) {
                console.error('Error loading reference data:', error);
            }
        }

        // Local Storage Draft Helpers
        function saveProductDraft() {
            try {
                // Only save if there are actual changes
                if (modifiedProducts.size === 0 && deletedProducts.size === 0) {
                    localStorage.removeItem('pos_draft_products');
                    updateSyncStatus('Synced to Supabase');
                    return;
                }

                var draft = {
                    productsData: productsData,
                    modifiedProducts: Array.from(modifiedProducts),
                    deletedProducts: Array.from(deletedProducts),
                    timestamp: Date.now()
                };
                localStorage.setItem('pos_draft_products', JSON.stringify(draft));
                updateSyncStatus('Unsaved Changes (Local)');
            } catch (e) {
                console.error('Failed to save draft:', e);
            }
        }

        function clearProductDraft() {
            localStorage.removeItem('pos_draft_products');
            updateSyncStatus('Synced to Supabase');
        }

        function updateSyncStatus(status) {
            const el = document.getElementById('syncStatus');
            if (el) {
                el.textContent = status;
                el.className = 'sync-status ' + (status.includes('Unsaved') ? 'status-warning' : 'status-success');
            }
        }

        async function loadProducts(forceRefresh = false) {
            const tbody = document.getElementById('productsBody');
            tbody.innerHTML = `<tr><td colspan="12" class="text-center" style="padding: 20px;"><div class="spinner"></div>Loading...</td></tr>`;

            // Check for local draft first (skip if forcing refresh)
            if (!forceRefresh) {
                const localDraft = localStorage.getItem('pos_draft_products');
                if (localDraft) {
                    try {
                        const draft = JSON.parse(localDraft);
                        // Check if draft is effectively empty
                        const hasMods = (draft.modifiedProducts && draft.modifiedProducts.length > 0) ||
                            (draft.deletedProducts && draft.deletedProducts.length > 0);

                        if (hasMods) {
                            if (confirm('You have unsaved changes from a previous session. Would you like to resume your draft?')) {
                                productsData = draft.productsData;
                                modifiedProducts = new Set(draft.modifiedProducts);
                                deletedProducts = new Set(draft.deletedProducts);
                                renderGrid();
                                updateSaveButton();
                                updateSyncStatus('Unsaved Changes (Local)');
                                return;
                            } else {
                                localStorage.removeItem('pos_draft_products');
                            }
                        } else {
                            // Empty draft, clean it up silently
                            localStorage.removeItem('pos_draft_products');
                        }
                    } catch (e) {
                        console.error('Error parsing draft:', e);
                        localStorage.removeItem('pos_draft_products');
                    }
                }
            }

            modifiedProducts.clear();
            deletedProducts.clear();

            try {
                // Load refs first (if empty or forced)
                if (forceRefresh || refCategories.length === 0) await loadReferenceData();

                const { data: products, error } = await supabase
                    .from('products')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                // Auto-map legacy text fields to IDs if IDs are missing
                if (products) {
                    products.forEach(p => {
                        // Category
                        if (!p.category_id && p.category) {
                            const match = refCategories.find(c => c.name.toLowerCase() === p.category.toLowerCase());
                            if (match) p.category_id = match.id;
                        }
                        // Brand
                        if (!p.brand_id && p.brand) {
                            const match = refBrands.find(b => b.name.toLowerCase() === p.brand.toLowerCase());
                            if (match) p.brand_id = match.id;
                        }
                        // Unit
                        if (!p.unit_id && p.unit) {
                            const match = refUnits.find(u => u.name.toLowerCase() === p.unit.toLowerCase() || u.short_name.toLowerCase() === p.unit.toLowerCase());
                            if (match) p.unit_id = match.id;
                        }
                    });
                }

                productsData = products || [];
                renderGrid();
                updateSyncStatus('Synced to Supabase');

            } catch (error) {
                console.error('Error loading products:', error);
                tbody.innerHTML = `<tr><td colspan="12" class="text-center text-error" style="padding: 20px;">Error loading products</td></tr>`;
            }
        }

        function renderGrid() {
            var tbody = document.getElementById('productsBody');
            tbody.innerHTML = '';

            if (productsData.length === 0) {
                addNewRow();
                return;
            }

            // Prepare common options
            var unitOptions = '<option value="">Unit</option>' + refUnits.map(function (u) {
                return '<option value="' + escapeHtml(u.name) + '">' + escapeHtml(u.name) + '</option>';
            }).join('');

            var supplierOptions = '<option value="">Supplier</option>' + suppliersData.map(function (s) {
                return '<option value="' + escapeHtml(s.name) + '">' + escapeHtml(s.name) + '</option>';
            }).join('');

            var shopOptions = '<option value="">Shop</option>' + warehousesData.map(function (s) {
                return '<option value="' + escapeHtml(s.name) + '">' + escapeHtml(s.name) + '</option>';
            }).join('');

            productsData.forEach(function (product, index) {
                var container = document.createElement('div');
                container.className = 'stacked-row';
                if (modifiedProducts.has(product.id)) container.classList.add('modified');
                if (product.isNew) container.classList.add('new-row');

                container.dataset.id = product.id;
                container.dataset.index = index;

                // Category & Sub Options
                var categoryOptions = '<option value="">Category</option>' + refCategories.map(function (c) {
                    return '<option value="' + c.id + '" ' + (product.category_id === c.id ? 'selected' : '') + '>' + escapeHtml(c.name) + '</option>';
                }).join('');

                var brandOptions = '<option value="">Brand</option>' + refBrands.map(function (b) {
                    return '<option value="' + b.id + '" ' + (product.brand_id === b.id ? 'selected' : '') + '>' + escapeHtml(b.name) + '</option>';
                }).join('');

                var filteredSubs = product.category_id ? refSubcategories.filter(function (s) { return s.category_id === product.category_id; }) : [];
                var subOptions = '<option value="">Sub-Category</option>' + filteredSubs.map(function (s) {
                    return '<option value="' + s.id + '" ' + (product.subcategory_id === s.id ? 'selected' : '') + '>' + escapeHtml(s.name) + '</option>';
                }).join('');

                // Special handling for unit/supplier/shop selects to set initial value
                var currentSaleUnit = product.sale_unit || 'Pcs';
                var currentPurchaseUnit = product.purchase_unit || 'Box';

                var saleUnitOptions = unitOptions.replace('value="' + escapeHtml(currentSaleUnit) + '"', 'value="' + escapeHtml(currentSaleUnit) + '" selected');
                var purchaseUnitOptions = unitOptions.replace('value="' + escapeHtml(currentPurchaseUnit) + '"', 'value="' + escapeHtml(currentPurchaseUnit) + '" selected');
                var rowSupplierOptions = supplierOptions.replace('value="' + escapeHtml(product.supplier || '') + '"', 'value="' + escapeHtml(product.supplier || '') + '" selected');
                var rowShopOptions = shopOptions.replace('value="' + escapeHtml(product.shop || '') + '"', 'value="' + escapeHtml(product.shop || '') + '" selected');

                // Barcode Tags
                var barcodes = product.barcodes || [];
                var barcodeTagsHtml = barcodes.map(function (bc) {
                    return '<span class="barcode-tag">' + escapeHtml(bc) + ' <i class="fas fa-times" onclick="removeBarcode(\'' + product.id + '\', \'' + bc + '\')"></i></span>';
                }).join('');

                // Calculation
                var margin = 0;
                if (product.price && product.cost && product.cost > 0) {
                    margin = ((product.price - product.cost) / product.cost) * 100;
                }

                container.innerHTML =
                    '<!-- Line 1: Primary Row Fields (Top Priority) -->' +
                    '<div class="stacked-line">' +
                    '<div class="grid-field" style="flex: 0.5; min-width: 110px;">' +
                    '<span class="field-label">Item Code</span>' +
                    '<input type="text" class="excel-input" name="code" value="' + escapeHtml(product.code || '') + '" oninput="markProductModified(this)" onkeydown="handleGridNavigation(event)">' +
                    '</div>' +
                    '<div class="grid-field" style="flex: 1.5;">' +
                    '<span class="field-label">Barcode / add 1+++++</span>' +
                    '<div class="barcode-tags">' +
                    barcodeTagsHtml +
                    '<input type="text" class="excel-input" style="flex: 1; min-width: 100px; min-height: 30px;" placeholder="Scan..." onkeypress="handleAddBarcode(event, \'' + product.id + '\')" onkeydown="handleGridNavigation(event)">' +
                    '</div>' +
                    '</div>' +
                    '<div class="grid-field" style="flex: 2;">' +
                    '<span class="field-label">Description</span>' +
                    '<input type="text" class="excel-input" name="name" value="' + escapeHtml(product.name || '') + '" oninput="markProductModified(this)" placeholder="e.g. abcd 100ml" onkeydown="handleGridNavigation(event)">' +
                    '</div>' +
                    '<div class="grid-field" style="flex: 0.2; min-width: 50px; border-right: none; align-items: center; justify-content: center;">' +
                    '<button class="btn-icon" onclick="deleteProductRow(this)" style="color: var(--text-muted); font-size: 1.2rem;"><i class="fas fa-trash-alt"></i></button>' +
                    '</div>' +
                    '</div>' +
                    '<!-- Line 2: Categorization & Cost -->' +
                    '<div class="stacked-line" style="background: rgba(255,255,255,0.02);">' +
                    '<div class="grid-field">' +
                    '<span class="field-label">Category</span>' +
                    '<select class="excel-input ts-search" name="category_id" onchange="handleCategoryChange(this)" onkeydown="handleGridNavigation(event)">' + categoryOptions + '</select>' +
                    '</div>' +
                    '<div class="grid-field">' +
                    '<span class="field-label">Sub-Category</span>' +
                    '<select class="excel-input ts-search" name="subcategory_id" onchange="markProductModified(this)" onkeydown="handleGridNavigation(event)">' + subOptions + '</select>' +
                    '</div>' +
                    '<div class="grid-field">' +
                    '<span class="field-label">Brand</span>' +
                    '<select class="excel-input ts-search" name="brand_id" onchange="markProductModified(this)" onkeydown="handleGridNavigation(event)">' + brandOptions + '</select>' +
                    '</div>' +
                    '<div class="grid-field">' +
                    '<span class="field-label">Cost</span>' +
                    '<input type="number" class="excel-input" name="cost" value="' + (product.cost || '') + '" step="0.01" oninput="calculateMargin(this)" onkeydown="handleGridNavigation(event)">' +
                    '</div>' +
                    '<div class="grid-field">' +
                    '<span class="field-label">Sale Unit</span>' +
                    '<select class="excel-input ts-search" name="sale_unit" onchange="markProductModified(this)" onkeydown="handleGridNavigation(event)">' + saleUnitOptions + '</select>' +
                    '</div>' +
                    '</div>' +
                    '<!-- Line 3: Pricing & Units -->' +
                    '<div class="stacked-line">' +
                    '<div class="grid-field">' +
                    '<span class="field-label">Purchase Unit</span>' +
                    '<select class="excel-input ts-search" name="purchase_unit" onchange="markProductModified(this)" onkeydown="handleGridNavigation(event)">' + purchaseUnitOptions + '</select>' +
                    '</div>' +
                    '<div class="grid-field">' +
                    '<span class="field-label">Conversion (Pcs/Unit)</span>' +
                    '<input type="number" class="excel-input" name="pcs_per_box" value="' + (product.pcs_per_box || 1) + '" oninput="markProductModified(this)" onkeydown="handleGridNavigation(event)">' +
                    '</div>' +
                    '<div class="grid-field">' +
                    '<span class="field-label">Price</span>' +
                    '<input type="number" class="excel-input" name="price" value="' + (product.price || '') + '" step="0.01" oninput="calculateMargin(this)" onkeydown="handleGridNavigation(event)">' +
                    '</div>' +
                    '<div class="grid-field">' +
                    '<span class="field-label">Margin %</span>' +
                    '<input type="text" class="excel-input margin-input" name="margin" value="' + margin.toFixed(2) + '%" readonly style="background: rgba(255,255,255,0.05); color: var(--primary-light); font-weight: bold;" onkeydown="handleGridNavigation(event)">' +
                    '</div>' +
                    '<div class="grid-field" style="flex: 0.5;">' +
                    '<span class="field-label">Stock</span>' +
                    '<input type="number" class="excel-input" name="stock" value="' + (product.stock || 0) + '" oninput="markProductModified(this)" onkeydown="handleGridNavigation(event)">' +
                    '</div>' +
                    '</div>' +
                    '<!-- Line 4: Supplier & Location -->' +
                    '<div class="stacked-line" style="background: rgba(255,255,255,0.02);">' +
                    '<div class="grid-field">' +
                    '<span class="field-label">Supplier</span>' +
                    '<select class="excel-input ts-search-create" name="supplier" onchange="markProductModified(this)" onkeydown="handleGridNavigation(event)">' + rowSupplierOptions + '</select>' +
                    '</div>' +
                    '<div class="grid-field">' +
                    '<span class="field-label">Shop</span>' +
                    '<select class="excel-input ts-search-create" name="shop" onchange="markProductModified(this)" onkeydown="handleGridNavigation(event)">' + rowShopOptions + '</select>' +
                    '</div>' +
                    '</div>';

                tbody.appendChild(container);
            });

            // Initialize TomSelect for all flagged selects in the grid
            // We use a small delay to ensure DOM is ready or just do it now since we appended.
            document.querySelectorAll('#productsBody .ts-search').forEach(function (el) {
                if (el.tomselect) el.tomselect.destroy();
                new TomSelect(el, {
                    create: false,
                    sortField: { field: "text", direction: "asc" }
                });
            });

            document.querySelectorAll('#productsBody .ts-search-create').forEach(function (el) {
                if (el.tomselect) el.tomselect.destroy();
                new TomSelect(el, {
                    create: true,
                    sortField: { field: "text", direction: "asc" }
                });
            });
        }

        function handleAddBarcode(event, productId) {
            if (event.key === 'Enter') {
                var input = event.target;
                var value = input.value.trim();
                if (value) {
                    var product = productsData.find(function (p) { return p.id.toString() === productId.toString(); });
                    if (product) {
                        if (!product.barcodes) product.barcodes = [];
                        if (product.barcodes.indexOf(value) === -1) {
                            product.barcodes.push(value);

                            // Mark row as modified
                            var row = input.closest('.stacked-row');
                            if (row) {
                                modifiedProducts.add(productId);
                                row.classList.add('modified');
                                updateSaveButton();
                                saveProductDraft();
                            }

                            renderGrid();

                            // REFOCUS the scan input for the same product
                            setTimeout(function () {
                                var newRow = document.querySelector('.stacked-row[data-id="' + productId + '"]');
                                if (newRow) {
                                    var scanInput = newRow.querySelector('input[placeholder="Scan..."]');
                                    if (scanInput) scanInput.focus();
                                }
                            }, 50);
                        }
                    }
                }
                input.value = '';
                event.preventDefault();
            }
        }

        function removeBarcode(productId, barcode) {
            var product = productsData.find(function (p) { return p.id.toString() === productId.toString(); });
            if (product && product.barcodes) {
                var index = product.barcodes.indexOf(barcode);
                if (index !== -1) {
                    product.barcodes.splice(index, 1);
                    modifiedProducts.add(productId);
                    renderGrid();
                    updateSaveButton();
                    saveProductDraft();
                }
            }
        }

        function calculateMargin(input) {
            var row = input.closest('.stacked-row');
            var productId = row.dataset.id;
            var product = productsData.find(function (p) { return p.id.toString() === productId.toString(); });

            if (product) {
                // Update model
                product[input.name] = parseFloat(input.value) || 0;

                // Sync UI for Margin
                var cost = product.cost || 0;
                var price = product.price || 0;
                var marginInput = row.querySelector('input[name="margin"]');

                if (marginInput && cost > 0) {
                    var m = ((price - cost) / cost) * 100;
                    marginInput.value = m.toFixed(2) + '%';
                }

                markProductModified(input);
            }
        }

        function handleCategoryChange(select) {
            var row = select.closest('.stacked-row');
            var subSelect = row.querySelector('select[name="subcategory_id"]');
            var categoryId = select.value;
            var productId = row.dataset.id;

            // Mark modified
            markProductModified(select);

            // Update subcategory options
            var filteredSubs = categoryId
                ? refSubcategories.filter(function (s) { return s.category_id === categoryId; })
                : [];

            // Update the model for this product
            var product = productsData.find(function (p) { return p.id.toString() === productId.toString(); });
            if (product) {
                product.category_id = categoryId || null;
                product.subcategory_id = null;
            }

            if (subSelect.tomselect) {
                subSelect.tomselect.clearOptions();
                subSelect.tomselect.addOption({ value: "", text: "Sub-Category" });
                filteredSubs.forEach(function (s) {
                    subSelect.tomselect.addOption({ value: s.id, text: s.name });
                });
                subSelect.tomselect.setValue("");
            } else {
                subSelect.innerHTML = '<option value="">Sub-Category</option>' + filteredSubs.map(function (s) {
                    return '<option value="' + s.id + '">' + escapeHtml(s.name) + '</option>';
                }).join('');
                subSelect.value = "";
            }
        }

        function addNewRow() {
            var index = productsData.length;

            // Apply Touch Locks to previous elements if any
            if (window.applyTouchLocks) window.applyTouchLocks();

            // Generate a real UUID for the new product so upsert always works
            var newProduct = {
                id: crypto.randomUUID(),
                name: '',
                code: '',
                barcodes: [],
                category_id: null,
                subcategory_id: null,
                brand_id: null,
                price: '',
                cost: '',
                stock: 0,
                unit_id: null,
                image_url: '',
                pcs_per_box: 1,
                supplier: '',
                shop: '',
                isNew: true
            };

            productsData.push(newProduct);
            modifiedProducts.add(newProduct.id);

            renderGrid();

            // Focus new row name input
            var lastRow = tbody.lastElementChild;
            if (lastRow) {
                var nameInput = lastRow.querySelector('input[name="name"]');
                if (nameInput) {
                    if (window.unlockTouchInput) window.unlockTouchInput(nameInput);
                    nameInput.focus();
                }
            }

            updateSaveButton();
            saveProductDraft();

            // Auto-scroll to bottom
            setTimeout(function () {
                var container = document.getElementById('stacked-grid-container');
                if (container) container.scrollTop = container.scrollHeight;
            }, 100);
        }

        function deleteProductRow(btn) {
            var row = btn.closest('.stacked-row');
            var id = row.dataset.id;
            var index = parseInt(row.dataset.index);

            if (confirm('Delete this product?')) {
                // Only delete from server if it's not a brand-new unsaved product
                var product = productsData.find(function (p) { return p.id.toString() === id.toString(); });
                if (product && !product.isNew) {
                    deletedProducts.add(id);
                }
                modifiedProducts.delete(id);

                // Remove from local data if it's new (never saved)
                if (product && product.isNew) {
                    productsData = productsData.filter(function (p) { return p.id !== id; });
                    renderGrid();
                } else {
                    // Visual feedback for existing products
                    row.style.opacity = '0.5';
                    row.style.pointerEvents = 'none';
                    row.style.backgroundColor = 'rgba(255, 50, 50, 0.1)';
                }

                updateSaveButton();
                saveProductDraft();
            }
        }

        function markProductModified(input) {
            var row = input.closest('.stacked-row');
            var productId = row.dataset.id;
            var product = productsData.find(function (p) { return p.id.toString() === productId.toString(); });

            if (!product) {
                console.error('Product not found for ID:', productId);
                return;
            }
            var field = input.name;
            var value = input.value;

            if (['price', 'cost', 'stock', 'pcs_per_box'].indexOf(field) !== -1) {
                value = parseFloat(value) || 0;
            }
            // For dropdowns, if value is empty string, set to null
            if (['category_id', 'subcategory_id', 'brand_id', 'unit_id'].indexOf(field) !== -1) {
                if (value === "") value = null;
            }

            if (field !== 'margin') {
                product[field] = value;
            }

            modifiedProducts.add(product.id);
            row.classList.add('modified');

            updateSaveButton();
            saveProductDraft();
        }

        function updateSaveButton() {
            var btn = document.getElementById('saveBtn');
            var btnBottom = document.getElementById('saveBtnBottom');
            var count = modifiedProducts.size + deletedProducts.size;
            var html = count > 0 ? '<i class="fas fa-save"></i> Save (' + count + ')' : '<i class="fas fa-save"></i> Save Changes';

            if (btn) {
                btn.innerHTML = html;
                if (count > 0) btn.classList.add('pulse');
                else btn.classList.remove('pulse');
            }
            if (btnBottom) {
                btnBottom.innerHTML = html;
                if (count > 0) btnBottom.classList.add('pulse');
                else btnBottom.classList.remove('pulse');
            }
        }

        function saveAllChanges() {
            var btn = document.getElementById('saveBtn');
            var btnBottom = document.getElementById('saveBtnBottom');
            var originalText = btn ? btn.innerHTML : 'Save Changes';

            return new Promise(function (resolve, reject) {
                if (btn) {
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                    btn.disabled = true;
                }
                if (btnBottom) {
                    btnBottom.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                    btnBottom.disabled = true;
                }

                // 1. Handle Deletions (deletedProducts only contains real UUIDs now)
                var deletePromise = deletedProducts.size > 0
                    ? supabase.from('products').delete().in('id', Array.from(deletedProducts))
                    : Promise.resolve({ error: null });

                deletePromise.then(function (res) {
                    if (res.error) throw res.error;

                    // 2. Handle Upserts
                    var upsertData = [];
                    var deletedItemsArr = Array.from(deletedProducts);

                    modifiedProducts.forEach(function (id) {
                        var product = productsData.find(function (p) { return p.id === id; });
                        if (!product) return;
                        if (deletedItemsArr.indexOf(id) !== -1) return;

                        var payload = {
                            name: product.name,
                            code: product.code,
                            barcodes: Array.isArray(product.barcodes) ? product.barcodes : [],
                            category_id: product.category_id || null,
                            subcategory_id: product.subcategory_id || null,
                            brand_id: product.brand_id || null,
                            price: product.price || 0,
                            cost: product.cost || 0,
                            stock: product.stock || 0,
                            unit_id: product.unit_id || null,
                            image_url: product.image_url || '',
                            pcs_per_box: product.pcs_per_box || 1,
                            supplier: product.supplier || null,
                            shop: product.shop || 'Main Warehouse',
                            sale_unit: product.sale_unit || null,
                            purchase_unit: product.purchase_unit || null
                        };

                        // Ensure proper UUID for ID
                        if (product.id && product.id.toString().startsWith('new_')) {
                            // Replace temp ID with real UUID
                            var realUUID = crypto.randomUUID ? crypto.randomUUID() : 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                                return v.toString(16);
                            });
                            payload.id = realUUID;

                            // Update local product to avoid re-saving issues
                            product.id = realUUID;
                            product.isNew = false;

                            // Also update modifiedProducts set
                            modifiedProducts.delete(id);
                            modifiedProducts.add(realUUID);
                        } else {
                            payload.id = product.id;
                        }

                        upsertData.push(payload);
                    });

                    if (upsertData.length > 0) {
                        supabase.from('products').upsert(upsertData).then(function (res) {
                            if (res.error) throw res.error;
                            finishSave();
                        }).catch(handleSaveError);
                    } else {
                        finishSave();
                    }
                }).catch(handleSaveError);

                function finishSave() {
                    // 1. Capture and Clear modification tracking FIRST to prevent race conditions with auto-save
                    var deletedArr = Array.from(deletedProducts);
                    modifiedProducts.clear();
                    deletedProducts.clear();

                    // 2. Clear local storage draft
                    clearProductDraft();

                    // 3. Update local data state (No Reload)
                    if (deletedArr.length > 0) {
                        productsData = productsData.filter(function (p) { return deletedArr.indexOf(p.id) === -1; });
                    }

                    // Reset isNew flags
                    productsData.forEach(function (p) {
                        if (p.isNew) p.isNew = false;
                    });

                    alert('Products saved successfully!');

                    // 4. Update UI immediately
                    renderGrid();
                    updateSaveButton();

                    if (btn) {
                        btn.disabled = false;
                        btn.classList.remove('pulse');
                    }
                    if (btnBottom) {
                        btnBottom.disabled = false;
                        btnBottom.classList.remove('pulse');
                    }

                    updateSaveButton(); // This will set the correct label (Save Changes)
                    resolve();
                }

                function handleSaveError(error) {
                    console.error('Error saving products:', error);
                    alert('Error saving products: ' + (error.message || error));
                    if (btn) {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }
                    if (btnBottom) {
                        btnBottom.innerHTML = originalText;
                        btnBottom.disabled = false;
                    }
                    reject(error);
                }
            });
        }

        function escapeHtml(text) {
            if (!text) return '';
            return text
                .toString()
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }



        // Quick action functions handled via switchView now
        function addProduct() {
            switchView('products', 'add');
        }

        function viewProducts() {
            switchView('products');
        }

        function handleGridNavigation(event) {
            const key = event.key;
            const isArrow = ['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].indexOf(key) !== -1;

            if (key === 'Enter' || isArrow) {
                // Determine if we should allow Enter to move focus
                // Skip if it's the global search bar
                if (event.target.id === 'globalSearchInput') return;

                // For "Scan..." input in barcode tags, if empty, move to next field
                if (key === 'Enter' && event.target.placeholder === "Scan..." && event.target.value.trim() !== "") {
                    // handleAddBarcode will deal with this
                    return;
                }

                event.preventDefault();
                var inputs = Array.prototype.slice.call(document.querySelectorAll('#productsBody .excel-input'));
                var currentIndex = inputs.indexOf(event.target);

                if (currentIndex !== -1) {
                    var nextIndex = -1;
                    const inputsPerRow = 13; // item_code, scan, name, cat, sub, brand, cost, price, margin, unit, supplier, shop, stock

                    if (key === 'Enter' || key === 'ArrowRight') {
                        nextIndex = currentIndex + 1;
                    } else if (key === 'ArrowLeft') {
                        nextIndex = currentIndex - 1;
                    } else if (key === 'ArrowUp') {
                        nextIndex = currentIndex - inputsPerRow;
                    } else if (key === 'ArrowDown') {
                        nextIndex = currentIndex + inputsPerRow;
                    }

                    if (nextIndex >= 0 && nextIndex < inputs.length) {
                        inputs[nextIndex].focus();
                        // If it's a number/text input, select the text for quick overwrite
                        if (inputs[nextIndex].select) inputs[nextIndex].select();
                    } else if (key === 'Enter' && nextIndex >= inputs.length) {
                        // At the last field of the last row - add a new row
                        addNewRow();
                    }
                }
            }
        }

        function viewTransactions() {
            alert('Transactions page coming soon!');
        }

        function manageUsers() {
            alert('User management feature coming soon!');
        }

        function openPOS() {
            alert('POS feature coming soon!');
        }

        // Module-specific Sync Status Update
        function updateModuleSyncStatus(moduleId, status) {
            const el = document.getElementById('syncStatus' + moduleId);
            if (el) {
                el.textContent = status;
                el.className = 'sync-status ' + (status.includes('Unsaved') ? 'status-warning' : 'status-success');
            }
        }

        function saveCategoriesDraft() {
            try {
                const draft = {
                    categoriesData,
                    subcategoriesData,
                    modifiedCategories: Array.from(modifiedCategories),
                    deletedCategories: Array.from(deletedCategories),
                    modifiedSubcategories: Array.from(modifiedSubcategories),
                    deletedSubcategories: Array.from(deletedSubcategories)
                };
                localStorage.setItem('pos_draft_categories', JSON.stringify(draft));
                updateModuleSyncStatus('Categories', 'Unsaved Changes (Local)');
            } catch (e) {
                console.error('Failed to save categories draft:', e);
            }
        }

        function clearCategoriesDraft() {
            localStorage.removeItem('pos_draft_categories');
            updateModuleSyncStatus('Categories', 'Synced to Supabase');
        }

        // =====================================================
        // CATEGORY MANAGEMENT FUNCTIONS
        // =====================================================

        let categoriesData = [];
        let subcategoriesData = [];
        let modifiedCategories = new Set();
        let deletedCategories = new Set();
        let modifiedSubcategories = new Set();
        let deletedSubcategories = new Set();

        // Switch between Main Categories and Subcategories tabs
        function switchCategoryTab(tab) {
            const mainTab = document.getElementById('mainCategoriesTab');
            const subTab = document.getElementById('subcategoriesTab');
            const mainView = document.getElementById('mainCategoriesView');
            const subView = document.getElementById('subcategoriesView');

            if (tab === 'main') {
                mainTab.style.borderBottom = '3px solid var(--primary)';
                subTab.style.borderBottom = 'none';
                mainView.classList.remove('hidden');
                subView.classList.add('hidden');
            } else {
                subTab.style.borderBottom = '3px solid var(--primary)';
                mainTab.style.borderBottom = 'none';
                subView.classList.remove('hidden');
                mainView.classList.add('hidden');
            }
        }

        // Load all categories and subcategories
        async function loadCategories() {
            try {
                // Check for local draft first
                const localDraft = localStorage.getItem('pos_draft_categories');
                if (localDraft) {
                    try {
                        const draft = JSON.parse(localDraft);
                        const hasMods = (draft.modifiedCategories && draft.modifiedCategories.length > 0) ||
                            (draft.deletedCategories && draft.deletedCategories.length > 0) ||
                            (draft.modifiedSubcategories && draft.modifiedSubcategories.length > 0) ||
                            (draft.deletedSubcategories && draft.deletedSubcategories.length > 0);

                        if (hasMods) {
                            if (confirm('You have unsaved category changes. Would you like to resume?')) {
                                categoriesData = draft.categoriesData;
                                subcategoriesData = draft.subcategoriesData;
                                modifiedCategories = new Set(draft.modifiedCategories);
                                deletedCategories = new Set(draft.deletedCategories);
                                modifiedSubcategories = new Set(draft.modifiedSubcategories);
                                deletedSubcategories = new Set(draft.deletedSubcategories);
                                renderCategories();
                                renderSubcategories();
                                updateModuleSyncStatus('Categories', 'Unsaved Changes (Local)');
                                return;
                            } else {
                                localStorage.removeItem('pos_draft_categories');
                            }
                        } else {
                            // Silent cleanup of empty draft
                            localStorage.removeItem('pos_draft_categories');
                        }
                    } catch (e) {
                        console.error('Error parsing categories draft:', e);
                        localStorage.removeItem('pos_draft_categories');
                    }
                }

                // Load main categories
                const { data: categories, error: catError } = await supabase
                    .from('categories')
                    .select('*')
                    .order('name', { ascending: true });

                if (catError) throw catError;
                categoriesData = categories || [];

                // Load subcategories
                const { data: subcategories, error: subError } = await supabase
                    .from('subcategories')
                    .select(`
                        *,
                        categories (name)
                    `)
                    .order('name', { ascending: true });

                if (subError) throw subError;
                subcategoriesData = subcategories || [];

                renderCategories();
                renderSubcategories();

                // Reset tracking
                modifiedCategories.clear();
                deletedCategories.clear();
                modifiedSubcategories.clear();
                deletedSubcategories.clear();
                updateModuleSyncStatus('Categories', 'Synced to Supabase');

            } catch (error) {
                console.error('Error loading categories:', error);
                alert('Failed to load categories: ' + error.message);
            }
        }

        // Render main categories table
        function renderCategories() {
            const tbody = document.getElementById('categoriesBody');
            tbody.innerHTML = '';

            categoriesData.forEach((category, index) => {
                const tr = document.createElement('tr');
                tr.className = 'excel-tr';
                if (modifiedCategories.has(category.id)) tr.classList.add('modified');
                if (category.id && category.id.toString().startsWith('new_')) tr.classList.add('new-row');
                tr.dataset.index = index;

                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td><input type="text" class="excel-input" value="${escapeHtml(category.name || '')}" data-field="name" oninput="markCategoryModified(this)"></td>
                    <td><input type="text" class="excel-input" value="${escapeHtml(category.description || '')}" data-field="description" oninput="markCategoryModified(this)"></td>
                    <td class="action-cell">
                        <button class="btn-icon" onclick="deleteCategory(${index})" title="Delete"><i class="fas fa-trash"></i></button>
                    </td>
                `;

                tbody.appendChild(tr);
            });
        }

        // Render subcategories table
        function renderSubcategories() {
            const tbody = document.getElementById('subcategoriesBody');
            tbody.innerHTML = '';

            subcategoriesData.forEach((sub, index) => {
                const tr = document.createElement('tr');
                tr.className = 'excel-tr';
                if (modifiedSubcategories.has(sub.id)) tr.classList.add('modified');
                if (sub.id && sub.id.toString().startsWith('new_')) tr.classList.add('new-row');
                tr.dataset.index = index;

                // Create category dropdown options
                const categoryOptions = categoriesData.map(cat =>
                    `<option value="${cat.id}" ${sub.category_id === cat.id ? 'selected' : ''}>${escapeHtml(cat.name)}</option>`
                ).join('');

                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>
                        <select class="excel-input" data-field="category_id" onchange="markSubcategoryModified(this)">
                            <option value="">Select Category</option>
                            ${categoryOptions}
                        </select>
                    </td>
                    <td><input type="text" class="excel-input" value="${escapeHtml(sub.name || '')}" data-field="name" oninput="markSubcategoryModified(this)"></td>
                    <td><input type="text" class="excel-input" value="${escapeHtml(sub.description || '')}" data-field="description" oninput="markSubcategoryModified(this)"></td>
                    <td class="action-cell">
                        <button class="btn-icon" onclick="deleteSubcategory(${index})" title="Delete"><i class="fas fa-trash"></i></button>
                    </td>
                `;

                tbody.appendChild(tr);
            });
        }

        // Mark category as modified
        function markCategoryModified(input) {
            const tr = input.closest('tr');
            const index = parseInt(tr.dataset.index);
            const category = categoriesData[index];
            const field = input.dataset.field;
            const value = input.value;

            category[field] = value;
            modifiedCategories.add(category.id);

            tr.classList.add('modified');
            saveCategoriesDraft();
        }

        // Mark subcategory as modified
        function markSubcategoryModified(input) {
            const tr = input.closest('tr');
            const index = parseInt(tr.dataset.index);
            const sub = subcategoriesData[index];
            const field = input.dataset.field;
            const value = input.value;

            sub[field] = value;
            modifiedSubcategories.add(sub.id);

            tr.classList.add('modified');
            saveCategoriesDraft();
        }

        // Add new category row
        function addNewCategory() {
            const newCategory = {
                id: crypto.randomUUID(),
                name: '',
                description: '',
                isNew: true
            };

            categoriesData.push(newCategory);
            modifiedCategories.add(newCategory.id);

            renderCategories();
            // Focus new row name input
            const lastTr = document.getElementById('categoriesBody').lastElementChild;
            if (lastTr) lastTr.querySelector('input[data-field="name"]').focus();
            saveCategoriesDraft();
        }

        // Add new subcategory row
        function addNewSubcategory() {
            const newSubcategory = {
                id: crypto.randomUUID(),
                category_id: '',
                name: '',
                description: '',
                isNew: true
            };

            subcategoriesData.push(newSubcategory);
            modifiedSubcategories.add(newSubcategory.id);

            renderSubcategories();
            // Focus new row name input
            const lastTr = document.getElementById('subcategoriesBody').lastElementChild;
            if (lastTr) lastTr.querySelector('input[data-field="name"]').focus();
            saveCategoriesDraft();
        }

        // Delete category
        function deleteCategory(index) {
            if (confirm('Are you sure you want to delete this category? This will also delete all its subcategories.')) {
                const category = categoriesData[index];
                if (category.id && !category.id.toString().startsWith('new_')) {
                    deletedCategories.add(category.id);
                }
                modifiedCategories.delete(category.id);
                categoriesData.splice(index, 1);
                renderCategories();
                saveCategoriesDraft();
            }
        }

        function deleteSubcategory(index) {
            if (confirm('Are you sure you want to delete this subcategory?')) {
                const subcategory = subcategoriesData[index];
                if (subcategory.id && !subcategory.id.toString().startsWith('new_')) {
                    deletedSubcategories.add(subcategory.id);
                }
                modifiedSubcategories.delete(subcategory.id);
                subcategoriesData.splice(index, 1);
                renderSubcategories();
                saveCategoriesDraft();
            }
        }

        // Save all category changes
        async function saveCategoryChanges() {
            try {
                const categoriesToSave = categoriesData.filter(c => modifiedCategories.has(c.id));
                const subcategoriesToSave = subcategoriesData.filter(s => modifiedSubcategories.has(s.id));

                // Delete categories
                if (deletedCategories.size > 0) {
                    const { error: deleteError } = await supabase
                        .from('categories')
                        .delete()
                        .in('id', Array.from(deletedCategories));

                    if (deleteError) throw deleteError;
                }

                if (categoriesToSave.length > 0) {
                    const { error: upsertError } = await supabase
                        .from('categories')
                        .upsert(categoriesToSave.map(cat => ({
                            id: cat.id,
                            name: cat.name,
                            description: cat.description
                        })));

                    if (upsertError) throw upsertError;
                }

                // ... deletions ...

                if (subcategoriesToSave.length > 0) {
                    const { error: upsertError } = await supabase
                        .from('subcategories')
                        .upsert(subcategoriesToSave.map(sub => ({
                            id: sub.id,
                            category_id: sub.category_id,
                            name: sub.name,
                            description: sub.description
                        })));

                    if (upsertError) throw upsertError;
                }

                // Capture deletions and Clear tracking/draft
                var delCats = Array.from(deletedCategories);
                var delSubs = Array.from(deletedSubcategories);

                modifiedCategories.clear();
                deletedCategories.clear();
                modifiedSubcategories.clear();
                deletedSubcategories.clear();
                clearCategoriesDraft();

                alert('All changes saved successfully!');

                // Update UI locally (No Reload)
                if (delCats.length > 0) categoriesData = categoriesData.filter(c => delCats.indexOf(c.id) === -1);
                if (delSubs.length > 0) subcategoriesData = subcategoriesData.filter(s => delSubs.indexOf(s.id) === -1);

                categoriesData.forEach(c => { if (c.isNew) c.isNew = false; });
                subcategoriesData.forEach(s => { if (s.isNew) s.isNew = false; });

                renderCategories();
                renderSubcategories();
                loadReferenceData(); // Sync grid cache
                if (!document.getElementById('view-products').classList.contains('hidden')) {
                    renderGrid();
                }
            } catch (error) {
                console.error('Error saving categories:', error);
                alert('Failed to save categories: ' + error.message);
            }
        }

        // =====================================================
        // VARIATION MANAGEMENT FUNCTIONS
        // =====================================================

        let variationTypesData = [];
        let variationOptionsData = [];
        let modifiedVariationTypes = new Set();
        let deletedVariationTypes = new Set();
        let modifiedVariationOptions = new Set();
        let deletedVariationOptions = new Set();

        // Switch between Variation Types and Options tabs
        function switchVariationTab(tab) {
            const typesTab = document.getElementById('variationTypesTab');
            const optionsTab = document.getElementById('variationOptionsTab');
            const typesView = document.getElementById('variationTypesView');
            const optionsView = document.getElementById('variationOptionsView');

            if (tab === 'types') {
                typesTab.style.borderBottom = '3px solid var(--primary)';
                optionsTab.style.borderBottom = 'none';
                typesView.classList.remove('hidden');
                optionsView.classList.add('hidden');
            } else {
                optionsTab.style.borderBottom = '3px solid var(--primary)';
                typesTab.style.borderBottom = 'none';
                optionsView.classList.remove('hidden');
                typesView.classList.add('hidden');
            }
        }

        function saveVariationsDraft() {
            try {
                const draft = {
                    variationTypesData,
                    variationOptionsData,
                    modifiedVariationTypes: Array.from(modifiedVariationTypes),
                    deletedVariationTypes: Array.from(deletedVariationTypes),
                    modifiedVariationOptions: Array.from(modifiedVariationOptions),
                    deletedVariationOptions: Array.from(deletedVariationOptions)
                };
                localStorage.setItem('pos_draft_variations', JSON.stringify(draft));
                updateModuleSyncStatus('Variations', 'Unsaved Changes (Local)');
            } catch (e) { console.error(e); }
        }

        function clearVariationsDraft() {
            localStorage.removeItem('pos_draft_variations');
            updateModuleSyncStatus('Variations', 'Synced to Supabase');
        }

        // Load all variations data
        async function loadVariations() {
            try {
                // Check draft
                const localDraft = localStorage.getItem('pos_draft_variations');
                if (localDraft) {
                    try {
                        const draft = JSON.parse(localDraft);
                        const hasMods = (draft.modifiedVariationTypes && draft.modifiedVariationTypes.length > 0) ||
                            (draft.deletedVariationTypes && draft.deletedVariationTypes.length > 0) ||
                            (draft.modifiedVariationOptions && draft.modifiedVariationOptions.length > 0) ||
                            (draft.deletedVariationOptions && draft.deletedVariationOptions.length > 0);

                        if (hasMods && confirm('Resume unsaved variation changes?')) {
                            variationTypesData = draft.variationTypesData;
                            variationOptionsData = draft.variationOptionsData;
                            modifiedVariationTypes = new Set(draft.modifiedVariationTypes);
                            deletedVariationTypes = new Set(draft.deletedVariationTypes);
                            modifiedVariationOptions = new Set(draft.modifiedVariationOptions);
                            deletedVariationOptions = new Set(draft.deletedVariationOptions);
                            renderVariationTypes();
                            renderVariationOptions();
                            updateModuleSyncStatus('Variations', 'Unsaved Changes (Local)');
                            return;
                        } else if (!hasMods) {
                            localStorage.removeItem('pos_draft_variations');
                        } else {
                            localStorage.removeItem('pos_draft_variations');
                        }
                    } catch (e) {
                        localStorage.removeItem('pos_draft_variations');
                    }
                }

                // Load variation types
                const { data: types, error: typesError } = await supabase
                    .from('variation_types')
                    .select('*')
                    .order('name', { ascending: true });

                if (typesError) throw typesError;

                variationTypesData = types || [];
                renderVariationTypes();

                // Load variation options
                const { data: options, error: optionsError } = await supabase
                    .from('variation_options')
                    .select(`
                        *,
                        variation_types (name)
                    `)
                    .order('option_value', { ascending: true });

                if (optionsError) throw optionsError;

                variationOptionsData = options || [];
                renderVariationOptions();

                // Reset tracking
                modifiedVariationTypes.clear();
                deletedVariationTypes.clear();
                modifiedVariationOptions.clear();
                deletedVariationOptions.clear();
                updateModuleSyncStatus('Variations', 'Synced to Supabase');

                console.log('Variations loaded successfully');
            } catch (error) {
                console.error('Error loading variations:', error);
                alert('Failed to load variations: ' + error.message);
            }
        }

        // Render variation types table
        function renderVariationTypes() {
            const tbody = document.getElementById('variationTypesBody');
            tbody.innerHTML = '';

            variationTypesData.forEach((type, index) => {
                const tr = document.createElement('tr');
                tr.className = 'excel-tr';
                if (modifiedVariationTypes.has(type.id)) tr.classList.add('modified');
                if (type.id && type.id.toString().startsWith('new_')) tr.classList.add('new-row');
                tr.dataset.index = index;

                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td><input type="text" class="excel-input" value="${escapeHtml(type.name || '')}" data-field="name" oninput="markVariationTypeModified(this)"></td>
                    <td><input type="text" class="excel-input" value="${escapeHtml(type.description || '')}" data-field="description" oninput="markVariationTypeModified(this)"></td>
                    <td class="action-cell">
                        <button class="btn-icon" onclick="deleteVariationType(${index})" title="Delete"><i class="fas fa-trash"></i></button>
                    </td>
                `;

                tbody.appendChild(tr);
            });
        }

        // Render variation options table
        function renderVariationOptions() {
            const tbody = document.getElementById('variationOptionsBody');
            tbody.innerHTML = '';

            variationOptionsData.forEach((opt, index) => {
                const tr = document.createElement('tr');
                tr.className = 'excel-tr';
                if (modifiedVariationOptions.has(opt.id)) tr.classList.add('modified');
                if (opt.id && opt.id.toString().startsWith('new_')) tr.classList.add('new-row');
                tr.dataset.index = index;

                // Create type dropdown options
                const typeOptions = variationTypesData.map(type =>
                    `<option value="${type.id}" ${opt.variation_type_id === type.id ? 'selected' : ''}>${escapeHtml(type.name)}</option>`
                ).join('');

                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>
                        <select class="excel-input" data-field="variation_type_id" onchange="markVariationOptionModified(this)">
                            <option value="">Select Type</option>
                            ${typeOptions}
                        </select>
                    </td>
                    <td><input type="text" class="excel-input" value="${escapeHtml(opt.option_value || '')}" data-field="option_value" oninput="markVariationOptionModified(this)"></td>
                    <td class="action-cell">
                        <button class="btn-icon" onclick="deleteVariationOption(${index})" title="Delete"><i class="fas fa-trash"></i></button>
                    </td>
                `;

                tbody.appendChild(tr);
            });
        }
        // Mark variation type as modified
        function markVariationTypeModified(input) {
            const tr = input.closest('tr');
            const index = parseInt(tr.dataset.index);
            const type = variationTypesData[index];
            const field = input.dataset.field;
            const value = input.value;

            variationTypesData[index][input.dataset.field] = input.value;
            modifiedVariationTypes.add(variationTypesData[index].id);

            tr.classList.add('modified');
            saveVariationsDraft();
        }

        // Mark variation option as modified
        function markVariationOptionModified(input) {
            const tr = input.closest('tr');
            const index = parseInt(tr.dataset.index);
            const opt = variationOptionsData[index];
            const field = input.dataset.field;
            const value = input.value;

            variationOptionsData[index][input.dataset.field] = input.value;
            modifiedVariationOptions.add(variationOptionsData[index].id);

            tr.classList.add('modified');
            saveVariationsDraft();
        }

        // Add new variation type row
        function addNewVariationType() {
            const newType = {
                id: crypto.randomUUID(),
                name: '',
                description: '',
                isNew: true
            };

            variationTypesData.push(newType);
            modifiedVariationTypes.add(newType.id);

            renderVariationTypes();
            const lastTr = document.getElementById('variationTypesBody').lastElementChild;
            if (lastTr) lastTr.querySelector('input[data-field="name"]').focus();
            saveVariationsDraft();
        }

        // Add new variation option row
        function addNewVariationOption() {
            const newOption = {
                id: crypto.randomUUID(),
                variation_type_id: '',
                option_value: '',
                isNew: true
            };

            variationOptionsData.push(newOption);
            modifiedVariationOptions.add(newOption.id);

            renderVariationOptions();
            const lastTr = document.getElementById('variationOptionsBody').lastElementChild;
            if (lastTr) lastTr.querySelector('input[data-field="option_value"]').focus();
            saveVariationsDraft();
        }

        // Delete variation type
        function deleteVariationType(index) {
            if (confirm('Are you sure you want to delete this variation type? This will also delete all its options.')) {
                const type = variationTypesData[index];
                if (type.id && !type.id.toString().startsWith('new_')) {
                    deletedVariationTypes.add(type.id);
                }
                modifiedVariationTypes.delete(type.id);
                variationTypesData.splice(index, 1);
                renderVariationTypes();
                saveVariationsDraft();
            }
        }

        // Delete variation option
        function deleteVariationOption(index) {
            if (confirm('Are you sure you want to delete this option?')) {
                const option = variationOptionsData[index];
                if (option.id && !option.id.toString().startsWith('new_')) {
                    deletedVariationOptions.add(option.id);
                }
                modifiedVariationOptions.delete(option.id);
                variationOptionsData.splice(index, 1);
                renderVariationOptions();
                saveVariationsDraft();
            }
        }

        // Save all variation changes
        async function saveVariationChanges() {
            try {
                // Delete types
                if (deletedVariationTypes.size > 0) {
                    const { error: deleteError } = await supabase
                        .from('variation_types')
                        .delete()
                        .in('id', Array.from(deletedVariationTypes));

                    if (deleteError) throw deleteError;
                }

                // Upsert types
                const typesToSave = Array.from(modifiedVariationTypes)
                    .map(id => variationTypesData.find(t => t.id === id))
                    .filter(type => type && type.name);

                if (typesToSave.length > 0) {
                    const { error: upsertError } = await supabase
                        .from('variation_types')
                        .upsert(typesToSave.map(type => {
                            const payload = {
                                name: type.name,
                                description: type.description
                            };
                            if (!type.id.toString().startsWith('new_')) {
                                payload.id = type.id;
                            }
                            return payload;
                        }));

                    if (upsertError) throw upsertError;
                }

                // Delete options
                if (deletedVariationOptions.size > 0) {
                    const { error: deleteError } = await supabase
                        .from('variation_options')
                        .delete()
                        .in('id', Array.from(deletedVariationOptions));

                    if (deleteError) throw deleteError;
                }

                // Upsert options
                const optionsToSave = Array.from(modifiedVariationOptions)
                    .map(id => variationOptionsData.find(o => o.id === id))
                    .filter(opt => opt && opt.option_value && opt.variation_type_id);

                if (optionsToSave.length > 0) {
                    const { error: upsertError } = await supabase
                        .from('variation_options')
                        .upsert(optionsToSave.map(opt => ({
                            id: opt.id,
                            variation_type_id: opt.variation_type_id,
                            option_value: opt.option_value
                        })));

                    if (upsertError) throw upsertError;
                }

                // Capture and Clear
                var delTypes = Array.from(deletedVariationTypes);
                var delOpts = Array.from(deletedVariationOptions);

                modifiedVariationTypes.clear();
                deletedVariationTypes.clear();
                modifiedVariationOptions.clear();
                deletedVariationOptions.clear();
                clearVariationsDraft();

                alert('All changes saved successfully!');

                // Local UI Update
                if (delTypes.length > 0) variationTypesData = variationTypesData.filter(t => delTypes.indexOf(t.id) === -1);
                if (delOpts.length > 0) variationOptionsData = variationOptionsData.filter(o => delOpts.indexOf(o.id) === -1);

                variationTypesData.forEach(t => { if (t.isNew) t.isNew = false; });
                variationOptionsData.forEach(o => { if (o.isNew) o.isNew = false; });

                renderVariationTypes();
                renderVariationOptions();
                loadReferenceData();
                if (!document.getElementById('view-products').classList.contains('hidden')) {
                    renderGrid();
                }
            } catch (error) {
                console.error('Error saving variations:', error);
                alert('Failed to save variations: ' + error.message);
            }
        }

        // =====================================================
        // BRAND MANAGEMENT FUNCTIONS
        // =====================================================

        let brandsData = [];
        let modifiedBrands = new Set();
        let deletedBrands = new Set();

        function saveBrandsDraft() {
            try {
                const draft = { brandsData, modifiedBrands: Array.from(modifiedBrands), deletedBrands: Array.from(deletedBrands) };
                localStorage.setItem('pos_draft_brands', JSON.stringify(draft));
                updateModuleSyncStatus('Brands', 'Unsaved Changes (Local)');
            } catch (e) { console.error(e); }
        }

        function clearBrandsDraft() {
            localStorage.removeItem('pos_draft_brands');
            updateModuleSyncStatus('Brands', 'Synced to Supabase');
        }

        async function loadBrands() {
            try {
                // Check draft
                const localDraft = localStorage.getItem('pos_draft_brands');
                if (localDraft) {
                    try {
                        const draft = JSON.parse(localDraft);
                        const hasMods = (draft.modifiedBrands && draft.modifiedBrands.length > 0) ||
                            (draft.deletedBrands && draft.deletedBrands.length > 0);

                        if (hasMods && confirm('Resume unsaved brand changes?')) {
                            brandsData = draft.brandsData;
                            modifiedBrands = new Set(draft.modifiedBrands);
                            deletedBrands = new Set(draft.deletedBrands);
                            renderBrands();
                            updateModuleSyncStatus('Brands', 'Unsaved Changes (Local)');
                            return;
                        } else {
                            localStorage.removeItem('pos_draft_brands');
                        }
                    } catch (e) {
                        localStorage.removeItem('pos_draft_brands');
                    }
                }

                const { data, error } = await supabase
                    .from('brands')
                    .select('*')
                    .order('name', { ascending: true });

                if (error) throw error;
                brandsData = data || [];
                renderBrands();
                modifiedBrands.clear();
                deletedBrands.clear();
                updateModuleSyncStatus('Brands', 'Synced to Supabase');
            } catch (error) {
                console.error('Error loading brands:', error);
                alert('Failed to load brands');
            }
        }

        function renderBrands() {
            const tbody = document.getElementById('brandsBody');
            tbody.innerHTML = '';
            brandsData.forEach((brand, index) => {
                const tr = document.createElement('tr');
                tr.className = 'excel-tr';
                if (modifiedBrands.has(brand.id)) tr.classList.add('modified');
                if (brand.id && brand.id.toString().startsWith('new_')) tr.classList.add('new-row');
                tr.dataset.index = index;
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td><input type="text" class="excel-input" value="${escapeHtml(brand.name || '')}" data-field="name" oninput="markBrandModified(this)"></td>
                    <td><input type="text" class="excel-input" value="${escapeHtml(brand.description || '')}" data-field="description" oninput="markBrandModified(this)"></td>
                    <td><input type="text" class="excel-input" value="${escapeHtml(brand.website || '')}" data-field="website" oninput="markBrandModified(this)"></td>
                    <td class="action-cell"><button class="btn-icon" onclick="deleteBrand(${index})"><i class="fas fa-trash"></i></button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function markBrandModified(input) {
            const tr = input.closest('tr');
            const index = parseInt(tr.dataset.index);
            const brand = brandsData[index];
            brand[input.dataset.field] = input.value;
            modifiedBrands.add(brand.id);
            tr.classList.add('modified');
            saveBrandsDraft();
        }

        function addNewBrand() {
            const newBrand = { id: crypto.randomUUID(), name: '', description: '', website: '', isNew: true };
            brandsData.push(newBrand);
            modifiedBrands.add(newBrand.id);
            renderBrands();
            const lastTr = document.getElementById('brandsBody').lastElementChild;
            if (lastTr) lastTr.querySelector('input[data-field="name"]').focus();
            saveBrandsDraft();
        }

        function deleteBrand(index) {
            if (confirm('Delete this brand?')) {
                const brand = brandsData[index];
                if (brand.id && !brand.id.toString().startsWith('new_')) {
                    deletedBrands.add(brand.id);
                }
                modifiedBrands.delete(brand.id);
                brandsData.splice(index, 1);
                renderBrands();
                saveBrandsDraft();
            }
        }

        async function saveBrandChanges() {
            try {
                // Delete
                if (deletedBrands.size > 0) {
                    await supabase.from('brands').delete().in('id', Array.from(deletedBrands));
                }

                // Upsert
                const toSave = Array.from(modifiedBrands)
                    .map(id => brandsData.find(b => b.id === id))
                    .filter(b => b && b.name);

                if (toSave.length > 0) {
                    const { error } = await supabase.from('brands').upsert(toSave.map(b => ({
                        id: b.id,
                        name: b.name,
                        description: b.description,
                        website: b.website
                    })));
                    if (error) throw error;
                }

                var delBrands = Array.from(deletedBrands);
                modifiedBrands.clear();
                deletedBrands.clear();
                clearBrandsDraft();

                alert('Saved!');

                if (delBrands.length > 0) brandsData = brandsData.filter(b => delBrands.indexOf(b.id) === -1);
                brandsData.forEach(b => { if (b.isNew) b.isNew = false; });

                renderBrands();
                loadReferenceData();
                if (!document.getElementById('view-products').classList.contains('hidden')) {
                    renderGrid();
                }
            } catch (e) {
                console.error(e);
                alert('Error saving: ' + e.message);
            }
        }

        // =====================================================
        // UNIT MANAGEMENT FUNCTIONS
        // =====================================================

        let unitsData = [];
        let modifiedUnits = new Set();
        let deletedUnits = new Set();

        function saveUnitsDraft() {
            try {
                const draft = { unitsData, modifiedUnits: Array.from(modifiedUnits), deletedUnits: Array.from(deletedUnits) };
                localStorage.setItem('pos_draft_units', JSON.stringify(draft));
                updateModuleSyncStatus('Units', 'Unsaved Changes (Local)');
            } catch (e) { console.error(e); }
        }

        function clearUnitsDraft() {
            localStorage.removeItem('pos_draft_units');
            updateModuleSyncStatus('Units', 'Synced to Supabase');
        }

        async function loadUnits() {
            try {
                // Check draft
                const localDraft = localStorage.getItem('pos_draft_units');
                if (localDraft) {
                    try {
                        const draft = JSON.parse(localDraft);
                        const hasMods = (draft.modifiedUnits && draft.modifiedUnits.length > 0) ||
                            (draft.deletedUnits && draft.deletedUnits.length > 0);

                        if (hasMods && confirm('Resume unsaved unit changes?')) {
                            unitsData = draft.unitsData;
                            modifiedUnits = new Set(draft.modifiedUnits);
                            deletedUnits = new Set(draft.deletedUnits);
                            renderUnits();
                            updateModuleSyncStatus('Units', 'Unsaved Changes (Local)');
                            return;
                        } else {
                            localStorage.removeItem('pos_draft_units');
                        }
                    } catch (e) {
                        localStorage.removeItem('pos_draft_units');
                    }
                }

                const { data, error } = await supabase.from('units').select('*').order('name');
                if (error) throw error;
                unitsData = data || [];
                renderUnits();
                modifiedUnits.clear();
                deletedUnits.clear();
                updateModuleSyncStatus('Units', 'Synced to Supabase');
            } catch (e) { console.error(e); alert('Failed to load units'); }
        }

        function renderUnits() {
            const tbody = document.getElementById('unitsBody');
            tbody.innerHTML = '';
            unitsData.forEach((u, index) => {
                const tr = document.createElement('tr');
                tr.className = 'excel-tr';
                if (modifiedUnits.has(u.id)) tr.classList.add('modified');
                if (u.id && u.id.toString().startsWith('new_')) tr.classList.add('new-row');
                tr.dataset.index = index;
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td><input type="text" class="excel-input" value="${escapeHtml(u.name || '')}" data-field="name" oninput="markUnitModified(this)"></td>
                    <td><input type="text" class="excel-input" value="${escapeHtml(u.short_name || '')}" data-field="short_name" oninput="markUnitModified(this)"></td>
                    <td style="text-align: center;"><input type="checkbox" ${u.allow_decimals ? 'checked' : ''} onchange="markUnitModified(this, true)" data-field="allow_decimals"></td>
                    <td class="action-cell"><button class="btn-icon" onclick="deleteUnit(${index})"><i class="fas fa-trash"></i></button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function markUnitModified(input, isCheckbox = false) {
            const tr = input.closest('tr');
            const index = parseInt(tr.dataset.index);
            const unit = unitsData[index];
            const val = isCheckbox ? input.checked : input.value;
            unit[input.dataset.field] = val;
            modifiedUnits.add(unit.id);
            tr.classList.add('modified');
            saveUnitsDraft();
        }

        function addNewUnit() {
            const newUnit = { id: crypto.randomUUID(), name: '', short_name: '', allow_decimals: false, isNew: true };
            unitsData.push(newUnit);
            modifiedUnits.add(newUnit.id);
            renderUnits();
            const lastTr = document.getElementById('unitsBody').lastElementChild;
            if (lastTr) lastTr.querySelector('input[data-field="name"]').focus();
            saveUnitsDraft();
        }

        function deleteUnit(index) {
            if (confirm('Delete unit?')) {
                const unit = unitsData[index];
                if (unit.id && !unit.id.toString().startsWith('new_')) {
                    deletedUnits.add(unit.id);
                }
                modifiedUnits.delete(unit.id);
                unitsData.splice(index, 1);
                renderUnits();
                saveUnitsDraft();
            }
        }

        async function saveUnitChanges() {
            try {
                if (deletedUnits.size > 0) {
                    await supabase.from('units').delete().in('id', Array.from(deletedUnits));
                }
                const toSave = Array.from(modifiedUnits)
                    .map(id => unitsData.find(u => u.id === id))
                    .filter(u => u && u.name && u.short_name);

                if (toSave.length > 0) {
                    const { error } = await supabase.from('units').upsert(toSave.map(u => ({
                        id: u.id,
                        name: u.name,
                        short_name: u.short_name,
                        allow_decimals: u.allow_decimals
                    })));
                    if (error) throw error;
                }

                var delUnits = Array.from(deletedUnits);
                modifiedUnits.clear();
                deletedUnits.clear();
                clearUnitsDraft();

                alert('Saved!');

                if (delUnits.length > 0) unitsData = unitsData.filter(u => delUnits.indexOf(u.id) === -1);
                unitsData.forEach(u => { if (u.isNew) u.isNew = false; });

                renderUnits();
                loadReferenceData();
                if (!document.getElementById('view-products').classList.contains('hidden')) {
                    renderGrid();
                }
            } catch (e) { console.error(e); alert('Error saving: ' + e.message); }
        }

        // =====================================================
        // IMPORT / EXPORT FUNCTIONS
        // =====================================================

        function getCategoryName(id) {
            if (!id) return '';
            const c = refCategories.find(x => x.id === id);
            return c ? c.name : '';
        }
        function getSubcategoryName(id) {
            if (!id) return '';
            const s = refSubcategories.find(x => x.id === id);
            return s ? s.name : '';
        }
        function getBrandName(id) {
            if (!id) return '';
            const b = refBrands.find(x => x.id === id);
            return b ? b.name : '';
        }

        function exportToExcel() {
            if (productsData.length === 0) {
                alert("No products to export.");
                return;
            }

            const headers = ['Item Code', 'Barcodes', 'Description', 'Category', 'Sub-Category', 'Brand', 'Cost', 'Price', 'Margin %', 'Unit Type (pcs/box)', 'Supplier', 'Shop', 'Stock'];

            const csvRows = [];
            // Add Header
            csvRows.push(headers.join(','));

            // Add Data
            productsData.forEach(p => {
                let margin = 0;
                if (p.price && p.cost && p.cost > 0) {
                    margin = ((p.price - p.cost) / p.cost) * 100;
                }

                const row = [
                    `"${(p.item_code || '').replace(/"/g, '""')}"`,
                    `"${(p.barcodes || []).join('; ').replace(/"/g, '""')}"`,
                    `"${(p.name || '').replace(/"/g, '""')}"`,
                    `"${getCategoryName(p.category_id).replace(/"/g, '""')}"`,
                    `"${getSubcategoryName(p.subcategory_id).replace(/"/g, '""')}"`,
                    `"${getBrandName(p.brand_id).replace(/"/g, '""')}"`,
                    p.cost || 0,
                    p.price || 0,
                    margin.toFixed(2),
                    p.pcs_per_box || 1,
                    `"${(p.supplier || '').replace(/"/g, '""')}"`,
                    `"${(p.shop || '').replace(/"/g, '""')}"`,
                    p.stock || 0
                ];
                csvRows.push(row.join(','));
            });

            const csvString = csvRows.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "products_export_" + new Date().toISOString().split('T')[0] + ".csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function openExcelImport() {
            document.getElementById('excelInput').click();
        }

        function handleExcelImport(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                const text = e.target.result;
                alert("Import feature is currently in CSV mode.\nReceived " + text.length + " bytes.\nFull parsing logic coming in next update.");
                // Placeholder for parsing logic
                console.log("CSV Content:", text.substring(0, 200) + "...");
            };
            reader.readAsText(file);
            // Reset input so same file can be selected again
            input.value = '';
        }

        // =====================================================
        // SEARCH & KEYBINDS
        // =====================================================

        function setupGlobalSearch() {
            const searchInput = document.getElementById('globalSearchInput');
            if (!searchInput) return;

            searchInput.addEventListener('input', function (e) {
                const query = e.target.value;
                const currentView = new URLSearchParams(window.location.search).get('view');

                // Currently only supporting Product filter
                if (currentView === 'products' || !currentView) {
                    filterProducts(query);
                }
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function getCategoryName(id) {
            if (!id) return '';
            const cat = categoriesData.find(c => c.id === id);
            return cat ? cat.name : '';
        }

        function getSubcategoryName(id) {
            if (!id) return '';
            const sub = subcategoriesData.find(s => s.id === id);
            return sub ? sub.name : '';
        }

        function getBrandName(id) {
            if (!id) return '';
            const brand = brandsData.find(b => b.id === id);
            return brand ? brand.name : '';
        }

        function getUnitName(id) {
            if (!id) return '';
            const unit = unitsData.find(u => u.id === id);
            return unit ? unit.name : '';
        }

        function filterProducts(query) {
            const q = query.toLowerCase();
            const rows = document.querySelectorAll('.stacked-row');

            rows.forEach(row => {
                const id = row.dataset.id;
                const product = productsData.find(p => p.id.toString() === id.toString());

                if (!product) return;

                const categoryName = getCategoryName(product.category_id).toLowerCase();
                const subContext = getSubcategoryName(product.subcategory_id).toLowerCase();
                const brandName = getBrandName(product.brand_id).toLowerCase();

                const match = !q ||
                    (product.name || '').toLowerCase().includes(q) ||
                    (product.item_code || '').toLowerCase().includes(q) ||
                    (product.supplier || '').toLowerCase().includes(q) ||
                    (product.shop || '').toLowerCase().includes(q) ||
                    categoryName.includes(q) ||
                    subContext.includes(q) ||
                    brandName.includes(q) ||
                    (product.barcodes || []).some(bc => bc.toLowerCase().includes(q));

                row.style.display = match ? 'flex' : 'none';
            });
        }

        // =====================================================
        // PURCHASE MANAGEMENT FUNCTIONS
        // =====================================================

        async function loadSuppliers() {
            try {
                const { data, error } = await supabase.from('suppliers').select('*').order('name');
                if (error) throw error;
                suppliersData = data || [];
                const supplierSelect = document.getElementById('purchaseAddSupplier');
                if (supplierSelect) {
                    // Destroy existing instance if any
                    if (supplierSelect.tomselect) supplierSelect.tomselect.destroy();

                    supplierSelect.innerHTML = '<option value="">Choose Supplier</option>';
                    suppliersData.forEach(s => {
                        supplierSelect.innerHTML += `<option value="${s.id}">${s.name}</option>`;
                    });

                    // Initialize TomSelect with Create option
                    new TomSelect(supplierSelect, {
                        create: true,
                        sortField: { field: "text", direction: "asc" },
                        placeholder: "Select or Type Supplier..."
                    });
                }
            } catch (e) {
                console.error('Error loading suppliers:', e);
            }
        }

        async function loadWarehouses() {
            try {
                const { data, error } = await supabase.from('warehouses').select('*').order('name');
                if (error) throw error;
                warehousesData = data || [];
                const warehouseSelect = document.getElementById('purchaseAddWarehouse');
                if (warehouseSelect) {
                    // Destroy existing instance if any
                    if (warehouseSelect.tomselect) warehouseSelect.tomselect.destroy();

                    warehouseSelect.innerHTML = '<option value="">Choose Warehouse</option>';
                    warehousesData.forEach(w => {
                        warehouseSelect.innerHTML += `<option value="${w.id}">${w.name}</option>`;
                    });

                    // Initialize TomSelect
                    new TomSelect(warehouseSelect, {
                        create: false,
                        sortField: { field: "text", direction: "asc" },
                        placeholder: "Select Warehouse..."
                    });
                }
            } catch (e) {
                console.error('Error loading warehouses:', e);
            }
        }

        function searchProductsForPurchase(input) {
            const query = input.value.toLowerCase();
            const dropdown = document.getElementById('purchaseSearchDropdown');
            if (query.length < 2) {
                dropdown.classList.add('hidden');
                return;
            }

            const results = productsData.filter(p =>
                (p.name || '').toLowerCase().includes(query) ||
                (p.item_code || '').toLowerCase().includes(query)
            ).slice(0, 10);

            if (results.length > 0) {
                dropdown.innerHTML = '';
                results.forEach(p => {
                    const item = document.createElement('div');
                    item.className = 'search-result-item';
                    item.innerHTML = `
                        <div class="search-result-name">${p.name}</div>
                        <div class="search-result-code">${p.item_code}</div>
                    `;
                    item.onclick = () => {
                        addProductToPurchase(p);
                        input.value = '';
                        dropdown.classList.add('hidden');
                    };
                    dropdown.appendChild(item);
                });
                dropdown.classList.remove('hidden');
            } else {
                dropdown.classList.add('hidden');
            }
        }

        function addProductToPurchase(product) {
            // Check if already in list
            const existing = purchaseItems.find(item => item.product_id === product.id);
            if (existing) {
                existing.quantity++;
            } else {
                purchaseItems.push({
                    product_id: product.id,
                    product_name: product.name,
                    unit_cost: product.cost || 0,
                    stock: product.stock || 0,
                    unit: getUnitName(product.unit_id),
                    pcs_per_box: product.pcs_per_box || 1,
                    quantity: 1,
                    discount: 0,
                    tax: 0,
                    subtotal: product.cost || 0
                });
            }
            renderPurchaseItems();
            calculatePurchaseTotals();
        }

        function renderPurchaseItems() {
            const body = document.getElementById('purchaseAddItemsBody');
            if (!body) return;

            if (purchaseItems.length === 0) {
                body.innerHTML = `
                    <div class="text-center text-muted" style="padding: 40px; background: var(--bg-secondary); border-radius: var(--radius-md);">
                        <i class="fas fa-shopping-basket fa-3x mb-md" style="opacity: 0.2;"></i>
                        <p>No products added. Use the search bar above to add items.</p>
                    </div>
                `;
                return;
            }

            body.innerHTML = '';
            purchaseItems.forEach((item, index) => {
                const container = document.createElement('div');
                container.className = 'stacked-row fade-in';

                const totalPcs = item.quantity * (item.pcs_per_box || 1);
                const showBoxInfo = item.pcs_per_box > 1;

                container.innerHTML = `
                    <div class="stacked-line">
                        <div class="grid-field" style="flex: 2;">
                            <span class="field-label">Product</span>
                            <div style="padding: 10px 12px; font-weight: 600; color: var(--primary-light);">${escapeHtml(item.product_name)}</div>
                        </div>
                        <div class="grid-field" style="flex: 0.2; min-width: 50px; border-right: none; align-items: center; justify-content: center;">
                            <button class="btn-icon" onclick="removePurchaseItem(${index})" style="color: var(--error);"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </div>
                    <div class="stacked-line" style="background: rgba(255,255,255,0.02);">
                        <div class="grid-field">
                            <span class="field-label">Net Unit Cost (Ks)</span>
                            <input type="number" class="excel-input" value="${item.unit_cost}" oninput="updatePurchaseItem(${index}, 'unit_cost', this.value)">
                        </div>
                        <div class="grid-field" style="flex: 0.5; min-width: 80px;">
                            <span class="field-label">Current Stock</span>
                            <div style="padding: 10px 12px; color: var(--text-muted);">${item.stock}</div>
                        </div>
                        <div class="grid-field" style="flex: 0.5; min-width: 80px;">
                            <span class="field-label">Unit</span>
                            <div style="padding: 10px 12px; color: var(--text-muted);">${escapeHtml(item.unit)}</div>
                        </div>
                        ${showBoxInfo ? `
                        <div class="grid-field" style="flex: 0.5; background: rgba(16, 185, 129, 0.05);">
                            <span class="field-label" style="color: #10b981;">Pcs/Box</span>
                            <div style="padding: 10px 12px; font-weight: 700;">${item.pcs_per_box}</div>
                        </div>
                        ` : ''}
                        <div class="grid-field">
                            <span class="field-label">Order Qty (Boxes/Pcs)</span>
                            <input type="number" class="excel-input" value="${item.quantity}" oninput="updatePurchaseItem(${index}, 'quantity', this.value)">
                        </div>
                        ${showBoxInfo ? `
                        <div class="grid-field" style="background: rgba(16, 185, 129, 0.05); flex: 0.7;">
                            <span class="field-label" style="color: #10b981;">Total Pcs Received</span>
                            <div style="padding: 10px 12px; font-weight: 700; color: #10b981;">${totalPcs} Pcs</div>
                        </div>
                        ` : ''}
                    </div>
                    <div class="stacked-line border-none">
                        <div class="grid-field">
                            <span class="field-label">Discount (Ks)</span>
                            <input type="number" class="excel-input" value="${item.discount}" oninput="updatePurchaseItem(${index}, 'discount', this.value)">
                        </div>
                        <div class="grid-field">
                            <span class="field-label">Tax (%)</span>
                            <input type="number" class="excel-input" value="${item.tax}" oninput="updatePurchaseItem(${index}, 'tax', this.value)">
                        </div>
                        <div class="grid-field" style="background: rgba(99, 102, 241, 0.05);">
                            <span class="field-label" style="color: var(--primary-light);">Subtotal</span>
                            <div style="padding: 10px 12px; font-weight: 900; color: var(--primary-light); font-size: 1.1rem;">
                                <span id="subtotal-${index}">${item.subtotal.toFixed(2)}</span> Ks
                            </div>
                        </div>
                    </div>
                `;
                body.appendChild(container);
            });
        }

        function updatePurchaseItem(index, field, value) {
            const item = purchaseItems[index];
            item[field] = parseFloat(value) || 0;

            // Calculate item subtotal
            const baseAmount = item.unit_cost * item.quantity;
            const discounted = baseAmount - item.discount;
            const taxed = discounted * (1 + (item.tax / 100));
            item.subtotal = taxed;

            document.getElementById(`subtotal-${index}`).textContent = item.subtotal.toFixed(2);
            calculatePurchaseTotals();
        }

        function removePurchaseItem(index) {
            purchaseItems.splice(index, 1);
            renderPurchaseItems();
            calculatePurchaseTotals();
        }

        function calculatePurchaseTotals() {
            const itemsSubtotal = purchaseItems.reduce((sum, item) => sum + item.subtotal, 0);

            const orderTaxPercent = parseFloat(document.getElementById('purchaseOrderTax').value) || 0;
            const discountKs = parseFloat(document.getElementById('purchaseDiscount').value) || 0;
            const shippingKs = parseFloat(document.getElementById('purchaseShipping').value) || 0;

            const orderTaxAmount = itemsSubtotal * (orderTaxPercent / 100);
            const grandTotal = itemsSubtotal + orderTaxAmount - discountKs + shippingKs;

            const status = document.getElementById('purchasePaymentStatus').value;
            let paidAmount = 0;

            if (status === 'Paid') {
                paidAmount = grandTotal;
                document.getElementById('purchasePaidAmount').value = paidAmount.toFixed(2);
            } else if (status === 'Unpaid') {
                paidAmount = 0;
                document.getElementById('purchasePaidAmount').value = paidAmount.toFixed(2);
            } else {
                // Partial - use manual input
                paidAmount = parseFloat(document.getElementById('purchasePaidAmount').value) || 0;
            }

            const balance = grandTotal - paidAmount;

            document.getElementById('summaryOrderTax').textContent = `${orderTaxAmount.toFixed(2)} Ks (${orderTaxPercent.toFixed(2)}) %`;
            document.getElementById('summaryDiscount').textContent = `${discountKs.toFixed(2)} Ks`;
            document.getElementById('summaryShipping').textContent = `${shippingKs.toFixed(2)} Ks`;
            document.getElementById('summaryGrandTotal').textContent = `${grandTotal.toFixed(2)} Ks`;
            document.getElementById('summaryPaid').textContent = `${paidAmount.toFixed(2)} Ks`;
            document.getElementById('summaryBalance').textContent = `${balance.toFixed(2)} Ks`;
        }

        function updatePaymentVisibility() {
            const status = document.getElementById('purchasePaymentStatus').value;
            const group = document.getElementById('purchasePaidAmountGroup');

            if (status === 'Partial') {
                group.classList.remove('hidden');
            } else {
                group.classList.add('hidden');
            }

            calculatePurchaseTotals();
        }

        async function savePurchase() {
            if (purchaseItems.length === 0) {
                alert('Please add at least one product.');
                return;
            }

            const supplierId = document.getElementById('purchaseAddSupplier').value;
            if (!supplierId) {
                alert('Please select a supplier.');
                return;
            }

            try {
                showLoading();

                const purchaseData = {
                    date: document.getElementById('purchaseAddDate').value,
                    supplier_id: supplierId,
                    warehouse_id: document.getElementById('purchaseAddWarehouse').value || null,
                    status: document.getElementById('purchaseStatus').value,
                    payment_type: document.getElementById('purchasePaymentType').value,
                    payment_status: document.getElementById('purchasePaymentStatus').value,
                    paid_amount: parseFloat(document.getElementById('purchasePaidAmount').value) || 0,
                    order_tax_percentage: parseFloat(document.getElementById('purchaseOrderTax').value) || 0,
                    discount_amount: parseFloat(document.getElementById('purchaseDiscount').value) || 0,
                    shipping_amount: parseFloat(document.getElementById('purchaseShipping').value) || 0,
                    grand_total: parseFloat(document.getElementById('summaryGrandTotal').textContent.split(' ')[0]) || 0,
                    note: document.getElementById('purchaseNote').value,
                    created_by: currentUser.id
                };

                // Insert purchase
                const { data: purchase, error: pError } = await supabase
                    .from('purchases')
                    .insert(purchaseData)
                    .select()
                    .single();

                if (pError) throw pError;

                // Insert items
                const itemsToInsert = purchaseItems.map(item => ({
                    purchase_id: purchase.id,
                    product_id: item.product_id,
                    quantity: item.quantity,
                    unit_cost: item.unit_cost,
                    discount_amount: item.discount,
                    tax_percentage: item.tax,
                    subtotal: item.subtotal
                }));

                const { error: itemsError } = await supabase
                    .from('purchase_items')
                    .insert(itemsToInsert);

                if (itemsError) throw itemsError;

                // Inventory Update Logic
                if (purchaseData.status === 'Received') {
                    for (const item of purchaseItems) {
                        const incrementAmount = item.quantity * (item.pcs_per_box || 1);
                        const { error: stockError } = await supabase.rpc('increment_stock', {
                            row_id: item.product_id,
                            amount: incrementAmount
                        });

                        if (stockError) {
                            console.error(`Failed to update stock for product ${item.product_id}:`, stockError);
                            // Optional: Alert user but don't stop the whole process as the purchase is already saved
                        }
                    }
                    // Refresh products data to reflect new stock levels
                    await loadProducts(true);
                }

                alert('Purchase saved successfully!');
                switchView('purchase-manager');
            } catch (e) {
                console.error('Error saving purchase:', e);
                alert('Failed to save purchase: ' + e.message);
            } finally {
                hideLoading();
            }
        }

        async function loadPurchases() {
            try {
                showLoading();
                const { data, error } = await supabase
                    .from('purchases')
                    .select(`
                        *,
                        suppliers (name),
                        warehouses (name)
                    `)
                    .order('date', { ascending: false });

                if (error) throw error;

                const body = document.getElementById('purchaseBody');
                body.innerHTML = '';

                if (!data || data.length === 0) {
                    body.innerHTML = `
                        <div class="text-center text-muted" style="padding: 40px; background: var(--bg-secondary); border-radius: var(--radius-md);">
                            <i class="fas fa-inbox fa-3x mb-md" style="opacity: 0.2;"></i>
                            <p>No purchases found. Click "Add Purchase" to create one.</p>
                        </div>
                    `;
                    return;
                }

                data.forEach(p => {
                    const balance = p.grand_total - (p.paid_amount || 0);
                    const container = document.createElement('div');
                    container.className = 'stacked-row fade-in';

                    container.innerHTML = `
                        <div class="stacked-line">
                            <div class="grid-field" style="flex: 1;">
                                <span class="field-label">Reference</span>
                                <div style="padding: 10px 12px; font-weight: 600; color: var(--primary-light);">${escapeHtml(p.reference_no || '-')}</div>
                            </div>
                            <div class="grid-field" style="flex: 1;">
                                <span class="field-label">Date</span>
                                <div style="padding: 10px 12px; color: var(--text-muted);">${p.date}</div>
                            </div>
                            <div class="grid-field" style="flex: 1.5;">
                                <span class="field-label">Supplier</span>
                                <div style="padding: 10px 12px; font-weight: 600;">${p.suppliers ? escapeHtml(p.suppliers.name) : 'N/A'}</div>
                            </div>
                            <div class="grid-field" style="flex: 0.5; min-width: 100px; border-right: none; align-items: center; justify-content: center; flex-direction: row; gap: 10px;">
                                <button class="btn-icon" title="View" style="color: var(--primary-light);"><i class="fas fa-eye"></i></button>
                                <button class="btn-icon" title="Print" style="color: var(--text-muted);"><i class="fas fa-print"></i></button>
                            </div>
                        </div>
                        <div class="stacked-line border-none" style="background: rgba(255,255,255,0.02);">
                            <div class="grid-field">
                                <span class="field-label">Warehouse</span>
                                <div style="padding: 10px 12px;">${p.warehouses ? escapeHtml(p.warehouses.name) : 'N/A'}</div>
                            </div>
                            <div class="grid-field">
                                <span class="field-label">Status</span>
                                <div style="padding: 8px 12px;"><span class="badge badge-${p.status.toLowerCase()}">${p.status}</span></div>
                            </div>
                            <div class="grid-field">
                                <span class="field-label">Grand Total</span>
                                <div style="padding: 10px 12px; font-weight: 700;">${p.grand_total.toFixed(2)} Ks</div>
                            </div>
                            <div class="grid-field">
                                <span class="field-label">Paid</span>
                                <div style="padding: 10px 12px; color: #10b981; font-weight: 700;">${(p.paid_amount || 0).toFixed(2)} Ks</div>
                            </div>
                            <div class="grid-field">
                                <span class="field-label">Balance</span>
                                <div style="padding: 10px 12px; color: var(--error); font-weight: 700;">${balance.toFixed(2)} Ks</div>
                            </div>
                            <div class="grid-field">
                                <span class="field-label">Payment Status</span>
                                <div style="padding: 8px 12px;"><span class="badge badge-${p.payment_status.toLowerCase()}">${p.payment_status}</span></div>
                            </div>
                        </div>
                    `;
                    body.appendChild(container);
                });
            } catch (e) {
                console.error('Error loading purchases:', e);
            } finally {
                hideLoading();
            }
        }

        // =====================================================
        // PURCHASE RETURN FUNCTIONS
        // =====================================================

        let returnItems = [];

        async function loadPurchaseReturns() {
            try {
                showLoading();
                const { data, error } = await supabase
                    .from('purchase_returns')
                    .select(`
                        *,
                        suppliers (name),
                        warehouses (name)
                    `)
                    .order('date', { ascending: false });

                if (error) throw error;

                const body = document.getElementById('purchaseReturnBody');
                body.innerHTML = '';

                if (!data || data.length === 0) {
                    body.innerHTML = `
                        <div class="text-center text-muted" style="padding: 40px; background: var(--bg-secondary); border-radius: var(--radius-md);">
                            <i class="fas fa-undo fa-3x mb-md" style="opacity: 0.2;"></i>
                            <p>No purchase returns found.</p>
                        </div>
                    `;
                    return;
                }

                data.forEach(r => {
                    const balance = r.total - (r.paid_amount || 0);
                    const container = document.createElement('div');
                    container.className = 'stacked-row fade-in';

                    container.innerHTML = `
                        <div class="stacked-line">
                            <div class="grid-field" style="flex: 1;">
                                <span class="field-label">Reference</span>
                                <div style="padding: 10px 12px; font-weight: 600; color: var(--primary-light);">${escapeHtml(r.reference_no || '-')}</div>
                            </div>
                            <div class="grid-field" style="flex: 1;">
                                <span class="field-label">Date</span>
                                <div style="padding: 10px 12px; color: var(--text-muted);">${r.date}</div>
                            </div>
                            <div class="grid-field" style="flex: 1.5;">
                                <span class="field-label">Supplier</span>
                                <div style="padding: 10px 12px; font-weight: 600;">${r.suppliers ? escapeHtml(r.suppliers.name) : 'N/A'}</div>
                            </div>
                            <div class="grid-field" style="flex: 0.5; min-width: 100px; border-right: none; align-items: center; justify-content: center; flex-direction: row; gap: 10px;">
                                <button class="btn-icon" title="View" style="color: var(--primary-light);"><i class="fas fa-eye"></i></button>
                            </div>
                        </div>
                        <div class="stacked-line border-none" style="background: rgba(255,255,255,0.02);">
                            <div class="grid-field">
                                <span class="field-label">Warehouse</span>
                                <div style="padding: 10px 12px;">${r.warehouses ? escapeHtml(r.warehouses.name) : 'N/A'}</div>
                            </div>
                            <div class="grid-field">
                                <span class="field-label">Status</span>
                                <div style="padding: 8px 12px;"><span class="badge badge-success">${r.status}</span></div>
                            </div>
                            <div class="grid-field">
                                <span class="field-label">Grand Total</span>
                                <div style="padding: 10px 12px; font-weight: 700;">${(r.total || 0).toFixed(2)} Ks</div>
                            </div>
                        </div>
                    `;
                    body.appendChild(container);
                });
            } catch (e) {
                console.error('Error loading returns:', e);
            } finally {
                hideLoading();
            }
        }

        async function initPurchaseReturnAdd() {
            // Reset form
            returnItems = [];
            document.getElementById('returnAddDate').valueAsDate = new Date();
            document.getElementById('returnAddWarehouse').value = '';
            document.getElementById('returnAddSupplier').value = '';
            document.getElementById('returnProductSearch').value = '';
            document.getElementById('returnOrderTax').value = '0.00';
            document.getElementById('returnDiscount').value = '0.00';
            document.getElementById('returnShipping').value = '0.00';
            document.getElementById('returnNote').value = '';

            // Populate Dropdowns
            const whSelect = document.getElementById('returnAddWarehouse');
            whSelect.innerHTML = '<option value="">Choose Warehouse</option>';
            warehousesData.forEach(w => {
                whSelect.innerHTML += `<option value="${w.id}">${escapeHtml(w.name)}</option>`;
            });

            const supSelect = document.getElementById('returnAddSupplier');
            supSelect.innerHTML = '<option value="">Choose Supplier</option>';
            suppliersData.forEach(s => {
                supSelect.innerHTML += `<option value="${s.id}">${escapeHtml(s.name)}</option>`;
            });

            // Pre-load reference data if missing
            if (productsData.length === 0) await loadProducts();
            if (categoriesData.length === 0) await loadCategories();
            if (brandsData.length === 0) await loadBrands();
            if (unitsData.length === 0) await loadUnits();

            renderReturnItems();
            calculateReturnTotals();
        }

        function searchProductsForReturn(input) {
            const query = input.value.toLowerCase().trim();
            const dropdown = document.getElementById('returnSearchDropdown');
            dropdown.innerHTML = '';

            if (query.length < 1) {
                dropdown.classList.add('hidden');
                return;
            }

            const filtered = productsData.filter(p =>
                (p.name || '').toLowerCase().includes(query) ||
                (p.item_code || '').toLowerCase().includes(query)
            ).slice(0, 5);

            if (filtered.length === 0) {
                dropdown.innerHTML = '<div class="search-item">No products found</div>';
            } else {
                filtered.forEach(p => {
                    const div = document.createElement('div');
                    div.className = 'search-item';
                    div.innerHTML = `
                        <div style="font-weight:600;">${escapeHtml(p.name)}</div>
                        <div style="font-size:0.75rem; color:var(--text-muted);">${escapeHtml(p.item_code)} | Stock: ${p.stock}</div>
                    `;
                    div.onclick = () => {
                        addSelectedItemToReturn(p);
                        input.value = '';
                        dropdown.classList.add('hidden');
                    };
                    dropdown.appendChild(div);
                });
            }
            dropdown.classList.remove('hidden');
        }

        function addSelectedItemToReturn(product) {
            const existing = returnItems.find(item => item.product_id === product.id);
            if (existing) {
                existing.quantity += 1;
            } else {
                returnItems.push({
                    product_id: product.id,
                    name: product.name,
                    item_code: product.item_code,
                    unit_price: product.price || 0,
                    quantity: 1,
                    total: product.price || 0
                });
            }
            renderReturnItems();
            calculateReturnTotals();
        }

        function renderReturnItems() {
            const body = document.getElementById('returnAddItemsBody');
            if (returnItems.length === 0) {
                body.innerHTML = `
                    <div class="text-center text-muted" style="padding: 40px; background: var(--bg-secondary); border-radius: var(--radius-md);">
                        <i class="fas fa-undo fa-3x mb-md" style="opacity: 0.2;"></i>
                        <p>No products added. Use the search bar above to add items for return.</p>
                    </div>
                `;
                return;
            }

            let html = `
                <table class="excel-table">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th style="width:120px;">Unit Price</th>
                            <th style="width:120px;">Quantity</th>
                            <th style="width:120px; text-align:right;">Subtotal</th>
                            <th style="width:50px;"></th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            returnItems.forEach((item, index) => {
                html += `
                    <tr>
                        <td style="padding: 8px 12px;">
                            <div style="font-weight:600;">${escapeHtml(item.name)}</div>
                            <div style="font-size:0.75rem; color:var(--text-muted);">${escapeHtml(item.item_code)}</div>
                        </td>
                        <td>
                            <input type="number" class="excel-input" value="${item.unit_price}" 
                                oninput="updateReturnItem(${index}, 'unit_price', this.value)" style="padding: 4px 8px;">
                        </td>
                        <td>
                            <input type="number" class="excel-input" value="${item.quantity}" 
                                oninput="updateReturnItem(${index}, 'quantity', this.value)" style="padding: 4px 8px;">
                        </td>
                        <td style="text-align:right; font-weight:600; padding-right: 12px;">${(item.unit_price * item.quantity).toFixed(2)}</td>
                        <td style="text-align:center;">
                            <button class="btn-icon" style="color:var(--error);" onclick="removeReturnItem(${index})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;
            body.innerHTML = html;
        }

        function updateReturnItem(index, field, value) {
            const val = parseFloat(value) || 0;
            returnItems[index][field] = val;
            returnItems[index].total = returnItems[index].unit_price * returnItems[index].quantity;
            renderReturnItems();
            calculateReturnTotals();
        }

        function removeReturnItem(index) {
            returnItems.splice(index, 1);
            renderReturnItems();
            calculateReturnTotals();
        }

        function calculateReturnTotals() {
            const taxRate = parseFloat(document.getElementById('returnOrderTax').value) || 0;
            const discount = parseFloat(document.getElementById('returnDiscount').value) || 0;
            const shipping = parseFloat(document.getElementById('returnShipping').value) || 0;

            let subtotal = 0;
            returnItems.forEach(item => {
                subtotal += item.unit_price * item.quantity;
            });

            const taxAmount = subtotal * (taxRate / 100);
            const grandTotal = subtotal + taxAmount + shipping - discount;

            document.getElementById('returnSummaryGrandTotal').innerText = grandTotal.toFixed(2) + ' Ks';
            return grandTotal;
        }

        async function savePurchaseReturn() {
            const date = document.getElementById('returnAddDate').value;
            const warehouse_id = document.getElementById('returnAddWarehouse').value;
            const supplier_id = document.getElementById('returnAddSupplier').value;
            const note = document.getElementById('returnNote').value;

            if (!warehouse_id || !supplier_id || returnItems.length === 0) {
                alert('Please select warehouse, supplier and add items.');
                return;
            }

            const btn = document.getElementById('saveReturnBtn');
            const originalText = btn.innerHTML;

            try {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                showLoading();

                const taxRate = parseFloat(document.getElementById('returnOrderTax').value) || 0;
                const discount = parseFloat(document.getElementById('returnDiscount').value) || 0;
                const shipping = parseFloat(document.getElementById('returnShipping').value) || 0;
                const total = calculateReturnTotals();

                // 1. Insert Return Record
                const { data: returnData, error: returnError } = await supabase
                    .from('purchase_returns')
                    .insert([{
                        date,
                        warehouse_id,
                        supplier_id,
                        tax_rate: taxRate,
                        discount,
                        shipping,
                        total,
                        note,
                        status: 'Completed',
                        reference_no: 'PR-' + Date.now()
                    }])
                    .select();

                if (returnError) throw returnError;
                const returnId = returnData[0].id;

                // 2. Insert Items
                const itemsToInsert = returnItems.map(item => ({
                    return_id: returnId,
                    product_id: item.product_id,
                    quantity: item.quantity,
                    unit_price: item.unit_price,
                    total: item.total
                }));

                const { error: itemsError } = await supabase
                    .from('purchase_return_items')
                    .insert(itemsToInsert);

                if (itemsError) throw itemsError;

                // 3. Update Stock (Decrement)
                for (const item of returnItems) {
                    const { error: stockError } = await supabase.rpc('increment_stock', {
                        row_id: item.product_id,
                        amount: -item.quantity
                    });
                    if (stockError) console.error('Stock Update Error:', stockError);
                }

                alert('Purchase Return saved successfully!');
                switchView('purchase-return');
                loadProducts(true); // Refresh stock levels

            } catch (e) {
                console.error('Error:', e);
                alert('Error: ' + e.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
                hideLoading();
            }
        }

        function resetPurchaseForm() {
            purchaseItems = [];
            document.getElementById('purchaseAddDate').valueAsDate = new Date();
            document.getElementById('purchaseAddWarehouse').value = '';
            document.getElementById('purchaseAddSupplier').value = '';
            document.getElementById('purchaseProductSearch').value = '';
            document.getElementById('purchaseOrderTax').value = '0.00';
            document.getElementById('purchaseDiscount').value = '0.00';
            document.getElementById('purchaseShipping').value = '0.00';
            document.getElementById('purchaseStatus').value = 'Received';
            document.getElementById('purchasePaymentType').value = 'Cash';
            document.getElementById('purchasePaymentStatus').value = 'Unpaid';
            document.getElementById('purchasePaidAmount').value = '0.00';
            document.getElementById('purchasePaidAmountGroup').classList.add('hidden');
            document.getElementById('purchaseNote').value = '';
            renderPurchaseItems();
            calculatePurchaseTotals();
        }

        setupKeybinds();
        // =====================================================
        // BARCODE PRINTING FUNCTIONS
        // =====================================================

        let barcodeQueue = [];

        function searchProductsForBarcode(query) {
            const resultsDiv = document.getElementById('barcodeSearchResults');
            if (!query || query.length < 2) {
                resultsDiv.innerHTML = '';
                resultsDiv.classList.add('hidden');
                return;
            }

            const q = query.toLowerCase();
            const filtered = productsData.filter(p =>
                (p.name || '').toLowerCase().includes(q) ||
                (p.item_code || '').toLowerCase().includes(q) ||
                (p.barcodes || []).some(bc => bc.toLowerCase().includes(q))
            ).slice(0, 10);

            if (filtered.length === 0) {
                resultsDiv.innerHTML = '<div class="search-result-item">No products found</div>';
            } else {
                resultsDiv.innerHTML = filtered.map(p => `
                    <div class="search-result-item" onclick="addToBarcodeQueue('${p.id}')">
                        <div>
                            <div class="search-result-name">${escapeHtml(p.name)}</div>
                            <div class="search-result-code">${escapeHtml(p.item_code || 'No Code')}</div>
                        </div>
                        <i class="fas fa-plus-circle text-primary"></i>
                    </div>
                `).join('');
            }
            resultsDiv.classList.remove('hidden');
        }

        function addToBarcodeQueue(productId) {
            const product = productsData.find(p => p.id.toString() === productId.toString());
            if (!product) return;

            // Check if already in queue
            const existing = barcodeQueue.find(item => item.id.toString() === productId.toString());
            if (existing) {
                existing.quantity++;
            } else {
                barcodeQueue.push({
                    id: product.id,
                    name: product.name,
                    brand: getBrandName(product.brand_id) || 'N/A',
                    price: product.price || 0,
                    barcode: product.barcodes && product.barcodes.length > 0 ? product.barcodes[0] : 'NO BARCODE',
                    quantity: 1
                });
            }

            // Clear search
            document.getElementById('barcodeProductSearch').value = '';
            document.getElementById('barcodeSearchResults').innerHTML = '';
            document.getElementById('barcodeSearchResults').classList.add('hidden');

            renderBarcodeQueue();
        }

        function removeFromBarcodeQueue(index) {
            barcodeQueue.splice(index, 1);
            renderBarcodeQueue();
        }

        function updateBarcodeQuantity(index, val) {
            barcodeQueue[index].quantity = parseInt(val) || 1;
        }

        function clearBarcodeQueue() {
            if (confirm('Clear the print queue?')) {
                barcodeQueue = [];
                renderBarcodeQueue();
            }
        }

        function renderBarcodeQueue() {
            const tbody = document.getElementById('barcodeQueueBody');
            if (barcodeQueue.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center text-muted" style="padding: 40px;">
                            <i class="fas fa-barcode fa-3x mb-md" style="opacity: 0.2;"></i>
                            <p>No products added to print queue yet.</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = barcodeQueue.map((item, index) => `
                <tr class="excel-tr">
                    <td>${index + 1}</td>
                    <td>
                        <div style="font-weight: 600;">${escapeHtml(item.name)}</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">${escapeHtml(item.brand)} | $${parseFloat(item.price).toFixed(2)}</div>
                    </td>
                    <td><code style="background: rgba(255,255,255,0.05); padding: 2px 6px; border-radius: 4px;">${escapeHtml(item.barcode)}</code></td>
                    <td>
                        <input type="number" class="excel-input" value="${item.quantity}" min="1" onchange="updateBarcodeQuantity(${index}, this.value)">
                    </td>
                    <td class="action-cell">
                        <button class="btn-icon" onclick="removeFromBarcodeQueue(${index})"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        function closeBarcodePreview() {
            document.getElementById('barcodePreviewModal').classList.add('hidden');
        }

        function previewBarcodes() {
            if (barcodeQueue.length === 0) {
                alert('Add at least one product to the queue.');
                return;
            }

            const cols = parseInt(document.getElementById('labelCols').value) || 4;
            const widthMatch = document.getElementById('labelWidth').value;
            const heightMatch = document.getElementById('labelHeight').value;

            // Render labels to both preview and printing container
            const previewDisplay = document.getElementById('barcodePreviewDisplay');
            const printContainer = document.getElementById('print-label-container');

            [previewDisplay, printContainer].forEach(container => {
                container.innerHTML = '';
                container.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
                container.style.width = (cols * widthMatch) + 'mm';

                barcodeQueue.forEach((item, idx) => {
                    for (let i = 0; i < item.quantity; i++) {
                        const label = document.createElement('div');
                        label.className = 'barcode-label';
                        label.style.width = widthMatch + 'mm';
                        label.style.height = heightMatch + 'mm';

                        const labelId = `bc-${idx}-${i}-${container.id.startsWith('print') ? 'p' : 'v'}`;

                        label.innerHTML = `
                            <div class="label-brand">${escapeHtml(item.brand)}</div>
                            <div class="label-name">${escapeHtml(item.name)}</div>
                            <svg id="${labelId}" class="label-barcode-svg"></svg>
                            <div class="label-footer">
                                <span class="label-code">${escapeHtml(item.barcode)}</span>
                                <span class="label-price">$${parseFloat(item.price).toFixed(2)}</span>
                            </div>
                        `;
                        container.appendChild(label);

                        // Use JsBarcode to generate the real barcode
                        setTimeout(() => {
                            JsBarcode(`#${labelId}`, item.barcode, {
                                format: "CODE128",
                                width: 1,
                                height: 30,
                                displayValue: false,
                                margin: 0
                            });
                        }, 0);
                    }
                });
            });

            document.getElementById('barcodePreviewModal').classList.remove('hidden');
        }

        // Initialize on page load
        init();
        setupGlobalSearch();

        // User Management Functions
        async function loadUsersList() {
            const tbody = document.getElementById('usersBody');
            try {
                const { data: roles, error } = await supabase
                    .from('user_roles')
                    .select('user_id, role, created_at');

                if (error) throw error;

                tbody.innerHTML = roles.map((u, i) => `
                    <tr class="excel-tr">
                        <td>${i + 1}</td>
                        <td title="${u.user_id}">${u.user_id.substring(0, 8)}...</td>
                        <td><span style="padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; background: ${getRoleBg(u.role)}">${u.role}</span></td>
                        <td>-</td>
                        <td>${new Date(u.created_at).toLocaleDateString()}</td>
                        <td class="action-cell">
                            <button class="btn-icon" onclick="changeUserRole('${u.user_id}', '${u.role}')" title="Change Role">
                                <i class="fas fa-user-tag"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');

                if (roles.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center" style="padding: 20px;">No users found</td></tr>';
                }

            } catch (error) {
                console.error('Error loading users:', error);
                tbody.innerHTML = `<tr><td colspan="6" class="text-center text-error" style="padding: 20px;">Error loading users: ${error.message}</td></tr>`;
            }
        }

        function getRoleBg(role) {
            if (role === 'admin') return 'rgba(239, 68, 68, 0.2)';
            if (role === 'manager') return 'rgba(245, 158, 11, 0.2)';
            return 'rgba(16, 185, 129, 0.2)';
        }

        function showAddUserModal() {
            document.getElementById('addUserModal').classList.remove('hidden');
        }

        function closeAddUserModal() {
            document.getElementById('addUserModal').classList.add('hidden');
            document.getElementById('addUserForm').reset();
        }

        async function handleCreateUser(event) {
            event.preventDefault();
            const email = document.getElementById('newUserEmail').value;
            const password = document.getElementById('newUserPassword').value;
            const role = document.getElementById('newUserRole').value;
            const fullName = document.getElementById('newUserFullName').value;

            const btn = document.getElementById('createUserBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
            btn.disabled = true;

            try {
                // Call the admin-create-user Edge Function
                const { data, error } = await supabase.functions.invoke('admin-create-user', {
                    body: { email, password, role, fullName }
                });

                if (error) throw error;
                if (data && data.error) throw new Error(data.error);

                alert('User created successfully!');
                closeAddUserModal();
                loadUsersList();
            } catch (error) {
                console.error('Error creating user:', error);
                alert('Error creating user: ' + error.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function changeUserRole(userId, currentRole) {
            const newRole = prompt(`Enter new role for user (admin, manager, cashier):`, currentRole);
            if (!newRole || newRole === currentRole) return;

            if (['admin', 'manager', 'cashier'].indexOf(newRole.toLowerCase()) === -1) {
                alert('Invalid role');
                return;
            }

            try {
                const { error } = await supabase
                    .from('user_roles')
                    .update({ role: newRole.toLowerCase() })
                    .eq('user_id', userId);

                if (error) throw error;
                alert('Role updated successfully');
                loadUsersList();
            } catch (error) {
                console.error('Error updating role:', error);
                alert('Error updating role: ' + error.message);
            }
        }

        let selectedItemIndex = -1;

        function setupKeybinds() {
            document.addEventListener('keydown', function (e) {
                const isInput = e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT';

                // Global Shortcuts (Even in Inputs)
                // Ctrl + / or Ctrl + F to focus search
                if ((e.ctrlKey && e.key === '/') || (e.ctrlKey && e.key === 'f')) {
                    e.preventDefault();
                    const search = document.getElementById('globalSearchInput');
                    if (search) search.focus();
                    return;
                }

                // Ctrl + S to save
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    const urlParams = new URLSearchParams(window.location.search);
                    const view = urlParams.get('view');
                    if (view === 'products' || !view) saveAllChanges();
                    else if (view === 'categories') saveCategoryChanges();
                    else if (view === 'brands') saveBrandChanges();
                    else if (view === 'units') saveUnitChanges();
                    else if (view === 'variations') saveVariationChanges();
                    else if (view === 'purchase-add') savePurchase();
                    return;
                }

                // Alt + N to Add New Item
                if (e.altKey && e.key === 'n') {
                    e.preventDefault();
                    const urlParams = new URLSearchParams(window.location.search);
                    const view = urlParams.get('view');
                    if (view === 'products' || !view) addNewRow();
                    else if (view === 'purchase-manager') switchView('purchase-add');
                    else if (view === 'purchase-add') {
                        document.getElementById('purchaseAddDate').focus();
                    }
                    return;
                }

                // Help Modal (?) - Only if NOT in input
                if (!isInput) {
                    if (e.key === '?' || (e.shiftKey && e.key === '?')) {
                        e.preventDefault();
                        openShortcutsModal();
                        return;
                    }
                }

                // Esc
                if (e.key === 'Escape') {
                    if (!document.getElementById('shortcutsModal').classList.contains('hidden')) {
                        closeShortcutsModal();
                        return;
                    }
                    if (!document.getElementById('barcodePreviewModal').classList.contains('hidden')) {
                        closeBarcodePreview();
                        return;
                    }
                    if (isInput) {
                        e.target.blur();
                        return;
                    }
                    // Clear list selection
                    if (selectedItemIndex !== -1) {
                        const rows = document.querySelectorAll('.stacked-row.active, .excel-tr.active');
                        rows.forEach(r => r.classList.remove('active'));
                        selectedItemIndex = -1;
                    }
                }

                // Input Navigation (Excel-like)
                if (isInput) {
                    if (['Enter', 'ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
                        handleInputNavigation(e);
                    }
                    return;
                }

                // Navigation (List Arrows) - Only if NOT in input
                if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
                    e.preventDefault();
                    navigateList(e.key === 'ArrowDown' ? 1 : -1);
                }

                // Action (List Enter) - Only if NOT in input
                if (e.key === 'Enter') {
                    if (selectedItemIndex !== -1) {
                        e.preventDefault();
                        handleEnterOnList();
                    }
                }
            });
        }

        function handleInputNavigation(e) {
            const current = e.target;
            // Get all visible inputs (excluding hidden ones and search bars if desired, but general is fine)
            // We want inputs that are part of the main content usually.
            const allInputs = Array.from(document.querySelectorAll('input:not([type="hidden"]):not([disabled]), select:not([disabled]), textarea:not([disabled])'));

            // Filter to ensure they are visible
            const visibleInputs = allInputs.filter(el => el.offsetParent !== null);
            const currentIndex = visibleInputs.indexOf(current);

            if (currentIndex === -1) return;

            let nextIndex = currentIndex;

            // Enter or Right Arrow -> Next Field
            if (e.key === 'Enter' || e.key === 'ArrowRight') {
                e.preventDefault();
                nextIndex = currentIndex + 1;
            }
            // Left Arrow -> Previous Field
            else if (e.key === 'ArrowLeft') {
                // Don't prevent default if cursor is not at start?
                // For now, strict navigation:
                if (current.selectionStart === 0 && current.selectionEnd === 0) { // Only if at start of text
                    e.preventDefault();
                    nextIndex = currentIndex - 1;
                } else if (e.target.tagName === 'SELECT') { // Selects don't have cursor
                    e.preventDefault();
                    nextIndex = currentIndex - 1;
                } else {
                    return; // Let user move cursor in text
                }
            }
            // Up / Down Arrow -> Geometric/Grid Navigation
            else if (e.key === 'ArrowUp' || e.key === 'ArrowDown') {
                const direction = e.key === 'ArrowDown' ? 1 : -1;

                // Check if we are in a row-based structure
                const row = current.closest('.stacked-row, .excel-tr');
                if (row) {
                    e.preventDefault();
                    // Grid Navigation Logic
                    const inputsInRow = Array.from(row.querySelectorAll('input:not([type="hidden"]), select, textarea'));
                    const colIndex = inputsInRow.indexOf(current);

                    // Find sibling row
                    let siblingRow = direction === 1 ? row.nextElementSibling : row.previousElementSibling;

                    // Skip non-item rows if necessary (e.g. headers)
                    while (siblingRow && !siblingRow.matches('.stacked-row, .excel-tr')) {
                        siblingRow = direction === 1 ? siblingRow.nextElementSibling : siblingRow.previousElementSibling;
                    }

                    if (siblingRow) {
                        const siblingInputs = Array.from(siblingRow.querySelectorAll('input:not([type="hidden"]), select, textarea'));
                        // Try to find input at same index, or closest
                        if (siblingInputs[colIndex]) {
                            siblingInputs[colIndex].focus();
                            // Select text if it's a text input
                            if (siblingInputs[colIndex].select) siblingInputs[colIndex].select();
                            return;
                        }
                    } else {
                        // No sibling row, maybe move to next linear input?
                        // e.g. from last item row to "Notes" field
                        nextIndex = currentIndex + direction;
                    }
                } else {
                    // Not in a grid row? Just linear up/down?
                    // Or let default happen (e.g. number input increment)?
                    // User asked for "arrow for use", implying navigation.
                    // But ArrowUp/Down on select/number is useful.
                    if (current.type === 'number' || current.tagName === 'SELECT') return;

                    e.preventDefault();
                    nextIndex = currentIndex + direction;
                }
            }

            // Boundary checks
            if (nextIndex >= 0 && nextIndex < visibleInputs.length) {
                const target = visibleInputs[nextIndex];
                target.focus();
                if (target.select) target.select();
            }
        }

        function navigateList(direction) {
            // Identify visible list items
            const rows = Array.from(document.querySelectorAll('.stacked-row, .excel-tr'));
            // Filter out hidden or header rows if necessary (simple approach first)
            const visibleRows = rows.filter(r => r.offsetParent !== null && !r.closest('thead')); // simple visibility check

            if (visibleRows.length === 0) return;

            selectedItemIndex += direction;
            if (selectedItemIndex < 0) selectedItemIndex = 0;
            if (selectedItemIndex >= visibleRows.length) selectedItemIndex = visibleRows.length - 1;

            // Remove active class from all
            visibleRows.forEach(r => r.classList.remove('active'));

            // Add active class to selected
            const selected = visibleRows[selectedItemIndex];
            if (selected) {
                selected.classList.add('active');
                selected.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        function handleEnterOnList() {
            const rows = Array.from(document.querySelectorAll('.stacked-row, .excel-tr'));
            const visibleRows = rows.filter(r => r.offsetParent !== null && !r.closest('thead'));
            const selected = visibleRows[selectedItemIndex];

            if (!selected) return;

            // Try to find an "Edit" or "View" button inside
            const editBtn = selected.querySelector('.fa-edit')?.closest('button');
            const viewBtn = selected.querySelector('.fa-eye')?.closest('button');

            if (editBtn) editBtn.click();
            else if (viewBtn) viewBtn.click();
        }

        function openShortcutsModal() {
            document.getElementById('shortcutsModal').classList.remove('hidden');
        }

        function closeShortcutsModal() {
            document.getElementById('shortcutsModal').classList.add('hidden');
        }

        // =====================================================
        // STOCK ADJUSTMENT FUNCTIONS
        // =====================================================

        let adjustmentsData = [];

        async function loadAdjustments() {
            try {
                updateModuleSyncStatus('Adjustments', 'Loading...');
                const { data, error } = await supabase
                    .from('adjustments')
                    .select('*, products(name, item_code)')
                    .order('created_at', { ascending: false });

                if (error) {
                    // If table doesn't exist yet, it's okay, just show empty
                    if (error.code === 'PGRST116' || error.message.includes('not found')) {
                        console.warn('Adjustments table not found. Please run the SQL migration.');
                        adjustmentsData = [];
                    } else {
                        throw error;
                    }
                } else {
                    adjustmentsData = data || [];
                }

                renderAdjustments();
                updateModuleSyncStatus('Adjustments', 'Synced to Supabase');
            } catch (e) {
                console.error('Error loading adjustments:', e);
                updateModuleSyncStatus('Adjustments', 'Error Loading Data');
            }
        }

        function renderAdjustments() {
            const tbody = document.getElementById('adjustmentsBody');
            if (!tbody) return;

            if (adjustmentsData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center text-muted" style="padding: 40px;">
                            <i class="fas fa-history fa-3x mb-md" style="opacity: 0.1;"></i>
                            <p>No adjustments recorded yet.</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = adjustmentsData.map(adj => {
                const date = new Date(adj.created_at);
                const timeStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const productName = adj.products ? adj.products.name : 'Unknown Product';
                const productCode = adj.products ? adj.products.item_code : '-';

                return `
                    <tr class="excel-tr">
                        <td style="color: var(--text-muted); font-size: 0.85rem;">${timeStr}</td>
                        <td>
                            <div style="font-weight:600;">${escapeHtml(productName)}</div>
                            <div style="font-size:0.75rem; color:var(--text-muted);">${escapeHtml(productCode)}</div>
                        </td>
                        <td><span class="badge ${getAdjBadgeClass(adj.type)}">${adj.type}</span></td>
                        <td style="text-align: center; font-weight:700; color: ${adj.quantity < 0 ? 'var(--error)' : 'var(--success)'};">
                            ${adj.quantity > 0 ? '+' : ''}${adj.quantity}
                        </td>
                        <td class="text-muted" style="font-size: 0.9rem;">${escapeHtml(adj.reason || '-')}</td>
                    </tr>
                `;
            }).join('');
        }

        function getAdjBadgeClass(type) {
            switch (type) {
                case 'Damage': return 'badge-error';
                case 'Theft': return 'badge-warning';
                case 'Addition': return 'badge-success';
                default: return 'badge-info';
            }
        }

        function openAdjustmentModal() {
            const modal = document.getElementById('adjustmentModal');
            const select = document.getElementById('adjProduct');

            // Populate product select
            if (select.tomselect) select.tomselect.destroy();
            select.innerHTML = '<option value="">Search Product...</option>';
            productsData.forEach(p => {
                select.innerHTML += `<option value="${p.id}">${escapeHtml(p.name)} (${escapeHtml(p.item_code)})</option>`;
            });

            new TomSelect(select, {
                create: false,
                sortField: { field: "text", direction: "asc" },
                placeholder: "Type product name or code..."
            });

            modal.classList.remove('hidden');
        }

        function closeAdjustmentModal() {
            document.getElementById('adjustmentModal').classList.add('hidden');
            document.getElementById('adjustmentForm').reset();
        }

        async function handleSaveAdjustment(e) {
            e.preventDefault();
            const btn = document.getElementById('saveAdjBtn');
            const originalText = btn.innerHTML;

            const productId = document.getElementById('adjProduct').value;
            const type = document.getElementById('adjType').value;
            let qty = parseInt(document.getElementById('adjQuantity').value);
            const reason = document.getElementById('adjReason').value;

            if (!productId) { alert('Please select a product'); return; }
            if (isNaN(qty) || qty <= 0) { alert('Please enter a valid quantity'); return; }

            // Determine if we should subtract or add
            if (['Damage', 'Theft', 'Return to Vendor', 'Entry Error'].includes(type)) {
                qty = -qty;
            }

            try {
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                btn.disabled = true;

                // 1. Save Adjustment Record
                const { data: adjRecord, error: adjError } = await supabase
                    .from('adjustments')
                    .insert([{
                        product_id: productId,
                        type: type,
                        quantity: qty,
                        reason: reason
                    }]);

                if (adjError) throw adjError;

                // 2. Update Product Stock (Atomic)
                const product = productsData.find(p => p.id === productId);
                if (product) {
                    const newStock = (parseInt(product.stock) || 0) + qty;
                    const { error: stockError } = await supabase
                        .from('products')
                        .update({ stock: newStock })
                        .eq('id', productId);

                    if (stockError) throw stockError;
                    product.stock = newStock;
                }

                alert('Adjustment saved successfully!');
                closeAdjustmentModal();
                loadAdjustments();

                if (!document.getElementById('view-products').classList.contains('hidden')) {
                    renderGrid();
                }

            } catch (err) {
                console.error(err);
                alert('Error: ' + err.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function updateModuleSyncStatus(module, status) {
            const elId = 'syncStatus' + module;
            const el = document.getElementById(elId);
            if (el) {
                el.textContent = status;
                if (status.includes('Synced')) {
                    el.className = 'sync-status status-success';
                } else if (status.includes('Loading') || status.includes('Unsaved')) {
                    el.className = 'sync-status status-warning';
                } else {
                    el.className = 'sync-status';
                }
            }
        }

        // =====================================================
        // WAREHOUSE MANAGEMENT FUNCTIONS
        // =====================================================

        let warehousesListData = [];

        async function loadWarehousesList() {
            try {
                updateModuleSyncStatus('Warehouses', 'Loading...');
                const { data, error } = await supabase
                    .from('warehouses')
                    .select('*')
                    .order('name');

                if (error) throw error;
                warehousesListData = data || [];
                renderWarehousesList();
                updateModuleSyncStatus('Warehouses', 'Synced to Supabase');
            } catch (e) {
                console.error('Error loading warehouses:', e);
                updateModuleSyncStatus('Warehouses', 'Error Loading Data');
            }
        }

        function renderWarehousesList() {
            const tbody = document.getElementById('warehousesListBody');
            if (!tbody) return;

            if (warehousesListData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No warehouses found.</td></tr>';
                return;
            }

            tbody.innerHTML = warehousesListData.map((w, index) => {
                return `
                    <tr class="excel-tr">
                        <td>${index + 1}</td>
                        <td style="font-weight:600;">${escapeHtml(w.name)}</td>
                        <td>${escapeHtml(w.email || '-')}</td>
                        <td>${escapeHtml(w.phone || '-')}</td>
                        <td>${escapeHtml(w.city || '')}${w.city && w.country ? ', ' : ''}${escapeHtml(w.country || '')}</td>
                        <td class="action-cell">
                            <button class="btn-icon" onclick="editWarehouse('${w.id}')" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-icon" onclick="deleteWarehouse('${w.id}')" title="Delete" style="color:var(--error);">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function openWarehouseModal(id = null) {
            const modal = document.getElementById('warehouseModal');
            const form = document.getElementById('warehouseForm');
            form.reset();
            document.getElementById('warehouseId').value = id || '';

            if (id) {
                const w = warehousesListData.find(x => x.id === id);
                if (w) {
                    document.getElementById('warehouseName').value = w.name;
                    document.getElementById('warehouseEmail').value = w.email || '';
                    document.getElementById('warehousePhone').value = w.phone || '';
                    document.getElementById('warehouseCountry').value = w.country || '';
                    document.getElementById('warehouseCity').value = w.city || '';
                    document.getElementById('warehouseZip').value = w.zip_code || '';
                }
            }

            modal.classList.remove('hidden');
        }

        function closeWarehouseModal() {
            document.getElementById('warehouseModal').classList.add('hidden');
        }

        function editWarehouse(id) {
            openWarehouseModal(id);
        }

        async function handleSaveWarehouse(e) {
            e.preventDefault();
            const btn = document.getElementById('saveWarehouseBtn');
            const originalText = btn.innerHTML;

            const id = document.getElementById('warehouseId').value;
            const payload = {
                name: document.getElementById('warehouseName').value,
                email: document.getElementById('warehouseEmail').value,
                phone: document.getElementById('warehousePhone').value,
                country: document.getElementById('warehouseCountry').value,
                city: document.getElementById('warehouseCity').value,
                zip_code: document.getElementById('warehouseZip').value
            };

            try {
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                btn.disabled = true;

                let res;
                if (id) {
                    res = await supabase.from('warehouses').update(payload).eq('id', id);
                } else {
                    res = await supabase.from('warehouses').insert([payload]);
                }

                if (res.error) throw res.error;

                alert('Warehouse saved successfully!');
                closeWarehouseModal();
                loadWarehousesList();
                if (typeof loadReferenceData === 'function') loadReferenceData();
            } catch (err) {
                console.error(err);
                alert('Error: ' + err.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function deleteWarehouse(id) {
            if (!confirm('Are you sure you want to delete this warehouse? This might affect records linked to it.')) return;

            try {
                const { error } = await supabase.from('warehouses').delete().eq('id', id);
                if (error) throw error;
                alert('Warehouse deleted successfully!');
                loadWarehousesList();
                if (typeof loadReferenceData === 'function') loadReferenceData();
            } catch (err) {
                console.error(err);
                alert('Error: ' + err.message);
            }
        }

        // Initialize Double-Touch Editing
        function setupDoubleTouchEditing() {
            const lockInput = (el) => {
                if (el.tagName === 'SELECT') {
                    if (el.tomselect) {
                        el.tomselect.lock();
                    } else {
                        // Standard select: We can't easily readonly it.
                        // We will use a special class to prevent interaction via the global handler
                    }
                } else {
                    el.setAttribute('readonly', 'true');
                }
                el.classList.add('touch-locked');
            };

            const unlockInput = (el) => {
                if (el.tagName === 'SELECT') {
                    if (el.tomselect) {
                        el.tomselect.unlock();
                        // Open it
                        setTimeout(() => el.tomselect.open(), 50);
                    }
                } else {
                    el.removeAttribute('readonly');
                }
                el.classList.remove('touch-locked');
                el.focus();
            };

            // Public method to unlock specific input
            window.unlockTouchInput = unlockInput;

            // Public method to lock new inputs
            window.applyTouchLocks = () => {
                document.querySelectorAll('.excel-input').forEach(el => {
                    // Only lock if not already processed
                    if (!el.dataset.touchInit) {
                        lockInput(el);
                        el.dataset.touchInit = 'true';
                    }
                });
            };

            // Global Handler
            let lastTap = 0;
            let lastTarget = null;

            document.addEventListener('click', function (e) {
                // Find target wrapper or input
                // For TomSelect, the click comes from .ts-wrapper or its children.
                // We need to find the underlying Select (which is hidden but has .excel-input)
                // OR find the wrapper which has .excel-input class in our CSS?
                // Wait, our CSS has .ts-wrapper.excel-input

                let target = e.target.closest('.excel-input');
                let isTomSelect = false;

                // Special check for TomSelect wrapper
                if (!target) {
                    const tsWrapper = e.target.closest('.ts-wrapper');
                    if (tsWrapper && tsWrapper.classList.contains('excel-input')) {
                        // Find the underlying select
                        const select = tsWrapper.previousElementSibling;
                        // TomSelect puts wrapper AFTER select usually? 
                        // Let's use the instance on the wrapper if available, or just use the wrapper as target proxy
                        // Actually, TomSelect instance is on the original Select element.
                        // The original select usually has .excel-input.
                        // But TomSelect hides it.
                        // So we need to find the related select.
                        // Simpler: The .ts-wrapper IS the target we interact with.
                        // But we want to lock the instance.

                        // Let's check if we can find the select from the wrapper.
                        // Usually it's siblings.
                        // But wait, the standard way is: Select -> new TomSelect(Select).
                        // The Select is hidden. The Wrapper is inserted after.
                        target = tsWrapper.parentElement.querySelector('select');
                        isTomSelect = true;
                    }
                }

                if (!target) return;

                // If not locked, let default happen (e.g. text entry, opening select)
                if (!target.classList.contains('touch-locked')) return;

                const currentTime = new Date().getTime();
                const tapLength = currentTime - lastTap;
                const isDoubleTap = tapLength < 500 && tapLength > 0;

                if (isDoubleTap && (target === lastTarget || (isTomSelect && lastTarget && lastTarget.closest('.ts-wrapper')))) {
                    // Double Tap detected -> Unlock
                    e.preventDefault();
                    e.stopPropagation();
                    unlockInput(target);
                    // Reset
                    lastTap = 0;
                    lastTarget = null;
                } else {
                    // Single Tap -> Intercept

                    // If it's a select (TomSelect or Native), we MUST prevent default to stop it opening
                    if (target.tagName === 'SELECT' || target.classList.contains('ts-wrapper')) {
                        e.preventDefault();
                        e.stopPropagation();
                    }
                    // For Locked Text Inputs, default behavior is "Focus but no keyboard" (if readonly).
                    // This is desirable.

                    lastTarget = target;
                    lastTap = currentTime;
                }
            }, true); // Capture phase

            // Re-lock on blur
            document.addEventListener('focusout', function (e) {
                // Delay to allow focus to move
                setTimeout(() => {
                    const active = document.activeElement;
                    // If we lost focus to body or unrelated element
                    if (active && (active.classList.contains('excel-input') || active.closest('.excel-input'))) {
                        return; // Still editing something
                    }
                    // Lock everything back? 
                    // Or just the target?
                    // Safer to lock everything or just re-run applyTouchLocks?
                    // Actually, we should just lock the specific element that lost focus?
                    // Hard because TomSelect blur is complex.

                    // Creating specific re-lock:
                    // We can just iterate and lock all valid inputs that aren't active.
                    document.querySelectorAll('.excel-input:not(.touch-locked)').forEach(el => {
                        // Check if this element is currently focused or contains focus
                        if (el !== active && !el.contains(active)) {
                            // Also check TomSelect wrapper focus
                            if (el.tomselect && el.tomselect.wrapper.contains(active)) return;

                            lockInput(el);
                        }
                    });
                }, 200);
            });

            // Initial Apply
            window.applyTouchLocks();
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.error(`Error attempting to enable full-screen mode: ${err.message}`);
                });
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }

        setupKeybinds();
    </script>
    <!-- Hidden File Input for Excel Import -->
    <input type="file" id="excelInput" style="display:none" accept=".csv, .xlsx, .xls"
        onchange="handleExcelImport(this)">

    <!-- Keyboard Shortcuts Help Modal -->
    <div id="shortcutsModal" class="modal-overlay hidden" onclick="if(event.target === this) closeShortcutsModal()">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2><i class="fas fa-keyboard"></i> Keyboard Shortcuts</h2>
                <button class="btn-icon" onclick="closeShortcutsModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h4 style="color: var(--primary-light); margin-bottom: 10px;">Navigation</h4>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span class="text-muted">Move Selection</span>
                            <code> / </code>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span class="text-muted">Select / Edit</span>
                            <code>Enter</code>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span class="text-muted">Go Back / Close</span>
                            <code>Esc</code>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span class="text-muted">Focus Search</span>
                            <code>Ctrl + F</code>
                        </div>
                    </div>
                    <div>
                        <h4 style="color: var(--primary-light); margin-bottom: 10px;">Actions</h4>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span class="text-muted">Save Changes</span>
                            <code>Ctrl + S</code>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span class="text-muted">Add New Item</span>
                            <code>Alt + N</code>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span class="text-muted">Delete Selected</span>
                            <code>Delete</code>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span class="text-muted">Show Shortcuts</span>
                            <code>?</code>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeShortcutsModal()">Close</button>
            </div>
        </div>
    </div>
</body>

</html>