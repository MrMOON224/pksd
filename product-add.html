<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Product - POS System</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Styles -->
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/sidebar.css">
    <link rel="stylesheet" href="css/dashboard.css">
</head>

<body>
    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Dashboard Layout -->
    <div class="dashboard-layout">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <!-- Sidebar Header -->
            <div class="sidebar-header">
                <a href="admin-dashboard.html" class="sidebar-logo">
                    <i class="fas fa-cash-register"></i>
                    <span>POS System</span>
                </a>
            </div>

            <!-- Sidebar Navigation -->
            <nav class="sidebar-nav">
                <!-- Main Section -->
                <div class="nav-section">
                    <div class="nav-section-title">Main</div>
                    <ul class="nav-menu">
                        <li class="nav-item">
                            <a href="admin-dashboard.html" class="nav-link">
                                <i class="fas fa-th-large"></i>
                                <span>Dashboard</span>
                            </a>
                        </li>
                    </ul>
                </div>

                <!-- Inventory Section -->
                <div class="nav-section">
                    <div class="nav-section-title">Inventory</div>
                    <ul class="nav-menu">
                        <li class="nav-item has-submenu active">
                            <a href="#" class="nav-link dropdown-toggle">
                                <div style="display:flex; align-items:center; gap:var(--space-md); flex:1;">
                                    <i class="fas fa-boxes"></i>
                                    <span>Products</span>
                                </div>
                                <i class="fas fa-chevron-right nav-arrow"></i>
                            </a>
                            <ul class="submenu">
                                <li class="nav-item">
                                    <a href="products.html" class="nav-link">List Products</a>
                                </li>
                                <li class="nav-item">
                                    <a href="product-add.html" class="nav-link active">Add Product</a>
                                </li>
                                <li class="nav-item">
                                    <a href="#" class="nav-link">Product Categories</a>
                                </li>
                                <li class="nav-item">
                                    <a href="#" class="nav-link">Variations</a>
                                </li>
                                <li class="nav-item">
                                    <a href="#" class="nav-link">Brands</a>
                                </li>
                                <li class="nav-item">
                                    <a href="#" class="nav-link">Units</a>
                                </li>
                                <li class="nav-item">
                                    <a href="#" class="nav-link">Base Units</a>
                                </li>
                                <li class="nav-item">
                                    <a href="#" class="nav-link">Print Barcode</a>
                                </li>
                            </ul>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link">
                                <i class="fas fa-sliders-h"></i>
                                <span>Adjustments</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link">
                                <i class="fas fa-warehouse"></i>
                                <span>Warehouse</span>
                            </a>
                        </li>
                    </ul>
                </div>

                <!-- Sales & Purchases Section -->
                <div class="nav-section">
                    <div class="nav-section-title">Transactions</div>
                    <ul class="nav-menu">
                        <li class="nav-item">
                            <a href="#" class="nav-link">
                                <i class="fas fa-file-invoice"></i>
                                <span>Quotations</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link">
                                <i class="fas fa-shopping-cart"></i>
                                <span>Purchases</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link">
                                <i class="fas fa-cash-register"></i>
                                <span>Sales</span>
                                <span class="nav-badge">NEW</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link">
                                <i class="fas fa-exchange-alt"></i>
                                <span>Transfers</span>
                            </a>
                        </li>
                    </ul>
                </div>

                <!-- Finance Section -->
                <div class="nav-section">
                    <div class="nav-section-title">Finance</div>
                    <ul class="nav-menu">
                        <li class="nav-item">
                            <a href="#" class="nav-link">
                                <i class="fas fa-receipt"></i>
                                <span>Expenses</span>
                            </a>
                        </li>
                    </ul>
                </div>

                <!-- People Section -->
                <div class="nav-section">
                    <div class="nav-section-title">People</div>
                    <ul class="nav-menu">
                        <li class="nav-item">
                            <a href="#" class="nav-link">
                                <i class="fas fa-users"></i>
                                <span>Peoples</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link">
                                <i class="fas fa-user-shield"></i>
                                <span>Roles/Permissions</span>
                            </a>
                        </li>
                    </ul>
                </div>

                <!-- Reports Section -->
                <div class="nav-section">
                    <div class="nav-section-title">Analytics</div>
                    <ul class="nav-menu">
                        <li class="nav-item">
                            <a href="#" class="nav-link">
                                <i class="fas fa-chart-bar"></i>
                                <span>Reports</span>
                            </a>
                        </li>
                    </ul>
                </div>

                <!-- Settings Section -->
                <div class="nav-section">
                    <div class="nav-section-title">Settings</div>
                    <ul class="nav-menu">
                        <li class="nav-item">
                            <a href="#" class="nav-link">
                                <i class="fas fa-dollar-sign"></i>
                                <span>Currencies</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link">
                                <i class="fas fa-language"></i>
                                <span>Languages</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link">
                                <i class="fas fa-file-alt"></i>
                                <span>Templates</span>
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>
        </aside>

        <!-- Main Content Wrapper -->
        <div class="main-wrapper">
            <!-- Top Navbar -->
            <nav class="top-navbar">
                <div class="navbar-left">
                    <button class="menu-toggle" id="menuToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 class="page-title-nav">Products</h1>
                </div>

                <div class="navbar-right">
                    <!-- Search Bar -->
                    <div class="navbar-search">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="Search products...">
                    </div>

                    <!-- Navbar Icons -->
                    <div class="navbar-icons">
                        <button class="navbar-icon">
                            <i class="fas fa-bell"></i>
                            <span class="badge">3</span>
                        </button>
                        <button class="navbar-icon">
                            <i class="fas fa-envelope"></i>
                            <span class="badge">5</span>
                        </button>
                    </div>

                    <!-- User Menu -->
                    <div class="user-menu">
                        <div class="user-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="user-details">
                            <div class="user-name-nav" id="userName">Admin</div>
                            <div class="user-role-nav" id="userRole">Administrator</div>
                        </div>
                        <button class="btn btn-secondary btn-sm" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </div>
            </nav>

            <!-- Dashboard Content -->
            <main class="dashboard-content">
                <!-- Page Header -->
                <div class="page-header">
                    <h1 class="page-title">Add Product</h1>
                    <p class="page-subtitle">Create a new product in your inventory.</p>
                </div>

                <div class="glass-container" style="padding: var(--space-xl);">
                    <form id="addProductForm">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-lg);">
                            <!-- Left Column -->
                            <div style="display: flex; flex-direction: column; gap: var(--space-md);">
                                <div class="form-group">
                                    <label class="form-label" for="productName">Product Name *</label>
                                    <div class="input-group">
                                        <i class="fas fa-box"></i>
                                        <input type="text" id="productName" class="form-control"
                                            placeholder="Enter product name" required>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label" for="productCode">Product Code / SKU</label>
                                    <div class="input-group">
                                        <i class="fas fa-barcode"></i>
                                        <input type="text" id="productCode" class="form-control"
                                            placeholder="Scan or enter code">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label" for="productCategory">Category</label>
                                    <div class="input-group">
                                        <i class="fas fa-tag"></i>
                                        <select id="productCategory" class="form-control">
                                            <option value="">Select Category</option>
                                            <option value="Electronics">Electronics</option>
                                            <option value="Clothing">Clothing</option>
                                            <option value="Food">Food & Beverage</option>
                                            <option value="Home">Home & Garden</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label" for="productBrand">Brand</label>
                                    <div class="input-group">
                                        <i class="fas fa-award"></i>
                                        <select id="productBrand" class="form-control">
                                            <option value="">Select Brand</option>
                                            <option value="Generic">Generic</option>
                                            <option value="Brand A">Brand A</option>
                                            <option value="Brand B">Brand B</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Right Column -->
                            <div style="display: flex; flex-direction: column; gap: var(--space-md);">
                                <div class="form-group">
                                    <label class="form-label" for="productCost">Cost Price</label>
                                    <div class="input-group">
                                        <i class="fas fa-dollar-sign"></i>
                                        <input type="number" id="productCost" class="form-control" placeholder="0.00"
                                            step="0.01">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label" for="productPrice">Selling Price *</label>
                                    <div class="input-group">
                                        <i class="fas fa-tag"></i>
                                        <input type="number" id="productPrice" class="form-control" placeholder="0.00"
                                            step="0.01" required>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label" for="productUnit">Unit</label>
                                    <div class="input-group">
                                        <i class="fas fa-ruler"></i>
                                        <select id="productUnit" class="form-control">
                                            <option value="pc">Piece (pc)</option>
                                            <option value="kg">Kilogram (kg)</option>
                                            <option value="l">Liter (l)</option>
                                            <option value="m">Meter (m)</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label" for="productStock">Initial Stock Quantity</label>
                                    <div class="input-group">
                                        <i class="fas fa-cubes"></i>
                                        <input type="number" id="productStock" class="form-control" placeholder="0"
                                            value="0">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Full Width Description -->
                        <div class="form-group" style="margin-top: var(--space-md);">
                            <label class="form-label" for="productDescription">Description</label>
                            <textarea id="productDescription" class="form-control" rows="3"
                                placeholder="Enter product details..."></textarea>
                        </div>

                        <!-- Image Upload (Placeholder) -->
                        <div class="form-group" style="margin-top: var(--space-md);">
                            <label class="form-label">Product Image</label>
                            <div style="border: 2px dashed rgba(255,255,255,0.2); border-radius: var(--radius-md); padding: var(--space-lg); text-align: center; cursor: pointer; transition: all 0.3s ease;"
                                onmouseover="this.style.borderColor='var(--primary)'"
                                onmouseout="this.style.borderColor='rgba(255,255,255,0.2)'">
                                <i class="fas fa-cloud-upload-alt"
                                    style="font-size: 2rem; color: var(--text-muted); margin-bottom: var(--space-sm);"></i>
                                <p style="color: var(--text-muted);">Click to upload image or drag and drop</p>
                                <input type="file" id="productImage" style="display: none;">
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <div
                            style="margin-top: var(--space-xl); display: flex; justify-content: flex-end; gap: var(--space-md);">
                            <a href="products.html" class="btn btn-secondary">Cancel</a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Save Product
                            </button>
                        </div>
                    </form>
                </div>
            </main>
        </div>
    </div>

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Scripts -->
    <script src="config.js"></script>
    <script src="js/supabase-client.js"></script>
    <script src="js/auth.js"></script>

    <script>
        // Supabase client is already initialized globally in supabase-client.js
        let refCategories = [];
        let refBrands = [];
        let refUnits = [];

        // Sidebar Toggle for Mobile
        const menuToggle = document.getElementById('menuToggle');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');

        menuToggle.addEventListener('click', () => {
            sidebar.classList.toggle('active');
            sidebarOverlay.classList.toggle('active');
        });

        sidebarOverlay.addEventListener('click', () => {
            sidebar.classList.remove('active');
            sidebarOverlay.classList.remove('active');
        });

        // Sidebar Dropdown Toggle
        const dropdownToggles = document.querySelectorAll('.dropdown-toggle');
        dropdownToggles.forEach(toggle => {
            toggle.addEventListener('click', (e) => {
                e.preventDefault();
                const parent = toggle.parentElement;
                parent.classList.toggle('active');
            });
        });

        // Require authentication
        let currentUser = null;

        async function init() {
            // Check authentication and role
            currentUser = await requireAuth(['admin', 'manager']);

            if (currentUser) {
                // Update user info
                document.getElementById('userName').textContent = currentUser.email;
                document.getElementById('userRole').textContent = currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1);

                // Load reference data
                await loadReferenceData();
            }
        }

        async function loadReferenceData() {
            try {
                const [cats, brands, units] = await Promise.all([
                    supabase.from('categories').select('id, name').order('name'),
                    supabase.from('brands').select('id, name').order('name'),
                    supabase.from('units').select('id, name').order('name')
                ]);

                refCategories = cats.data || [];
                refBrands = brands.data || [];
                refUnits = units.data || [];

                populateDropdowns();
            } catch (error) {
                console.error('Error loading reference data:', error);
            }
        }

        function populateDropdowns() {
            const catSelect = document.getElementById('productCategory');
            const brandSelect = document.getElementById('productBrand');
            const unitSelect = document.getElementById('productUnit');

            catSelect.innerHTML = '<option value="">Select Category</option>' +
                refCategories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');

            brandSelect.innerHTML = '<option value="">Select Brand</option>' +
                refBrands.map(b => `<option value="${b.id}">${b.name}</option>`).join('');

            unitSelect.innerHTML = '<option value="">Select Unit</option>' +
                refUnits.map(u => `<option value="${u.id}">${u.name}</option>`).join('');
        }

        // Form Submission
        document.getElementById('addProductForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const name = document.getElementById('productName').value;
            const code = document.getElementById('productCode').value;
            const categoryId = document.getElementById('productCategory').value;
            const brandId = document.getElementById('productBrand').value;
            const cost = parseFloat(document.getElementById('productCost').value) || 0;
            const price = parseFloat(document.getElementById('productPrice').value) || 0;
            const unitId = document.getElementById('productUnit').value;
            const stock = parseInt(document.getElementById('productStock').value) || 0;
            const description = document.getElementById('productDescription').value;

            // Basic validation
            if (!name || !price) {
                alert('Please fill in all required fields');
                return;
            }

            try {
                const payload = {
                    name: name,
                    code: code,
                    category_id: categoryId || null,
                    brand_id: brandId || null,
                    cost: cost,
                    price: price,
                    unit_id: unitId || null,
                    stock: stock,
                    description: description,
                    barcodes: code ? [code] : [] // Default barcode to the code if provided
                };

                const { data, error } = await supabase
                    .from('products')
                    .insert([payload]);

                if (error) throw error;

                alert('Product added successfully!');
                window.location.href = 'products.html';

            } catch (error) {
                console.error('Error adding product:', error);
                alert('Error adding product: ' + error.message);
            }
        });

        // Initialize
        init();
    </script>
</body>

</html>