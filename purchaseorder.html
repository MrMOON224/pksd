<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Purchase Order - Compact Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

        :root {
            --bg-top: var(--bg-primary);
            --accent-indigo: var(--primary);
            --glass-panel: var(--bg-glass);
            --text-primary: #f8fafc;
            --text-muted: var(--text-muted);
            --success-green: var(--success);
            --warning-alert: var(--error);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-top);
            color: var(--text-primary);
            overflow: hidden;
        }

        .glass-card {
            background: var(--glass-panel);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .glass-input {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            font-size: 0.75rem;
            padding: 0.35rem 0.5rem;
            border-radius: 0.35rem;
            width: 100%;
            transition: all 0.3s ease;
        }

        .glass-input:focus {
            outline: none;
            border-color: var(--accent-indigo);
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
            background: rgba(255, 255, 255, 0.08);
        }

        .table-container {
            flex-grow: 1;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.05);
            background: rgba(0, 0, 0, 0.2);
            border-radius: 0.75rem;
        }

        .table-header th {
            position: sticky;
            top: 0;
            background: var(--bg-secondary);
            z-index: 10;
            font-size: 0.65rem;
            padding: 0.6rem;
            color: var(--text-muted);
            text-transform: uppercase;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            border-right: 1px solid rgba(255, 255, 255, 0.05);
        }

        .no-spinner::-webkit-inner-spin-button,
        .no-spinner::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        ::-webkit-scrollbar {
            width: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        #itemsTable tbody td {
            border-right: 1px solid rgba(255, 255, 255, 0.05);
            padding: 0;
        }

        .remark-header {
            background: var(--error) !important;
            color: white !important;
        }

        .btn-submit {
            background: var(--gradient-primary);
            transition: all 0.3s ease;
        }

        .btn-submit:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-glow);
        }

        select.glass-input option {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .preview-text {
            color: rgba(255, 255, 255, 0.4) !important;
            font-style: italic;
        }
    </style>

    <!-- Supabase Integration -->
    <script src="config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-client.js"></script>
</head>

<body class="p-2 md:p-3 text-[11px] h-screen flex flex-col">

    <div class="max-w-[1600px] mx-auto w-full flex flex-col h-full space-y-2">

        <!-- Top Toolbar -->
        <div class="flex justify-between items-center px-1">
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-2">
                    <label class="font-bold text-[var(--text-muted)] uppercase text-[9px]">Order Date</label>
                    <input type="date" id="orderDate" class="glass-input !w-32">
                </div>
                <div class="flex items-center gap-2">
                    <label class="font-bold text-[var(--text-muted)] uppercase text-[9px]">Load Order</label>
                    <select id="orderDropdown" class="glass-input !w-48" onchange="if(this.value) loadOrder(this.value)">
                        <option value="">Select Order...</option>
                    </select>
                </div>
                <div class="flex items-center gap-2">
                    <label class="font-bold text-[var(--text-muted)] uppercase text-[9px]">Requested Shop</label>
                    <select id="warehouseId" class="glass-input !w-48">
                        <option value="">Select Warehouse...</option>
                    </select>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="viewRecentOrders()"
                    class="bg-white/10 hover:bg-white/20 px-4 py-1.5 rounded font-bold text-[10px] transition-all">RECENT
                    ORDERS</button>
                <button onclick="viewDrafts()"
                    class="bg-amber-500/10 hover:bg-amber-500/20 text-amber-500 border border-amber-500/30 px-4 py-1.5 rounded font-bold text-[10px] transition-all">DRAFT
                    LIST</button>
                <button onclick="saveDraft()"
                    class="bg-slate-700 hover:bg-slate-600 px-5 py-1.5 rounded font-bold text-[10px] text-white transition-all">SAVE
                    DRAFT</button>
                <button onclick="submitOrder()"
                    class="btn-submit px-5 py-1.5 rounded font-bold text-[10px] text-white">SUBMIT
                    ORDER</button>
            </div>
        </div>

        <!-- Order Header Metadata Block -->
        <div class="glass-card rounded-lg p-3 grid grid-cols-4 gap-4">
            <div class="space-y-1">
                <label class="text-[9px] font-bold uppercase text-[var(--text-muted)]">Voucher Code</label>
                <div class="flex gap-1">
                    <input type="text" id="voucherCode" class="glass-input" placeholder="Will be generated" readonly>
                    <button id="copyBtn" onclick="copyToClipboard(document.getElementById('voucherCode').value)"
                        class="hidden bg-white/10 hover:bg-white/20 px-2 rounded transition-all">
                        <i class="fas fa-copy text-[10px]"></i>
                    </button>
                </div>
            </div>
            <div class="space-y-1">
                <label class="text-[9px] font-bold uppercase text-[var(--text-muted)]">Target Supplier</label>
                <select id="supplierId" class="glass-input">
                    <option value="">Select Supplier...</option>
                </select>
            </div>
            <div class="space-y-1">
                <label class="text-[9px] font-bold uppercase text-[var(--text-muted)]">Reference No.</label>
                <input type="text" id="referenceNo" class="glass-input" placeholder="-">
            </div>
            <div class="space-y-1">
                <label class="text-[9px] font-bold uppercase text-[var(--text-muted)]">Expected Delivery</label>
                <input type="date" id="expectedDelivery" class="glass-input">
            </div>
        </div>

        <!-- Main Order Table Area -->
        <div class="table-container">
            <table class="w-full border-collapse" id="itemsTable">
                <thead class="table-header">
                    <tr class="text-left">
                        <th class="w-8 text-center">No</th>
                        <th class="w-24">Item Code</th>
                        <th class="w-40">Barcode</th>
                        <th>Description</th>
                        <th class="w-16 text-center">QTY</th>
                        <th class="w-20 text-center">Unit</th>
                        <th class="w-24 text-right">Cost</th>
                        <th class="w-16 text-right">Discount</th>
                        <th class="w-24 text-right">Amount</th>
                        <th class="w-48 remark-header">Remark</th>
                        <th class="w-6 border-none"></th>
                    </tr>
                </thead>
                <tbody id="tableBody" class="divide-y divide-white/5">
                    <!-- Order Items will be rendered here -->
                </tbody>
            </table>
        </div>

        <!-- Quick Add Row -->
        <div class="px-1 flex justify-between items-center">
            <button onclick="addRow()"
                class="text-[var(--accent-indigo)] hover:text-white font-bold text-[9px] uppercase flex items-center gap-1 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                Add New Item to Order
            </button>
            <div id="loadedIndicator"
                class="hidden text-amber-500 font-bold text-[9px] uppercase flex items-center gap-2">
                <i class="fas fa-edit"></i> Editing Saved Order
                <button onclick="window.location.reload()" class="text-white/20 hover:text-white">Clear</button>
            </div>
        </div>

        <!-- Order Footer Summary -->
        <!-- Order Footer Summary -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
            <!-- Footer Inputs -->
            <div class="glass-card rounded-lg p-3 grid grid-cols-2 gap-3 col-span-3">
                <div class="space-y-1">
                    <label class="text-[9px] font-bold uppercase text-[var(--text-muted)]">Order Tax (%)</label>
                    <input type="number" id="taxPercent" oninput="calculateTotals()" value="0"
                        class="glass-input no-spinner" placeholder="0">
                </div>
                <div class="space-y-1">
                    <label class="text-[9px] font-bold uppercase text-[var(--text-muted)]">Order Discount</label>
                    <input type="number" id="overallDiscount" oninput="calculateTotals()" value="0"
                        class="glass-input no-spinner" placeholder="0">
                </div>
                <div class="space-y-1">
                    <label class="text-[9px] font-bold uppercase text-[var(--text-muted)]">Shipping Cost</label>
                    <input type="number" id="shipping" oninput="calculateTotals()" value="0"
                        class="glass-input no-spinner" placeholder="0">
                </div>
                <div class="space-y-1 relative">
                    <label class="text-[9px] font-bold uppercase text-[var(--text-muted)] flex justify-between">
                        Paid Amount
                        <span id="remainBadge" class="text-[var(--warning-alert)] text-[9px] font-bold hidden">Rem:
                            0</span>
                    </label>
                    <input type="number" id="paidAmount" oninput="calculateTotals()" value="0"
                        class="glass-input text-[var(--success-green)] font-bold no-spinner" placeholder="0">
                </div>

                <!-- Metadata -->
                <div class="space-y-1">
                    <label class="text-[9px] font-bold uppercase text-[var(--text-muted)]">Order Tax Code</label>
                    <select id="taxCode" class="glass-input">
                        <option value="0">Non-Taxable</option>
                        <option value="7">Standard GST (7%)</option>
                    </select>
                </div>
                <div class="space-y-1">
                    <label class="text-[9px] font-bold uppercase text-[var(--text-muted)]">Payment Type</label>
                    <select id="paymentType" class="glass-input">
                        <option value="Cash">Cash</option>
                        <option value="Credit">Credit</option>
                        <option value="Consignment">Consignment</option>
                    </select>
                </div>


                <!-- Long Remark Bar -->
                <div class="col-span-2 flex items-center gap-3">
                    <label class="text-[9px] font-bold uppercase text-[var(--text-muted)] whitespace-nowrap">Notes /
                        Remarks</label>
                    <input type="text" id="orderNote"
                        class="glass-input !rounded-none border-x-0 border-t-0 border-b border-white/20 bg-transparent focus:bg-white/5"
                        placeholder="Enter general notes for this purchase order...">
                </div>
            </div>

            <!-- Summary Table -->
            <div class="glass-card rounded-lg p-3 space-y-2 overflow-hidden flex flex-col justify-center">
                <div class="flex justify-between items-center border-b border-white/5 pb-1">
                    <span class="text-[var(--text-muted)] uppercase font-bold text-[8px]">Items Subtotal</span>
                    <span id="displaySubTotal" class="font-bold">0</span>
                </div>
                <div class="flex justify-between items-center border-b border-white/5 pb-1">
                    <span class="text-[var(--text-muted)] uppercase font-bold text-[8px]">Order Tax</span>
                    <span id="displayTax" class="text-right">0</span>
                </div>
                <div class="flex justify-between items-center border-b border-white/5 pb-1">
                    <span class="text-[var(--warning-alert)] uppercase font-bold text-[8px]">Discount</span>
                    <span id="displayDiscount" class="text-right">-0</span>
                </div>
                <div class="flex justify-between items-center border-b border-white/5 pb-1">
                    <span class="text-[var(--text-muted)] uppercase font-bold text-[8px]">Shipping</span>
                    <span id="displayShipping" class="text-right">0</span>
                </div>
                <div class="mt-2 text-[var(--primary)] flex flex-col items-end">
                    <span class="uppercase font-black text-[9px] mb-1">Total Payable</span>
                    <div id="displayNet" class="text-2xl font-black leading-none">0</div>
                </div>
                <div class="pt-2 border-t border-white/10 flex justify-between items-center">
                    <span class="text-[var(--warning-alert)] uppercase font-bold text-[8px]">Remain Amount</span>
                    <span id="remainAmount" class="font-bold text-[var(--warning-alert)]">0</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        let items = [];
        let suppliers = [];
        let warehouses = [];
        let units = [];
        let unitsMap = new Map();
        let productsMap = new Map();
        let loadedOrderId = null;

        window.onload = () => {
            document.getElementById('orderDate').valueAsDate = new Date();
            setTimeout(initData, 150);
        };

        async function initData() {
            try {
                // Load Suppliers
                const { data: supData } = await supabase.from('suppliers').select('id, name');
                suppliers = supData || [];
                const supSelect = document.getElementById('supplierId');
                suppliers.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s.id;
                    opt.textContent = s.name;
                    supSelect.appendChild(opt);
                });

                // Load Warehouses
                const { data: whData } = await supabase.from('warehouses').select('id, name');
                warehouses = whData || [];
                const whSelect = document.getElementById('warehouseId');
                warehouses.forEach(w => {
                    const opt = document.createElement('option');
                    opt.value = w.id;
                    opt.textContent = w.name;
                    whSelect.appendChild(opt);
                });

                // Load Units (for unit dropdown)
                const { data: unitData } = await supabase.from('units').select('id, name');
                units = unitData || [];
                units.forEach(u => unitsMap.set(u.id, u.name));

                // add custom arrow for selects via css injection (only once)
                const styleEl = document.createElement('style');
                styleEl.textContent = `
                    select.glass-input {
                        appearance: none;
                        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20'%3E%3Cpath fill='none' stroke='currentColor' stroke-width='2' d='M6 8l4 4 4-4'/%3E%3C/svg%3E");
                        background-repeat: no-repeat;
                        background-position: right 0.5rem center;
                        background-size: 0.75rem;
                    }
                `;
                document.head.appendChild(styleEl);

                // Load Products
                const { data: prodData } = await supabase.from('products').select('id, code, name, barcodes, cost, price, pcs_per_box, unit_id');
                (prodData || []).forEach(p => {
                    productsMap.set(p.id, p);
                    if (p.code) productsMap.set(p.code, p);
                    if (p.barcodes && Array.isArray(p.barcodes)) {
                        p.barcodes.forEach(bc => productsMap.set(bc, p));
                    }
                });

                // populate order dropdown
                await loadOrderDropdown();

                addRow();

                // helper to fill dropdown with recent orders
                async function loadOrderDropdown() {
                    try {
                        const { data } = await supabase.from('purchases').select('id, reference_no').eq('status','Ordered').order('date', { ascending: false }).limit(50);
                        const sel = document.getElementById('orderDropdown');
                        (data || []).forEach(o => {
                            const opt = document.createElement('option');
                            opt.value = o.id;
                            opt.textContent = o.reference_no;
                            sel.appendChild(opt);
                        });
                    } catch (e) {
                        console.error('Order dropdown load error', e);
                    }
                }
            } catch (err) {
                console.error('Init error:', err);
                alert('Failed to load data: ' + err.message);
            }
        }

        let activeSearchIdx = -1;

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            items.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-white/[0.04] transition-colors relative";
                const isP = item.isPreview;
                tr.innerHTML = `
                    <td class="text-center font-bold text-white/20">${index + 1}</td>
                    <td>
                        <input type="text" value="${item.itemCode || ''}" 
                               oninput="handleSearch(${index}, 'itemCode', this.value)" 
                               onkeydown="handleGridKey(${index}, event)"
                               class="bg-transparent w-full outline-none p-2 ${isP && item.lastTyped !== 'itemCode' ? 'preview-text' : ''}" placeholder="Code...">
                    </td>
                    <td><input type="text" value="${item.barcode || ''}" 
                               oninput="handleSearch(${index}, 'barcode', this.value)" 
                               onkeydown="handleGridKey(${index}, event)"
                               class="bg-transparent w-full outline-none p-2 ${isP && item.lastTyped !== 'barcode' ? 'preview-text' : ''}" placeholder="Barcode..."></td>
                    <td><input type="text" value="${item.description || ''}" 
                               oninput="handleSearch(${index}, 'description', this.value)" 
                               onkeydown="handleGridKey(${index}, event)"
                               class="bg-transparent w-full outline-none p-2 ${isP && item.lastTyped !== 'description' ? 'preview-text' : ''}" placeholder="Description..."></td>
                    <td><input type="number" value="${item.qty || 0}" oninput="updateItem(${index}, 'qty', this.value)" class="bg-transparent w-full text-center outline-none no-spinner font-bold p-2"></td>
                    <td>
                        <select onchange="updateItem(${index}, 'unitId', this.value)" class="glass-input appearance-none bg-transparent w-full outline-none p-2 text-center">
                            <option value="">Select unit</option>
                            ${units.map(u => `<option value="${u.id}" ${item.unitId === u.id ? 'selected' : ''}>${u.name}</option>`).join('')}
                        </select>
                    </td>
                    <td><input type="number" value="${item.cost || 0}" oninput="updateItem(${index}, 'cost', this.value)" class="bg-transparent w-full outline-none text-right p-2 no-spinner ${isP ? 'preview-text' : ''}"></td>
                    <td><input type="text" value="${item.discount || '0'}" oninput="updateItem(${index}, 'discount', this.value)" class="bg-transparent w-full outline-none text-right p-2"></td>
                    <td class="text-right font-bold pr-3">${(item.amount || 0).toLocaleString()}</td>
                    <td><input type="text" value="${item.remark || ''}" onchange="updateItem(${index}, 'remark', this.value)" class="bg-transparent w-full outline-none italic text-[var(--warning-alert)] px-2"></td>
                    <td class="text-center border-none"><button onclick="removeRow(${index})" class="text-white/20 hover:text-red-500 font-bold transition-all px-2 text-lg">√ó</button></td>
                `;
                tbody.appendChild(tr);
            });
            calculateTotals();
        }

        function handleSearch(idx, field, query) {
            updateItem(idx, field, query);
            items[idx].lastTyped = field;

            if (!query || query.length < 1) {
                items[idx].isPreview = false;
                items[idx].tempProductId = null;
                // Don't clear EVERYTHING, let user type
                return;
            }

            const product = Array.from(productsMap.values()).find(p => {
                if (!p) return false;
                const q = query.toLowerCase();
                return (p.name && p.name.toLowerCase().includes(q)) ||
                    (p.code && (p.code.toLowerCase() === q || p.code.toLowerCase().startsWith(q))) ||
                    (p.barcodes && p.barcodes.some(b => b.toLowerCase() === q || b.toLowerCase().startsWith(q)));
            });

            if (product) {
                items[idx].isPreview = true;
                items[idx].tempProductId = product.id;
                items[idx].itemCode = product.code || items[idx].itemCode;
                items[idx].barcode = product.barcodes?.[0] || items[idx].barcode;
                items[idx].description = product.name || items[idx].description;
                items[idx].cost = product.cost || product.price || 0;

                // Surgical update to UI to show "demo" state
                const row = document.getElementById('tableBody').children[idx];
                if (row) {
                    const inputs = row.querySelectorAll('input');
                    // indices: 0:itemCode, 1:barcode, 2:description, 3:qty, 4:unit, 5:cost, 6:discount
                    if (field !== 'itemCode') inputs[0].value = product.code || '';
                    if (field !== 'barcode') inputs[1].value = product.barcodes?.[0] || '';
                    if (field !== 'description') inputs[2].value = product.name || '';
                    inputs[5].value = product.cost || product.price || 0;

                    // Apply preview styling
                    inputs.forEach((inp, i) => {
                        if ([0, 1, 2, 5].includes(i)) {
                            const fNames = ['itemCode', 'barcode', 'description', 'cost'];
                            if (fNames[i === 5 ? 3 : i] !== field) {
                                inp.classList.add('preview-text');
                            }
                        }
                    });
                }
            } else {
                items[idx].isPreview = false;
                items[idx].tempProductId = null;
                // Remove preview styling
                const row = document.getElementById('tableBody').children[idx];
                if (row) {
                    row.querySelectorAll('input').forEach(inp => inp.classList.remove('preview-text'));
                }
            }
        }

        function handleGridKey(idx, e) {
            if (e.key === 'Enter') {
                if (items[idx].isPreview && items[idx].tempProductId) {
                    e.preventDefault();
                    confirmSelection(idx);
                }
            } else if (e.key === 'Escape') {
                if (items[idx].isPreview) {
                    items[idx].isPreview = false;
                    renderTable();
                }
            }
        }

        function confirmSelection(idx) {
            const productId = items[idx].tempProductId;
            const product = productsMap.get(productId);
            if (!product) return;

            items[idx] = {
                product_id: product.id,
                itemCode: product.code || '',
                barcode: product.barcodes?.[0] || '',
                description: product.name || '',
                qty: 1,
                pcsBox: product.pcs_per_box || 1, // legacy field
                unitId: product.unit_id || '',
            };

            renderTable();

            // Focus quantity field
            setTimeout(() => {
                const row = document.getElementById('tableBody').children[idx];
                if (row) {
                    const qtyInput = row.querySelectorAll('input')[3];
                    if (qtyInput) {
                        qtyInput.focus();
                        qtyInput.select();
                    }
                }
            }, 50);
        }


        function updateItem(index, field, value) {
            items[index][field] = value;
            if (field === 'unitId') {
                // optionally keep human-readable name
                items[index].unitName = unitsMap.get(value) || '';
            }
            if (['qty', 'cost', 'discount', 'pcsBox'].includes(field)) {
                const qty = parseFloat(items[index].qty) || 0;
                const cost = parseFloat(items[index].cost) || 0;
                const dStr = items[index].discount?.toString() || '0';
                let d = dStr.includes('%') ? (parseFloat(dStr) / 100) * (qty * cost) : parseFloat(dStr) || 0;
                items[index].amount = (qty * cost) - d;

                // update amount cell without redrawing whole table
                const row = document.getElementById('tableBody').children[index];
                if (row) {
                    const amountCell = row.children[8];
                    if (amountCell) amountCell.textContent = items[index].amount.toLocaleString();
                }
                calculateTotals();
            }
        }
        function addRow() {
            items.push({
                product_id: null,
                itemCode: '',
                barcode: '',
                description: '',
                qty: 0,
                pcsBox: '',
                unitId: '',
                cost: 0,
                discount: '0',
                amount: 0,
                remark: '',
                isPreview: false,
                tempProductId: null
            });
            renderTable();
        }

        function removeRow(index) {
            items.splice(index, 1);
            if (items.length === 0) addRow();
            renderTable();
        }

        function calculateTotals() {
            const sub = items.reduce((acc, i) => acc + (parseFloat(i.amount) || 0), 0);
            const taxP = parseFloat(document.getElementById('taxPercent').value) || 0;
            const disc = parseFloat(document.getElementById('overallDiscount').value) || 0;
            const ship = parseFloat(document.getElementById('shipping').value) || 0;
            const paid = parseFloat(document.getElementById('paidAmount').value) || 0;

            const taxA = (sub * taxP) / 100;
            const net = sub + taxA + ship - disc;

            document.getElementById('displaySubTotal').innerText = sub.toLocaleString();
            document.getElementById('displayTax').innerText = taxA.toLocaleString();
            document.getElementById('displayDiscount').innerText = '-' + disc.toLocaleString();
            document.getElementById('displayShipping').innerText = ship.toLocaleString();
            document.getElementById('displayNet').innerText = net.toLocaleString();

            const rem = net - paid;
            document.getElementById('remainAmount').innerText = rem.toLocaleString();

            const badge = document.getElementById('remainBadge');
            if (badge) {
                badge.innerText = `Rem: ${rem.toLocaleString()}`;
                if (paid > 0 || rem !== net) badge.classList.remove('hidden');
                else badge.classList.add('hidden');
            }
        }

        function generateVoucherCode() {
            const now = new Date();
            const date = now.toISOString().slice(0, 10).replace(/-/g, '');
            const random = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
            return `PO-${date}-${random}`;
        }

        async function saveDraft() {
            await submitOrder('Draft');
        }

        async function submitOrder(status = 'Ordered') {
            try {
                const supplier_id = document.getElementById('supplierId').value;
                const warehouse_id = document.getElementById('warehouseId').value;

                if (!supplier_id || !warehouse_id) {
                    alert('‚ö†Ô∏è Please select Supplier and Warehouse.');
                    return;
                }

                const validItems = items.filter(i => (i.product_id || status === 'Draft') && (i.qty > 0 || status === 'Draft'));
                if (validItems.length === 0 && status !== 'Draft') {
                    alert('‚ö†Ô∏è Please add at least one valid item.');
                    return;
                }

                let ref_code = document.getElementById('voucherCode').value || generateVoucherCode();

                // Calculate totals for saving
                const sub = validItems.reduce((acc, i) => acc + i.amount, 0);
                const taxP = parseFloat(document.getElementById('taxPercent').value) || 0;
                const disc = parseFloat(document.getElementById('overallDiscount').value) || 0;
                const ship = parseFloat(document.getElementById('shipping').value) || 0;
                const paid = parseFloat(document.getElementById('paidAmount').value) || 0;

                const taxA = (sub * taxP) / 100;
                const net = sub + taxA + ship - disc;

                const orderData = {
                    reference_no: ref_code,
                    date: document.getElementById('orderDate').value || new Date().toISOString().split('T')[0],
                    supplier_id,
                    warehouse_id,
                    status: status,
                    payment_status: paid >= net ? 'Paid' : (paid > 0 ? 'Partial' : 'Unpaid'),
                    payment_type: document.getElementById('paymentType').value,
                    total_qty: validItems.reduce((acc, i) => acc + (parseFloat(i.qty) || 0), 0),
                    grand_total: net,
                    order_tax_percentage: taxP,
                    order_tax_amount: taxA,
                    discount_amount: disc,
                    shipping_amount: ship,
                    paid_amount: paid,
                    note: document.getElementById('orderNote').value || null,
                    // Additional Metadata
                    shipping_method: document.getElementById('shippingMethod').value,
                    priority: document.getElementById('priority').value,
                    agent_name: document.getElementById('agentName').value,
                    instructions: document.getElementById('orderInstructions').value,
                    expected_delivery: document.getElementById('expectedDelivery').value || null
                };

                let purchaseId;
                if (loadedOrderId) {
                    const { data: pData, error: pErr } = await supabase.from('purchases').update(orderData).eq('id', loadedOrderId).select().single();
                    if (pErr) throw pErr;
                    purchaseId = pData.id;
                    // Delete old items for clean re-insertion
                    await supabase.from('purchase_items').delete().eq('purchase_id', purchaseId);
                } else {
                    const { data: pData, error: pErr } = await supabase.from('purchases').insert(orderData).select().single();
                    if (pErr) throw pErr;
                    purchaseId = pData.id;
                }

                // Insert items
                const itemsToInsert = validItems.map(item => ({
                    purchase_id: purchaseId,
                    product_id: item.product_id,
                    quantity: parseFloat(item.qty) || 0,
                    unit_cost: parseFloat(item.cost) || 0,
                    discount_amount: parseFloat(item.discount) || 0,
                    subtotal: item.amount,
                    // new unit reference (falls back to null)
                    unit_id: item.unitId || null,
                    // keep old field for compatibility if still used elsewhere
                    pcs_box: item.pcsBox,
                    remark: item.remark
                }));

                if (itemsToInsert.length > 0) {
                    const { error: itemErr } = await supabase.from('purchase_items').insert(itemsToInsert);
                    if (itemErr) throw itemErr;
                }

                document.getElementById('voucherCode').value = ref_code;
                document.getElementById('copyBtn').classList.remove('hidden');

                const isDraft = status === 'Draft';
                showSuccessModal(ref_code, isDraft);

            } catch (err) {
                console.error('Save error:', err);
                alert('‚ùå Failed to save order: ' + err.message);
            }
        }

        function showSuccessModal(code, isDraft) {
            let modalHtml = `
                    <div id="successModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(15, 23, 42, 0.85);z-index:9999;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(12px);">
                        <div class="glass-card" style="padding:40px;max-width:420px;width:95%;text-align:center;border-radius:24px;box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);">
                            <div style="font-size:50px;margin-bottom:20px;">${isDraft ? 'üíæ' : '‚ú®'}</div>
                            <h2 style="color:#fff;margin-bottom:10px;font-size:24px;font-weight:800;letter-spacing:-0.5px;">${isDraft ? 'Draft Saved!' : 'Order Submitted!'}</h2>
                            <p style="color:var(--text-muted);font-size:14px;margin-bottom:24px;">${isDraft ? 'Your progress has been saved as a draft.' : 'Purchase order successfully synced to system.'}</p>
                            
                            <div style="background:rgba(255,255,255,0.05);padding:15px;border-radius:12px;margin-bottom:24px;border:1px dashed var(--primary); display:flex; align-items:center; justify-content:center; gap:10px;">
                                <span style="color:var(--primary);font-family:monospace;font-size:20px;font-weight:800;letter-spacing:1px;">${code}</span>
                                <button onclick="copyToClipboard('${code}')" class="text-white/20 hover:text-white transition-colors" title="Copy Code">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>

                            <div style="display:flex;gap:12px;justify-content:center;">
                                <button onclick="window.location.reload()" style="flex:1;background:rgba(255,255,255,0.1);color:white;padding:12px;border-radius:12px;font-weight:700;font-size:12px;cursor:pointer;border:none;">NEW ORDER</button>
                                <button onclick="document.getElementById('successModal').remove()" style="flex:1;background:var(--primary);color:white;padding:12px;border-radius:12px;font-weight:700;font-size:12px;">KEEP EDITING</button>
                            </div>
                        </div>
                    </div>
                `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        async function viewRecentOrders() {
            await listOrders('Ordered', 'üìã RECENT PURCHASE ORDERS');
        }

        async function viewDrafts() {
            await listOrders('Draft', 'üíæ SAVED DRAFTS');
        }

        async function listOrders(status, title) {
            try {
                const { data, error } = await supabase
                    .from('purchases')
                    .select('*, supplier:suppliers(name)')
                    .eq('status', status)
                    .order('date', { ascending: false })
                    .limit(20);

                if (error) throw error;

                if (!data || data.length === 0) {
                    alert(`No ${status.toLowerCase()} orders found.`);
                    return;
                }

                let html = `<div id="listModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(15, 23, 42, 0.9);z-index:9999;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(15px);" onclick="this.remove()">`;
                html += `<div class="glass-card" style="padding:30px;max-width:900px;width:95%;max-height:85vh;overflow-y:auto;border-radius:24px; box-shadow: 0 40px 100px -20px rgba(0,0,0,0.6);" onclick="event.stopPropagation()">`;
                html += `<div class="flex justify-between items-center mb-6">`;
                html += `<h2 style="color:var(--primary);font-size:20px;font-weight:800;letter-spacing:-0.5px;">${title}</h2>`;
                html += `<button onclick="this.closest('#listModal').remove()" style="color:var(--text-muted);font-size:28px;line-height:1;">√ó</button>`;
                html += `</div>`;
                html += `<table style="width:100%;border-collapse:collapse;">`;
                html += `<thead><tr style="border-bottom:2px solid rgba(255,255,255,0.1);"><th style="text-align:left;padding:12px;color:var(--text-muted);font-size:10px;text-transform:uppercase;font-weight:800;">Reference</th><th style="text-align:left;padding:12px;color:var(--text-muted);font-size:10px;text-transform:uppercase;font-weight:800;">Date</th><th style="text-align:left;padding:12px;color:var(--text-muted);font-size:10px;text-transform:uppercase;font-weight:800;">Supplier</th><th style="text-align:right;padding:12px;color:var(--text-muted);font-size:10px;text-transform:uppercase;font-weight:800;">Grand Total</th><th style="text-align:center;padding:12px;color:var(--text-muted);font-size:10px;text-transform:uppercase;font-weight:800;">Action</th></tr></thead>`;
                html += `<tbody>`;

                data.forEach(order => {
                    html += `<tr style="border-bottom:1px solid rgba(255,255,255,0.05);" class="hover:bg-white/5 transition-colors">`;
                    html += `<td style="padding:12px;color:var(--primary);font-weight:700;font-size:12px;">
                        <div class="flex items-center gap-2">
                            ${order.reference_no}
                            <button onclick="copyToClipboard('${order.reference_no}')" class="w-6 h-6 flex items-center justify-center rounded-md bg-white/5 hover:bg-white/20 text-indigo-300 hover:text-white transition-all border border-white/5 hover:border-white/20" title="Copy">
                                <i class="fas fa-copy text-[10px]"></i>
                            </button>
                        </div>
                    </td>`;
                    html += `<td style="padding:12px;color:#f1f5f9;font-size:12px;">${new Date(order.date).toLocaleDateString()}</td>`;
                    html += `<td style="padding:12px;color:#f1f5f9;font-size:12px;">${order.supplier?.name || 'N/A'}</td>`;
                    html += `<td style="padding:12px;color:var(--success);font-weight:700;text-align:right;font-size:12px;">${order.grand_total.toLocaleString()} Ks</td>`;
                    html += `<td style="padding:12px;text-align:center;">
                        <div class="flex gap-2 justify-center">
                            <button onclick="loadOrder('${order.id}'); this.closest('#listModal').remove();" class="bg-indigo-500/20 hover:bg-indigo-500/40 text-indigo-400 px-3 py-1.5 rounded-lg text-[10px] font-bold transition-all">LOAD</button>
                            <button onclick="deleteOrder('${order.id}', '${status}')" class="bg-red-500/10 hover:bg-red-500/20 text-red-400 px-3 py-1.5 rounded-lg text-[10px] font-bold transition-all"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </td>`;
                    html += `</tr>`;
                });

                html += `</tbody></table>`;
                html += `</div></div>`;

                document.body.insertAdjacentHTML('beforeend', html);

            } catch (err) {
                console.error('Load orders error:', err);
                alert('Failed to load orders: ' + err.message);
            }
        }

        async function deleteOrder(id, currentStatus) {
            if (!confirm(`Are you sure you want to delete this ${currentStatus.toLowerCase()}? This cannot be undone.`)) return;

            try {
                // Delete items first (foreign key constraint)
                const { error: itemErr } = await supabase.from('purchase_items').delete().eq('purchase_id', id);
                if (itemErr) throw itemErr;

                // Delete purchase
                const { error: pErr } = await supabase.from('purchases').delete().eq('id', id);
                if (pErr) throw pErr;

                alert('Successfully deleted.');

                // Refresh list if modal is open
                const modal = document.getElementById('listModal');
                if (modal) {
                    modal.remove();
                    listOrders(currentStatus, currentStatus === 'Draft' ? 'üíæ SAVED DRAFTS' : 'üìã RECENT PURCHASE ORDERS');
                }

                // If we were editing this specific order, clear the form
                if (loadedOrderId === id) {
                    window.location.reload();
                }

            } catch (err) {
                console.error('Delete error:', err);
                alert('Failed to delete order: ' + err.message);
            }
        }

        async function loadOrder(id) {
            try {
                const { data: order, error } = await supabase
                    .from('purchases')
                    .select('*, purchase_items(*)')
                    .eq('id', id)
                    .single();

                if (error) throw error;

                loadedOrderId = order.id;
                document.getElementById('voucherCode').value = order.reference_no;
                document.getElementById('orderDate').value = order.date;
                document.getElementById('supplierId').value = order.supplier_id;
                document.getElementById('warehouseId').value = order.warehouse_id;
                document.getElementById('referenceNo').value = order.reference_no_ext || '';
                document.getElementById('orderNote').value = order.note || '';
                document.getElementById('shippingMethod').value = order.shipping_method || '';
                document.getElementById('priority').value = order.priority || 'Normal';
                document.getElementById('agentName').value = order.agent_name || '';
                document.getElementById('orderInstructions').value = order.instructions || '';
                document.getElementById('expectedDelivery').value = order.expected_delivery || '';

                // Restore Financials
                document.getElementById('taxPercent').value = order.order_tax_percentage || 0;
                document.getElementById('overallDiscount').value = order.discount_amount || 0;
                document.getElementById('shipping').value = order.shipping_amount || 0;
                document.getElementById('paidAmount').value = order.paid_amount || 0;
                document.getElementById('paymentType').value = order.payment_type || 'Cash';
                // taxCode might differ per implementation, assuming defaults for now or if saved

                document.getElementById('copyBtn').classList.remove('hidden');
                document.getElementById('loadedIndicator').classList.remove('hidden');

                items = order.purchase_items.map(pi => {
                    const prod = productsMap.get(pi.product_id);
                    return {
                        product_id: pi.product_id,
                        itemCode: prod?.code || '',
                        barcode: prod?.barcodes?.[0] || '',
                        description: prod?.name || '',
                        qty: pi.quantity,
                        pcsBox: pi.pcs_box, // legacy
                        unitId: pi.unit_id || prod?.unit_id || '',
                        cost: pi.unit_cost,
                        discount: pi.discount_amount,
                        amount: pi.subtotal,
                        remark: pi.remark,
                        isPreview: false,
                        tempProductId: null
                    };
                });

                if (items.length === 0) addRow();
                renderTable();
                calculateTotals();

            } catch (err) {
                console.error('Load error:', err);
                alert('Failed to load order detalles.');
            }
        }

        function copyToClipboard(text) {
            if (!text) return;
            navigator.clipboard.writeText(text).then(() => {
                const toast = document.createElement('div');
                toast.style = "position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:var(--primary);color:white;padding:10px 20px;border-radius:30px;font-weight:700;font-size:12px;z-index:100000;box-shadow:var(--shadow-glow);";
                toast.innerHTML = `<i class="fas fa-check-circle mr-2"></i> Copied to Clipboard!`;
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 2000);
            });
        }
    </script>
</body>

</html>