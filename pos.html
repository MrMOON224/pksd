<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS - Point of Sale</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #818cf8;
            --bg-main: #0f172a;
            --bg-card: rgba(30, 41, 59, 0.7);
            --text-main: #f8fafc;
            --text-dim: #94a3b8;
            --border-color: rgba(255, 255, 255, 0.1);
            --accent-green: #10b981;
            --accent-pink: #ec4899;
            --accent-yellow: #f59e0b;
            --accent-red: #ef4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            background: var(--bg-main);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Top Banner */
        .pos-banner {
            background: #b91c1c;
            color: white;
            padding: 4px 15px;
            font-size: 13px;
            font-weight: 600;
            text-align: center;
        }

        /* Top Meta Section */
        .pos-meta-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1.5fr 1fr;
            gap: 10px;
            padding: 10px 20px;
            background: rgba(15, 23, 42, 0.4);
            border-bottom: 1px solid var(--border-color);
        }

        .meta-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .meta-label {
            font-size: 11px;
            color: var(--text-dim);
            text-transform: uppercase;
        }

        .meta-value {
            font-size: 14px;
            font-weight: 600;
        }

        /* Search Section */
        .search-section {
            padding: 15px 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .search-placeholder-hint {
            font-size: 12px;
            color: var(--accent-yellow);
            font-style: italic;
        }

        .search-input-group {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .search-bar-container {
            flex: 1;
            position: relative;
        }

        .search-bar-container i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-dim);
        }

        .search-input {
            width: 100%;
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px 12px 12px 45px;
            color: white;
            outline: none;
            font-size: 14px;
        }

        .scan-indicator {
            background: #fde047;
            color: #000;
            padding: 10px 15px;
            border-radius: 8px;
            font-weight: 800;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Main Content */
        .pos-body {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 450px;
            gap: 20px;
            padding: 0 20px 20px;
            overflow: hidden;
        }

        /* Cart Table */
        .cart-container {
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .cart-table-wrapper {
            flex: 1;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            position: sticky;
            top: 0;
            background: rgba(15, 23, 42, 0.9);
            padding: 12px 15px;
            text-align: left;
            font-size: 12px;
            font-weight: 700;
            color: var(--text-dim);
            border-bottom: 2px solid var(--border-color);
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 14px;
        }

        tr.selected {
            background: rgba(99, 102, 241, 0.2);
        }

        /* Control Panel */
        .control-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .panel-top-grid {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 8px;
        }

        .panel-btn {
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid var(--border-color);
            padding: 15px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .total-display {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid var(--border-color);
            padding: 15px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .total-amount-big {
            font-size: 24px;
            font-weight: 800;
            color: var(--primary-light);
        }

        /* Numpad */
        .numpad-payment-section {
            display: grid;
            grid-template-columns: 1.5fr 1fr;
            gap: 15px;
        }

        .numpad-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .num-btn {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid var(--border-color);
            aspect-ratio: 1.2;
            border-radius: 8px;
            color: white;
            font-size: 20px;
            font-weight: 700;
            cursor: pointer;
        }

        .num-btn:hover {
            background: var(--primary);
        }

        .num-btn:active {
            transform: scale(0.95);
        }

        /* Payment Methods */
        .payment-methods {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .pay-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            padding: 8px;
            border-radius: 4px;
            color: var(--text-dim);
            font-size: 12px;
            text-align: left;
            cursor: pointer;
        }

        .pay-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        /* Action Buttons */
        .action-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .action-btn {
            background: #b91c1c;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 6px;
            font-weight: 700;
            font-size: 11px;
            cursor: pointer;
            text-transform: uppercase;
        }

        .action-btn.active {
            background: var(--accent-green);
            box-shadow: 0 0 10px var(--accent-green);
        }

        /* Summary */
        .summary-footer {
            margin-top: auto;
            border-top: 2px solid var(--border-color);
            padding-top: 15px;
        }

        .summary-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 6px;
            font-size: 13px;
        }

        .summary-label {
            color: var(--text-dim);
        }

        .summary-value {
            text-align: right;
            font-weight: 700;
        }

        .summary-value.total {
            font-size: 18px;
            color: var(--primary-light);
        }

        /* Focus styles for numpad routing */
        .focused-field {
            border-color: var(--primary) !important;
            box-shadow: 0 0 5px var(--primary);
        }

        /* Print Styles */
        @media print {
            body * {
                visibility: hidden;
            }

            #receiptTemplate,
            #receiptTemplate * {
                visibility: visible;
            }

            #receiptTemplate {
                position: absolute;
                left: 0;
                top: 0;
                width: 80mm;
                color: black;
                background: white;
                padding: 10px;
            }

            .no-print {
                display: none;
            }
        }

        #receiptTemplate {
            display: none;
        }
    </style>
</head>

<body>
    <div class="pos-banner no-print">pos / sale Screen</div>

    <div class="pos-meta-grid no-print">
        <div class="meta-item">
            <span class="meta-label">Customer Shop</span>
            <span class="meta-value">Main Branch</span>
        </div>
        <div class="meta-item">
            <span class="meta-label">Cashier</span>
            <span class="meta-value" id="cashierName">Cashier 1</span>
        </div>
        <div class="meta-item">
            <span class="meta-label">Voucher No</span>
            <span class="meta-value" id="voucherNo">#010100001</span>
        </div>
        <div class="meta-item">
            <span class="meta-label">Date</span>
            <span class="meta-value" id="posDate">--/--/----</span>
        </div>
    </div>

    <div class="search-section no-print">
        <div class="search-placeholder-hint">
            ( Search / filter ) - item code / barcode / description / Category / Sub-Category / Brand /
        </div>
        <div class="search-input-group">
            <div class="search-bar-container">
                <i class="fas fa-search"></i>
                <input type="text" id="mainSearch" class="search-input" placeholder="Enter keywords or scan barcode..."
                    autofocus>
            </div>
            <div class="scan-indicator">
                <i class="fas fa-qrcode"></i> SCAN \ OR PHONE SCAN
            </div>
        </div>
    </div>

    <div class="pos-body no-print">
        <div class="cart-container">
            <div class="cart-table-wrapper">
                <table id="cartTable">
                    <thead>
                        <tr>
                            <th style="width: 40px;">No</th>
                            <th style="width: 150px;">item Code</th>
                            <th>description</th>
                            <th style="width: 100px;">Sale Qty</th>
                            <th style="width: 120px;">Price</th>
                            <th style="width: 100px;">Discount</th>
                            <th style="width: 150px;">Amount</th>
                        </tr>
                    </thead>
                    <tbody id="cartBody"></tbody>
                </table>
            </div>
        </div>

        <div class="control-panel">
            <div class="panel-top-grid">
                <button class="panel-btn" onclick="holdSale()"><i class="fas fa-pause"></i> Hold</button>
                <button class="panel-btn" onclick="clearCart()"><i class="fas fa-trash-alt"></i> Delete</button>
                <button class="panel-btn" onclick="showSaleList()">show sale list</button>
            </div>

            <div class="total-display">
                <span class="meta-label" style="font-weight: 800;">TOTAL AMOUNT</span>
                <span class="total-amount-big" id="rightPanelTotal">0.00</span>
            </div>

            <div class="numpad-payment-section">
                <div class="numpad-grid">
                    <button class="num-btn" onclick="pressNum('1')">1</button>
                    <button class="num-btn" onclick="pressNum('2')">2</button>
                    <button class="num-btn" onclick="pressNum('3')">3</button>
                    <button class="num-btn" onclick="pressNum('4')">4</button>
                    <button class="num-btn" onclick="pressNum('5')">5</button>
                    <button class="num-btn" onclick="pressNum('6')">6</button>
                    <button class="num-btn" onclick="pressNum('7')">7</button>
                    <button class="num-btn" onclick="pressNum('8')">8</button>
                    <button class="num-btn" onclick="pressNum('9')">9</button>
                    <button class="num-btn" onclick="pressNum('0')">0</button>
                    <button class="num-btn" style="background:#475569;" onclick="clearFocusedInput()">C</button>
                    <button class="num-btn" style="background:#475569;" onclick="pressNum('.')">.</button>
                </div>
                <div class="payment-methods">
                    <span class="meta-label">Payment Mode</span>
                    <button class="pay-btn pay-mode-btn active" data-mode="Cash"
                        onclick="setPayment('Cash')">Cash</button>
                    <button class="pay-btn pay-mode-btn" data-mode="Credit"
                        onclick="setPayment('Credit')">Credit</button>
                    <button class="pay-btn pay-mode-btn" data-mode="k pay" onclick="setPayment('k pay')">k pay</button>
                    <button class="pay-btn pay-mode-btn" data-mode="wave pay" onclick="setPayment('wave pay')">wave
                        pay</button>
                    <button class="pay-btn pay-mode-btn" data-mode="Mity Pay" onclick="setPayment('Mity Pay')">Mity
                        Pay</button>
                    <div style="margin-top: 5px;">
                        <span class="meta-label">Remark</span>
                        <input type="text" id="remark" placeholder="..." class="search-input"
                            style="padding: 5px; font-size: 11px;">
                    </div>
                </div>
            </div>

            <div class="action-row">
                <button class="action-btn" id="btnQty" onclick="setFocus('qty')">QTY</button>
                <button class="action-btn" id="btnPrice" onclick="setFocus('price')">PRICE</button>
                <button class="action-btn" style="background:var(--accent-green)"
                    onclick="processTransaction(false)">CONFIRM</button>
                <button class="action-btn" style="background:var(--accent-yellow); color:#000;"
                    onclick="processTransaction(true)">IRM AND PRINT</button>
            </div>

            <div class="summary-footer">
                <div class="summary-row">
                    <span class="summary-label">tax % OR cash</span>
                    <input type="number" class="search-input summary-input"
                        style="width:100px; height:30px; text-align:right;" value="0" id="taxInput"
                        oninput="calculateTotals()" onfocus="setFocus('tax')">
                </div>
                <div class="summary-row">
                    <span class="summary-label">discount % OR cash</span>
                    <input type="number" class="search-input summary-input"
                        style="width:100px; height:30px; text-align:right;" value="0" id="discountInput"
                        oninput="calculateTotals()" onfocus="setFocus('discount_summary')">
                </div>
                <div class="summary-row">
                    <span class="summary-label">Service Fees % OR cash</span>
                    <input type="number" class="search-input summary-input"
                        style="width:100px; height:30px; text-align:right;" value="0" id="serviceFeeInput"
                        oninput="calculateTotals()" onfocus="setFocus('service')">
                </div>
                <div class="summary-row">
                    <span class="summary-label">Total Amount</span>
                    <span class="summary-value total" id="footerTotal">0.00</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">Pay amount</span>
                    <input type="number" class="search-input summary-input"
                        style="width:120px; font-weight:800; font-size:16px; text-align:right; border-color:var(--accent-green);"
                        value="0" id="payAmountInput" oninput="calculateTotals()" onfocus="setFocus('pay')">
                </div>
                <div class="summary-row">
                    <span class="summary-label">refun Amount - or +</span>
                    <span class="summary-value" id="refundAmount" style="color:var(--accent-pink);">0.00</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Receipt Template -->
    <div id="receiptTemplate">
        <div style="text-align:center; margin-bottom: 20px;">
            <h2 id="receiptStoreName">Pos Store</h2>
            <p id="receiptVoucherNo"></p>
            <p id="receiptDate"></p>
        </div>
        <table style="width:100%; font-size: 12px; border-bottom: 1px dashed #000;">
            <thead>
                <tr>
                    <th style="text-align:left;">Item</th>
                    <th style="text-align:right;">Qty</th>
                    <th style="text-align:right;">Sub</th>
                </tr>
            </thead>
            <tbody id="receiptItems"></tbody>
        </table>
        <div style="margin-top: 10px; text-align:right;">
            <p>Total: <span id="receiptTotal"></span></p>
            <p>Paid: <span id="receiptPaid"></span></p>
            <p>Change: <span id="receiptChange"></span></p>
        </div>
        <div style="text-align:center; margin-top:20px;">
            <p>Thank You!</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="js/supabase-client.js"></script>
    <script>
        let cart = [];
        let allProducts = [];
        let editId = null;
        let selectedIndex = -1;
        let currentFocus = 'search'; // 'search', 'qty', 'price', 'discount', 'tax', 'service', 'pay'
        let paymentMode = 'Cash';

        async function init() {
            const now = new Date();
            document.getElementById('posDate').textContent = now.toLocaleDateString() + ' ' + now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            await fetchProducts();
            await generateVoucherNo();

            const params = new URLSearchParams(window.location.search);
            editId = params.get('transactionId');
            if (editId) await loadTransaction(editId);

            document.addEventListener('keydown', handleGlobalKey);
            setupNumpadRouting();
        }

        async function fetchProducts() {
            const { data } = await supabase.from('products').select('*');
            allProducts = data || [];
        }

        async function generateVoucherNo() {
            try {
                const { data, error } = await supabase
                    .from('transactions')
                    .select('voucher_no')
                    .order('created_at', { ascending: false })
                    .limit(1);

                let nextNum = 1;
                if (data && data.length > 0 && data[0].voucher_no) {
                    const lastNum = parseInt(data[0].voucher_no.replace('#', '')) || 0;
                    nextNum = lastNum + 1;
                }
                const numStr = nextNum.toString().padStart(8, '0');
                document.getElementById('voucherNo').textContent = '#' + numStr;
            } catch (e) { console.error('Voucher Gen Error:', e); }
        }

        function setupNumpadRouting() {
            // Automatically focus search on click elsewhere
            document.body.addEventListener('click', (e) => {
                if (e.target.tagName !== 'INPUT' && !e.target.classList.contains('num-btn') && !e.target.classList.contains('action-btn')) {
                    // if (!currentFocus.includes('qty') && !currentFocus.includes('price')) focusSearch();
                }
            });
        }

        function handleGlobalKey(e) {
            if (e.key === 'F1') { e.preventDefault(); setFocus('search'); }
            if (e.key === 'F2') { e.preventDefault(); setFocus('qty'); }
            if (e.key === 'F3') { e.preventDefault(); setFocus('price'); }
            if (e.key === 'Enter') {
                if (document.activeElement.id === 'mainSearch') {
                    const q = document.getElementById('mainSearch').value;
                    handleSearch(q);
                    document.getElementById('mainSearch').value = '';
                }
            }
        }

        function setFocus(focusType) {
            currentFocus = focusType;
            const searchInput = document.getElementById('mainSearch');

            // UI Feedback
            document.querySelectorAll('.action-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.summary-input').forEach(i => i.classList.remove('focused-field'));

            if (focusType === 'search') {
                searchInput.focus();
            } else if (focusType === 'qty') {
                document.getElementById('btnQty').classList.add('active');
            } else if (focusType === 'price') {
                document.getElementById('btnPrice').classList.add('active');
            } else {
                const map = { tax: 'taxInput', discount_summary: 'discountInput', service: 'serviceFeeInput', pay: 'payAmountInput' };
                const target = document.getElementById(map[focusType]);
                if (target) {
                    target.classList.add('focused-field');
                    target.focus();
                }
            }
        }

        function handleSearch(query) {
            if (!query) return;
            const p = allProducts.find(x => x.item_code === query || x.barcode === query || x.name.toLowerCase().includes(query.toLowerCase()));
            if (p) addToCart(p);
            else alert('Product not found: ' + query);
        }

        function addToCart(p) {
            const existing = cart.find(x => x.id === p.id);
            if (existing) {
                existing.qty++;
            } else {
                cart.push({
                    id: p.id,
                    code: p.item_code || 'N/A',
                    name: p.name,
                    price: p.price || 0,
                    qty: 1,
                    discount: 0
                });
            }
            selectedIndex = cart.length - 1;
            renderCart();
            setFocus('qty'); // Default focus to QTY after adding
        }

        function renderCart() {
            const body = document.getElementById('cartBody');
            body.innerHTML = cart.map((item, i) => `
                <tr class="${selectedIndex === i ? 'selected' : ''}" onclick="selectItem(${i})">
                    <td>${i + 1}</td>
                    <td style="font-weight:700;">${item.code}</td>
                    <td>${item.name}</td>
                    <td>${item.qty}</td>
                    <td>${item.price.toLocaleString()}</td>
                    <td>${item.discount.toLocaleString()}</td>
                    <td style="font-weight:800; text-align:right;">${((item.qty * item.price) - item.discount).toLocaleString()}</td>
                </tr>
            `).join('');
            calculateTotals();
        }

        function selectItem(i) {
            selectedIndex = i;
            renderCart();
        }

        function calculateTotals() {
            const subtotal = cart.reduce((sum, item) => sum + ((item.qty * item.price) - item.discount), 0);
            const tax = parseFloat(document.getElementById('taxInput').value) || 0;
            const discount = parseFloat(document.getElementById('discountInput').value) || 0;
            const service = parseFloat(document.getElementById('serviceFeeInput').value) || 0;

            const total = subtotal + tax + service - discount;
            const pay = parseFloat(document.getElementById('payAmountInput').value) || 0;
            const refund = pay - total;

            document.getElementById('rightPanelTotal').textContent = total.toLocaleString();
            document.getElementById('footerTotal').textContent = total.toLocaleString();
            document.getElementById('refundAmount').textContent = refund.toLocaleString();
        }

        function pressNum(n) {
            // Numpad input routing
            if (currentFocus === 'search') {
                const inp = document.getElementById('mainSearch');
                inp.value += n;
                return;
            }

            if (selectedIndex === -1 && !['tax', 'discount_summary', 'service', 'pay'].includes(currentFocus)) return;

            if (['tax', 'discount_summary', 'service', 'pay'].includes(currentFocus)) {
                // Route to summary inputs
                const map = { tax: 'taxInput', discount_summary: 'discountInput', service: 'serviceFeeInput', pay: 'payAmountInput' };
                const input = document.getElementById(map[currentFocus]);
                input.value = (input.value === '0' ? '' : input.value) + n;
                calculateTotals();
                return;
            }

            // Route to cart item
            if (currentFocus === 'qty') {
                const valStr = cart[selectedIndex].qty.toString();
                cart[selectedIndex].qty = parseFloat((valStr === '1' && n !== '.' ? n : valStr + n)) || 0;
            } else if (currentFocus === 'price') {
                const valStr = cart[selectedIndex].price.toString();
                cart[selectedIndex].price = parseFloat((valStr === '0' && n !== '.' ? n : valStr + n)) || 0;
            }
            renderCart();
        }

        function clearFocusedInput() {
            if (['tax', 'discount_summary', 'service', 'pay'].includes(currentFocus)) {
                const map = { tax: 'taxInput', discount_summary: 'discountInput', service: 'serviceFeeInput', pay: 'payAmountInput' };
                document.getElementById(map[currentFocus]).value = '0';
                calculateTotals();
                return;
            }
            if (selectedIndex !== -1) {
                if (currentFocus === 'qty') cart[selectedIndex].qty = 1;
                if (currentFocus === 'price') cart[selectedIndex].price = 0;
                renderCart();
            }
            document.getElementById('mainSearch').value = '';
        }

        function setPayment(mode) {
            paymentMode = mode;
            document.querySelectorAll('.pay-mode-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`[data-mode="${mode}"]`).classList.add('active');
        }

        async function processTransaction(shouldPrint) {
            if (cart.length === 0) return alert('Cart is empty!');

            const total = parseFloat(document.getElementById('footerTotal').textContent.replace(/,/g, ''));
            const paid = parseFloat(document.getElementById('payAmountInput').value) || 0;
            const voucher = document.getElementById('voucherNo').textContent;

            try {
                // Header
                const transData = {
                    total: total,
                    paid_amount: paid,
                    payment_method: paymentMode,
                    payment_status: paid >= total ? 'completed' : 'partial',
                    status: 'completed',
                    remark: document.getElementById('remark').value,
                    voucher_no: voucher
                };

                let transaction;
                if (editId) {
                    const { data, error } = await supabase.from('transactions').update(transData).eq('id', editId).select().single();
                    if (error) throw error;
                    transaction = data;
                    // Delete old items
                    await supabase.from('transaction_items').delete().eq('transaction_id', editId);
                } else {
                    const { data, error } = await supabase.from('transactions').insert([transData]).select().single();
                    if (error) throw error;
                    transaction = data;
                }

                // Lines
                const items = cart.map(item => ({
                    transaction_id: transaction.id,
                    product_id: item.id,
                    product_name: item.name,
                    quantity: item.qty,
                    price: item.price,
                    subtotal: (item.qty * item.price) - item.discount
                }));

                const { error: itErr } = await supabase.from('transaction_items').insert(items);
                if (itErr) throw itErr;

                // Inventory Update
                for (let item of cart) {
                    const p = allProducts.find(x => x.id === item.id);
                    if (p && p.stock !== undefined) {
                        const newStock = (p.stock || 0) - item.qty;
                        await supabase.from('products').update({ stock: newStock }).eq('id', item.id);
                    }
                }

                if (shouldPrint) prepareAndPrint(transaction);
                else {
                    alert('Sale Completed Successfully! Voucher: ' + voucher);
                    location.reload();
                }
            } catch (e) { alert('Process Failed: ' + e.message); }
        }

        function prepareAndPrint(t) {
            document.getElementById('receiptVoucherNo').textContent = 'Voucher: ' + document.getElementById('voucherNo').textContent;
            document.getElementById('receiptDate').textContent = document.getElementById('posDate').textContent;

            const rItems = document.getElementById('receiptItems');
            rItems.innerHTML = cart.map(item => `
                <tr>
                    <td>${item.name.substring(0, 15)}</td>
                    <td style="text-align:right;">${item.qty}</td>
                    <td style="text-align:right;">${((item.qty * item.price) - item.discount).toLocaleString()}</td>
                </tr>
            `).join('');

            document.getElementById('receiptTotal').textContent = document.getElementById('footerTotal').textContent;
            document.getElementById('receiptPaid').textContent = document.getElementById('payAmountInput').value;
            document.getElementById('receiptChange').textContent = document.getElementById('refundAmount').textContent;

            setTimeout(() => {
                window.print();
                location.reload();
            }, 500);
        }

        function holdSale() {
            if (cart.length === 0) return;
            const holdId = 'HOLD_' + Date.now();
            localStorage.setItem(holdId, JSON.stringify({ cart, cashier: 'Cashier 1', date: new Date() }));
            alert('Sale put on hold: ' + holdId);
            location.reload();
        }

        function showSaleList() {
            if (window.parent && typeof window.parent.switchView === 'function') {
                window.parent.switchView('sales');
            } else {
                alert('Sale list view requested.');
            }
        }

        window.onload = init;
    </script>
</body>

</html>